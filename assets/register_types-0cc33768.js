import{serializable as S,RGBAColor as Pr,Renderer as ut,Mathf as Z,Behaviour as R,Animator as ko,getParam as xt,AnimationCurve as Rr,getTempVector as be,Gizmos as dt,delayForFrames as Bo,OrbitControls as qo,TypeStore as V,RectTransform as au,GameObject as te,Text as Ws,NeedleXRSession as Ir,Camera as cu,serializeable as ae,WebXR as lu,setWorldPosition as dn,Rigidbody as Pt,AudioSource as Gs,InstantiateOptions as du,InstancingUtil as uu,Button as Dr,ActionBuilder as Ht,USDObject as an,BehaviorModel as Fr,TriggerBuilder as zr,LODGroup as hu,Volume as pu,getWorldPosition as bo,ParticleSystem as Yo,setParamWithoutReload as mu,EventList as Te,setWorldQuaternion as ji,getWorldQuaternion as $i,WebXRImageTracking as fu,syncField as Hs,showBalloonMessage as ce,RoomEvents as Ko,delay as Ls,Animation as _n,USDZExporter as jr,isDevEnvironment as Ps,SceneSwitcher as gu,Collider as Sn,LogType as $r,WaitForSeconds as xu,ClearFlags as yu,logHierarchy as Ui,getTempQuaternion as Ur,AssetReference as Nu,NeedleXRController as Wi,XRControllerFollow as vu,MeshRenderer as wu,ParticleSystemShapeType as no,isDestroyed as Wr,instantiate as Tu,isMobileDevice as oo,isiOS as io,isMozillaXR as Gi,isSafari as Hi,isQuest as ki,isDesktop as bu,FileReference as Zo,findObjectOfType as _u,ImageReference as Su}from"./needle-engine-fcca04b8.js";import{M as Gr,V as oe,Q as os,O as St,B as Hr,I as kr,a as _o,b as is,c as Br,d as J,F as un,R as ro,C as Je,A as Cu,e as Mu,f as it,U as Bi,T as Ou,P as qr,g as Yr,h as ks,i as hs,S as Kr,j as Eu,k as Zr,E as Qr,l as Xr,L as Cn,m as Au,o as Vu,D as Jr,p as Lu,q as Pu,r as Ru,W as ea,s as Qo,N as qi,t as Iu,u as ta,v as Du,w as sa,x as Fu,y as zu,z as ju,G as $u,H as Uu,J as Wu,K as Rt,X as Gu,Y as Hu,Z as ku,_ as Yi,$ as Bu,a0 as So,a1 as qu,a2 as Yu,a3 as Ku,a4 as Zu,a5 as Qu,a6 as Xu,a7 as Ju,a8 as Ki,a9 as eh,aa as th,ab as na,ac as sh,ad as nh,ae as oa,af as oh,ag as ia,ah as ih,ai as rh,aj as ah,ak as ch,al as ra,am as lh,an as dh,ao as uh,ap as hh,aq as es,ar as ph,as as mh,at as fh,au as gh}from"./index-988c870e.js";import"./index-ed000f79.js";var xh=Object.defineProperty,yh=Object.getOwnPropertyDescriptor,yt=(o,e,t,s)=>{for(var n=s>1?void 0:s?yh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&xh(e,t,n),n};class $e{constructor(){this.name="",this.metalness=0,this.roughness=1,this.clearCoat=0,this.clearcoatRoughness=0,this.normalStrength=0}copy(e){this.name=e.name,this.color=e.color.clone(),this.metalness=e.metalness,this.roughness=e.roughness,this.clearCoat=e.clearCoat,this.clearcoatRoughness=e.clearcoatRoughness,this.normalStrength=e.normalStrength}static transition(e,t,s,n){return e.color=t.color.lerp(s.color,n),e.metalness=Z.lerp(t.metalness,s.metalness,n),e.roughness=Z.lerp(t.roughness,s.roughness,n),e.clearCoat=Z.lerp(t.clearCoat,s.clearCoat,n),e.clearcoatRoughness=Z.lerp(t.clearcoatRoughness,s.clearcoatRoughness,n),e.normalStrength=Z.lerp(t.normalStrength,s.normalStrength,n),e}}yt([S()],$e.prototype,"name",2);yt([S(Pr)],$e.prototype,"color",2);yt([S()],$e.prototype,"metalness",2);yt([S()],$e.prototype,"roughness",2);yt([S()],$e.prototype,"clearCoat",2);yt([S()],$e.prototype,"clearcoatRoughness",2);yt([S()],$e.prototype,"normalStrength",2);class ps extends R{constructor(){super(...arguments),this.paints=[],this.renderes=[],this.fadeTime=.3,this.fadeStartStamp=-9999,this.lastIndex=-1,this.transitionTo=new $e,this.transitionFrom=new $e,this.transitionState=new $e,this.isTransitioning=!1,this.previousCycleIndex=0}update(){this.fadePaintJobs()}setPaintjob(e,t=!0){const s=this.paints[e];s&&(t&&this.lastIndex!=-1?(this.transitionFrom.copy(this.isTransitioning?this.transitionState:this.paints[this.lastIndex]),this.transitionTo.copy(s),this.fadeStartStamp=this.context.time.time,this.isTransitioning=!0):this.renderes.forEach(n=>this.applyDataToRenderer(s,n)),this.lastIndex=e)}applyDataToRenderer(e,t){let s=t.sharedMaterial;s.isCloned===void 0&&(s=s.clone(),s.isCloned=!0,t.sharedMaterial=s),s instanceof Gr&&(e.color&&s.color.copy(e.color),s.metalness=e.metalness,s.roughness=e.roughness,s.clearcoatRoughness=e.clearcoatRoughness,s.clearcoat=e.clearCoat,s.normalScale.set(e.normalStrength,e.normalStrength),s.needsUpdate=!0)}get transitionTime(){return Z.clamp01((this.context.time.time-this.fadeStartStamp)/this.fadeTime)}fadePaintJobs(){this.isTransitioning&&(this.transitionState=$e.transition(this.transitionState,this.transitionFrom,this.transitionTo,this.transitionTime),this.renderes.forEach(e=>this.applyDataToRenderer(this.transitionState,e)),this.transitionTime>=1&&(this.isTransitioning=!1))}cyclePaintjob(){this.previousCycleIndex++,this.previousCycleIndex%=this.paints.length,this.setPaintjob(this.previousCycleIndex)}}yt([S($e)],ps.prototype,"paints",2);yt([S(ut)],ps.prototype,"renderes",2);yt([S()],ps.prototype,"fadeTime",2);var Nh=Object.defineProperty,vh=Object.getOwnPropertyDescriptor,Xo=(o,e,t,s)=>{for(var n=s>1?void 0:s?vh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Nh(e,t,n),n};class Mn extends R{constructor(){super(...arguments),this.stateName="open",this.toggleOnClick=!0,this.state=!1}update(){this.context.input.isKeyDown("d")&&this.toggle()}toggle(){var e;this.state=!this.state,(e=this.animator)==null||e.setBool(this.stateName,this.state)}}Xo([S(ko)],Mn.prototype,"animator",2);Xo([S()],Mn.prototype,"stateName",2);Xo([S()],Mn.prototype,"toggleOnClick",2);var wh=Object.defineProperty,Th=Object.getOwnPropertyDescriptor,Ft=(o,e,t,s)=>{for(var n=s>1?void 0:s?Th(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&wh(e,t,n),n};const bh=xt("debuglensflare");class Ct extends R{constructor(){super(...arguments),this.fadeDistance=2,this.fadeTime=0,this.dotVisiblityThreshold=.25,this.scaleWithDistance=!0,this.zOffset=.1,this.scaleClamp=new oe(0,9999),this.localRotOnStart=new os,this.fadeStartStamp=-9999,this.isTransitioning=!1}awake(){this.renderer&&(this.renderer.sharedMaterial=this.renderer.sharedMaterial.clone()),this.localRotOnStart.copy(this.gameObject.quaternion)}onEnable(){}onBeforeRender(){var w;if(!this.renderer||!this.gameObject.parent)return;const e=this.context.mainCameraComponent,t=e.worldPosition,s=this.worldPosition,n=t.distanceTo(s),i=be(t).sub(s).normalize();this.transparency??(this.transparency=this.renderer.sharedMaterial.opacity);const r=this.gameObject.parent.localToWorld(be(0,0,1).applyQuaternion(this.localRotOnStart)),a=e.forward.dot(r.negate()),c=n<this.fadeDistance&&n>this.zOffset,l=!0,d=a>this.dotVisiblityThreshold,u=c&&l&&d;this.wasVisible!==u&&(this.wasVisible===void 0?this.renderer.sharedMaterial.opacity=u?this.transparency:0:(this.isTransitioning=!0,this.fadeStartStamp=this.context.time.time),this.wasVisible===!1&&u===!0&&(this.renderer.gameObject.visible=!0),this.wasVisible=u);let m=u?this.transparency:0;if(this.isTransitioning){const T=Z.clamp01((this.context.time.time-this.fadeStartStamp)/this.fadeTime);this.renderer.sharedMaterial.opacity=m,m=(u?T:1-T)*this.transparency,T>=1&&(this.isTransitioning=!1,this.renderer.gameObject.visible=u)}if(this.renderer.gameObject.visible){const T=Z.clamp01(n/this.fadeDistance),N=((w=this.transparencyWithDistance)==null?void 0:w.evaluate(T))??1;if(this.renderer.sharedMaterial.opacity=m*N,this.scaleWithDistance){let F=n*.1;F=Z.clamp(F,this.scaleClamp.x,this.scaleClamp.y),this.gameObject.scale.set(F,F,F)}const v=Math.min(this.gameObject.scale.x,this.gameObject.scale.y,this.gameObject.scale.z),O=this.renderer.gameObject;O.position.set(0,0,0);const P=O.worldPosition,L=this.zOffset*v;if(P.addScaledVector(i,L),O.worldPosition=P,bh){dt.DrawSphere(this.worldPosition,.03,16711680,0,!0),dt.DrawWireSphere(this.worldPosition,this.fadeDistance,16711680,0,!0);const F=this.worldPosition.addScaledVector(i,L);dt.DrawLabel(F,`S:${v.toFixed(2)}`,.05,0,16777215,0)}}}detectObstruction(e,t){const s=this.context.physics.engine,n=e.distanceTo(t),i=be(e).sub(t).normalize(),r=s.raycast(e,i,{maxDistance:n});return console.log(r==null?void 0:r.collider.gameObject.name),(r==null?void 0:r.collider)!==void 0}}Ft([S(ut)],Ct.prototype,"renderer",2);Ft([S()],Ct.prototype,"fadeDistance",2);Ft([S()],Ct.prototype,"fadeTime",2);Ft([S()],Ct.prototype,"dotVisiblityThreshold",2);Ft([S()],Ct.prototype,"scaleWithDistance",2);Ft([S()],Ct.prototype,"zOffset",2);Ft([S(oe)],Ct.prototype,"scaleClamp",2);Ft([S(Rr)],Ct.prototype,"transparencyWithDistance",2);var _h=Object.defineProperty,Sh=Object.getOwnPropertyDescriptor,Bs=(o,e,t,s)=>{for(var n=s>1?void 0:s?Sh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&_h(e,t,n),n};class ms extends R{constructor(){super(...arguments),this.fitOffset=1.1,this.yOffSet=1,this.infiniteAutoRotate=!0}onenable(){}async focusCar(){var t;await Bo(2);const e=this.context.mainCameraComponent;this.orbitControls=e==null?void 0:e.gameObject.getComponent(qo),!(!this.orbitControls||!this.car||!this.referenceCube)&&(this.orbitControls.minZoom,this.orbitControls.maxZoom,this.referenceCube.visible=!0,this.orbitControls.fitCamera([this.referenceCube],{fitOffset:this.fitOffset,centerCamera:"y",immediate:!0}),this.referenceCube.visible=!1,(t=this.orbitControls.controls)==null||t.target.add(be(0,this.yOffSet,0)),console.log("focusCar"))}update(){this.infiniteAutoRotate&&this.orbitControls&&(this.orbitControls.autoRotate=!0),this.context.input.isKeyDown("f")&&this.focusCar()}}Bs([S(ps)],ms.prototype,"car",2);Bs([S(St)],ms.prototype,"referenceCube",2);Bs([S()],ms.prototype,"fitOffset",2);Bs([S()],ms.prototype,"yOffSet",2);Bs([S()],ms.prototype,"infiniteAutoRotate",2);class Rs extends is{constructor(){super(Rs.Geometry,new Br({opacity:0,transparent:!0})),this.isLensflare=!0,this.type="Lensflare",this.frustumCulled=!1,this.renderOrder=1/0;const e=new J,t=new J,s=new un(16,16),n=new un(16,16);let i=Bi;const r=Rs.Geometry,a=new ro({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:`

				precision highp float;

				uniform vec3 screenPosition;
				uniform vec2 scale;

				attribute vec3 position;

				void main() {

					gl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );

				}`,fragmentShader:`

				precision highp float;

				void main() {

					gl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );

				}`,depthTest:!0,depthWrite:!1,transparent:!1}),c=new ro({uniforms:{map:{value:s},scale:{value:null},screenPosition:{value:null}},vertexShader:`

				precision highp float;

				uniform vec3 screenPosition;
				uniform vec2 scale;

				attribute vec3 position;
				attribute vec2 uv;

				varying vec2 vUV;

				void main() {

					vUV = uv;

					gl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );

				}`,fragmentShader:`

				precision highp float;

				uniform sampler2D map;

				varying vec2 vUV;

				void main() {

					gl_FragColor = texture2D( map, vUV );

				}`,depthTest:!1,depthWrite:!1,transparent:!1}),l=new is(r,a),d=[],u=Jo.Shader,m=new ro({name:u.name,uniforms:{map:{value:null},occlusionMap:{value:n},color:{value:new Je(16777215)},scale:{value:new oe},screenPosition:{value:new J}},vertexShader:u.vertexShader,fragmentShader:u.fragmentShader,blending:Cu,transparent:!0,depthWrite:!1}),w=new is(r,m);this.addElement=function(P){d.push(P)};const T=new oe,N=new oe,v=new Mu,O=new it;this.onBeforeRender=function(P,L,F){P.getCurrentViewport(O);const Q=P.getRenderTarget(),W=Q!==null?Q.texture.type:Bi;i!==W&&(s.dispose(),n.dispose(),s.type=n.type=W,i=W);const k=O.w/O.z,K=O.z/2,Nt=O.w/2;let at=16/O.w;if(T.set(at*k,at),v.min.set(O.x,O.y),v.max.set(O.x+(O.z-16),O.y+(O.w-16)),t.setFromMatrixPosition(this.matrixWorld),t.applyMatrix4(F.matrixWorldInverse),!(t.z>0)&&(e.copy(t).applyMatrix4(F.projectionMatrix),N.x=O.x+e.x*K+K-8,N.y=O.y+e.y*Nt+Nt-8,v.containsPoint(N))){P.copyFramebufferToTexture(N,s);let Ut=a.uniforms;Ut.scale.value=T,Ut.screenPosition.value=e,P.renderBufferDirect(F,null,r,a,l,null),P.copyFramebufferToTexture(N,n),Ut=c.uniforms,Ut.scale.value=T,Ut.screenPosition.value=e,P.renderBufferDirect(F,null,r,c,l,null);const nu=-e.x*2,ou=-e.y*2;for(let so=0,iu=d.length;so<iu;so++){const bs=d[so],_s=m.uniforms;_s.color.value.copy(bs.color),_s.map.value=bs.texture,_s.screenPosition.value.x=e.x+nu*bs.distance,_s.screenPosition.value.y=e.y+ou*bs.distance,at=bs.size/O.w;const ru=O.w/O.z;_s.scale.value.set(at*ru,at),m.uniformsNeedUpdate=!0,P.renderBufferDirect(F,null,r,m,w,null)}}},this.dispose=function(){a.dispose(),c.dispose(),m.dispose(),s.dispose(),n.dispose();for(let P=0,L=d.length;P<L;P++)d[P].texture.dispose()}}}class Jo{constructor(e,t=1,s=0,n=new Je(16777215)){this.texture=e,this.size=t,this.distance=s,this.color=n}}Jo.Shader={name:"LensflareElementShader",uniforms:{map:{value:null},occlusionMap:{value:null},color:{value:null},scale:{value:null},screenPosition:{value:null}},vertexShader:`

		precision highp float;

		uniform vec3 screenPosition;
		uniform vec2 scale;

		uniform sampler2D occlusionMap;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUV;
		varying float vVisibility;

		void main() {

			vUV = uv;

			vec2 pos = position.xy;

			vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );

			vVisibility =        visibility.r / 9.0;
			vVisibility *= 1.0 - visibility.g / 9.0;
			vVisibility *=       visibility.b / 9.0;

			gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );

		}`,fragmentShader:`

		precision highp float;

		uniform sampler2D map;
		uniform vec3 color;

		varying vec2 vUV;
		varying float vVisibility;

		void main() {

			vec4 texture = texture2D( map, vUV );
			texture.a *= vVisibility;
			gl_FragColor = texture;
			gl_FragColor.rgb *= color;

		}`};Rs.Geometry=function(){const o=new Hr,e=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),t=new kr(e,5);return o.setIndex([0,1,2,0,2,3]),o.setAttribute("position",new _o(t,3,0,!1)),o.setAttribute("uv",new _o(t,2,3,!1)),o}();var Ch=Object.defineProperty,Mh=Object.getOwnPropertyDescriptor,On=(o,e,t,s)=>{for(var n=s>1?void 0:s?Mh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Ch(e,t,n),n};class qs extends R{constructor(){super(...arguments),this.size=10,this.distance=0}awake(){if(!this.texture)return;const e=new Rs;e.addElement(new Jo(this.texture,this.size,this.distance,this.color)),this.gameObject.add(e)}}On([S(Ou)],qs.prototype,"texture",2);On([S()],qs.prototype,"size",2);On([S()],qs.prototype,"distance",2);On([S(Je)],qs.prototype,"color",2);var Oh=Object.defineProperty,Eh=Object.getOwnPropertyDescriptor,Ah=(o,e,t,s)=>{for(var n=s>1?void 0:s?Eh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Oh(e,t,n),n};class Vh extends $e{get cssColor(){return`rgb(${this.color.r*255}, ${this.color.g*255}, ${this.color.b*255})`}select(){this.element.style.filter=`drop-shadow(0 0 0.4rem ${this.cssColor})`}deselect(){this.element.style.filter=""}}class aa extends R{constructor(){super(...arguments),this.paintJobs=[],this.mainHTML_css=`
        #main {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
        }

        /* #paintjobs-name {
            position: absolute;
            top: 1rem;
            display: block;
            width: 100%;
            text-align: center;
            font-size: 24px;
            color: red;
        } */

        #paintjobs {
            width: 100%;
            height: 8rem;
            background-color: rgba(255, 255, 255, 0.03);
            gap: 2rem;
            padding-top: 1.5rem;
            padding-bottom: 1.5rem;

            display: flex;
            align-content: center;
            align-items: center;
            justify-content: center;
            flex-direction: row;

            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);

            outline: rgba(0, 0, 0, 0.25) 2px solid;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.2));
        }

        @media screen and (max-width: 800px) {
            #paintjobs {
                height: 3rem;
                gap: 0.25rem;
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
        }
    `,this.paintJobCSS=`
        .paintjob {
            height: inherit;
            aspect-ratio: 1/1;
            /* border-radius: 50%; */
        }
        .paintjob__color {
            position: absolute;
            height: inherit;
            aspect-ratio: 1/1;
            
            /* background-size: contain;
            background-blend-mode: multiply;
            background-image: url(assets/img/paintjob_color.png); */
            border-radius: 50%;
        }
        .paintjob__gloss {
            position: absolute;
            height: inherit;
            aspect-ratio: 1/1;
            background-size: contain;
            background-image: url(include/img/paintjob_gloss.png);
        }
    `}awake(){this.car&&(this.paintJobs=this.wrapPaintJobData(this.car.paints),this.addStyle(),this.createMainHTML(),this.car.setPaintjob(0),this.paintJobs.forEach(e=>this.createPaintJobElement(e)))}wrapPaintJobData(e){return e.map((t,s)=>{const n=new Vh;return n.index=s,Object.assign(n,t),n})}createMainHTML(){const e=document.createElement("div");e.id="main",this.element_paintJob_listRoot=document.createElement("div"),this.element_paintJob_listRoot.id="paintjobs",e.appendChild(this.element_paintJob_listRoot),document.body.appendChild(e)}createPaintJobElement(e){const t=document.createElement("div");t.classList.add("paintjob"),t.addEventListener("click",()=>{var i;this.car.setPaintjob(e.index),(i=this.previouslySelectedPaintJob)==null||i.deselect(),e.select(),this.previouslySelectedPaintJob=e});const s=document.createElement("div");s.classList.add("paintjob__color"),s.style.backgroundColor=e.cssColor;const n=document.createElement("div");n.classList.add("paintjob__gloss"),e.element=t,t.appendChild(s),t.appendChild(n),this.element_paintJob_listRoot.appendChild(t)}addStyle(){const e=[this.mainHTML_css,this.paintJobCSS],t=document.createElement("style");t.innerHTML=e.join(`
`),document.body.appendChild(t)}setPanelVisibility(e){this.element_paintJob_listRoot&&(this.element_paintJob_listRoot.style.display=e?"flex":"none")}}Ah([S(ps)],aa.prototype,"car",2);V.add("PaintJobData",$e);V.add("Car",ps);V.add("DoorController",Mn);V.add("LensFlare",Ct);V.add("SceneCamera",ms);V.add("ThreeFlare",qs);V.add("ConfiguratorUI",aa);var Lh=Object.defineProperty,Ph=Object.getOwnPropertyDescriptor,ca=(o,e,t,s)=>{for(var n=s>1?void 0:s?Ph(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Lh(e,t,n),n};class ei extends R{constructor(){super(...arguments),this.safeArea=new oe(0,0)}update(){var n,i,r;const e=this.context.domWidth/this.safeArea.x,t=this.context.domHeight/this.safeArea.y,s=Z.clamp(Math.min(e,t),0,1);(n=this.rectTransform)==null||n.scale.setScalar(s),(r=(i=this.rectTransform)==null?void 0:i.shadowComponent)==null||r.scale.setScalar(s)}}ca([S(au)],ei.prototype,"rectTransform",2);ca([S(oe)],ei.prototype,"safeArea",2);var Rh=Object.defineProperty,Ih=Object.getOwnPropertyDescriptor,ti=(o,e,t,s)=>{for(var n=s>1?void 0:s?Ih(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Rh(e,t,n),n};class En extends R{constructor(){super(...arguments),this.createMenuButton=!1,this.teleportVRPlayer=!1,this.ignoreYInVR=!1,this.menuButton=null}get orbitalCamera(){return this._orbitalCamera??(this._orbitalCamera=te.findObjectOfType(qo)),this._orbitalCamera}awake(){this.createMenuButton&&this.addButton()}addButton(){var s;this.menuButton&&this.removeButton();const e=((s=this.gameObject.getComponentInChildren(Ws))==null?void 0:s.text)??this.gameObject.name,t=document.createElement("button");this.menuButton=t,t.innerText=e.replace("_"," "),t.setAttribute("priority","40"),t.addEventListener("click",()=>this.use()),this.context.menu.appendChild(t)}removeButton(){this.menuButton&&(this.menuButton.remove(),this.menuButton=null)}use(){var t,s;(t=this.orbitalCamera)==null||t.setCameraTargetPosition(this.worldPosition);const e=(s=Ir.active)==null?void 0:s.rig;if(this.teleportVRPlayer&&this.context.isInVR&&e){const n=be(this.worldPosition);this.ignoreYInVR&&(n.y=e.gameObject.worldPosition.y),e.gameObject.worldPosition=n}}}ti([S()],En.prototype,"createMenuButton",2);ti([S()],En.prototype,"teleportVRPlayer",2);ti([S()],En.prototype,"ignoreYInVR",2);class Dh extends R{constructor(){super(...arguments),this.cam=null}onEnable(){this.cam=this.gameObject.getComponent(cu),this.cam||(console.warn("CameraLayer requires a Camera component"),this.enabled=!1)}onAfterRender(){if(!this.cam)return;const e=this.scene.background;this.context.renderer.autoClearColor=!1,this.cam.cam instanceof qr&&this.context.updateAspect(this.cam.cam),this.scene.background=null,this.context.renderer.render(this.scene,this.cam.cam),this.scene.background=e}}var Fh=Object.defineProperty,zh=Object.getOwnPropertyDescriptor,An=(o,e,t,s)=>{for(var n=s>1?void 0:s?zh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Fh(e,t,n),n};class Ys extends R{constructor(){super(...arguments),this.strength=10,this.maxInstances=10,this._instances=[],this._index=-1,this._onPointerDown=e=>{e.button===0&&this.throwBall(e.space.worldPosition,e.space.worldForward)}}start(){this.prefab&&te.setActive(this.prefab,!1),this.webXR??(this.webXR=te.findObjectOfType(lu))}onEnable(){this.context.input.addEventListener("pointerdown",this._onPointerDown)}onDisable(){this.context.input.removeEventListener("pointerdown",this._onPointerDown)}throwBall(e,t){var r,a;if(!this.prefab)return;if(this._instances.length<this.maxInstances){const c=new du;c.position=e;const l=te.instantiate(this.prefab,c);if(!l)return;this._instances.push(l)}const s=++this._index,n=this._instances[s%this._instances.length];if(!n)return;dn(n,e),te.setActive(n,!0),(r=this.audioSource)==null||r.stop(),(a=this.audioSource)==null||a.play();const i=te.getComponent(n,Pt);i&&(t.multiplyScalar(this.strength),i.resetForcesAndTorques(),i.resetVelocities(),i==null||i.applyImpulse(t))}}An([ae(St)],Ys.prototype,"prefab",2);An([ae(Gs)],Ys.prototype,"audioSource",2);An([ae()],Ys.prototype,"strength",2);An([ae()],Ys.prototype,"maxInstances",2);var jh=Object.defineProperty,$h=Object.getOwnPropertyDescriptor,la=(o,e,t,s)=>{for(var n=s>1?void 0:s?$h(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&jh(e,t,n),n};class si extends R{constructor(){super(...arguments),this.applyOnStart=!0,this.randomMetallicRoughness=!0}start(){{const e=this.gameObject.getComponent(ut);if(!e)return;for(let t=0;t<e.sharedMaterials.length;t++)e.sharedMaterials[t]=e.sharedMaterials[t].clone()}this.applyOnStart&&this.applyRandomColor()}applyRandomColor(){const e=this.gameObject.getComponent(ut);if(!e){console.warn("Can not change color: No renderer on "+this.name);return}for(let t=0;t<e.sharedMaterials.length;t++){const s=e.sharedMaterials[t];s.color=new Je(Math.random(),Math.random(),Math.random()),this.randomMetallicRoughness&&s instanceof Yr&&(s.metalness=Math.random(),s.roughness=Math.random()*Math.random()),s.needsUpdate=!0,uu.markDirty(this.gameObject)}}}la([ae()],si.prototype,"applyOnStart",2);la([ae()],si.prototype,"randomMetallicRoughness",2);class Uh extends R{constructor(){super(...arguments),this.renderer=null,this.collisionCount=0}start(){if(this.renderer=this.gameObject.getComponent(ut),!!this.renderer){this._startColor||(this._startColor=[]);for(let e=0;e<this.renderer.sharedMaterials.length;e++)this.renderer.sharedMaterials[e]=this.renderer.sharedMaterials[e].clone(),this._startColor[e]=this.renderer.sharedMaterials[e].color.clone()}}onCollisionEnter(e){if(this.renderer){this.collisionCount+=1;for(let t=0;t<this.renderer.sharedMaterials.length;t++)this.renderer.sharedMaterials[t].color.setRGB(Math.random(),Math.random(),Math.random())}}onCollisionExit(e){if(!(!this.renderer||!this._startColor)&&(this.collisionCount-=1,this.collisionCount===0))for(let t=0;t<this.renderer.sharedMaterials.length;t++)this.renderer.sharedMaterials[t].color.copy(this._startColor[t])}}var Wh=Object.defineProperty,Gh=Object.getOwnPropertyDescriptor,Hh=(o,e,t,s)=>{for(var n=s>1?void 0:s?Gh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Wh(e,t,n),n};class da extends R{update(){this.myMaterial&&(this.myMaterial._Speed*=1+this.context.time.deltaTime,this.myMaterial._Speed>1&&(this.myMaterial._Speed=5e-4),this.context.time.frame%30===0&&console.log(this.myMaterial._Speed))}}Hh([S(ks)],da.prototype,"myMaterial",2);var kh=Object.defineProperty,Bh=Object.getOwnPropertyDescriptor,qh=(o,e,t,s)=>{for(var n=s>1?void 0:s?Bh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&kh(e,t,n),n};class ua extends R{click(){var e,t;(t=(e=this.buttonToClick)==null?void 0:e.onClick)==null||t.invoke()}}qh([S(Dr)],ua.prototype,"buttonToClick",2);var Yh=Object.defineProperty,Kh=Object.getOwnPropertyDescriptor,Zh=(o,e,t,s)=>{for(var n=s>1?void 0:s?Kh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Yh(e,t,n),n};class ha extends R{constructor(){super(...arguments),this.objectToMatrix=new Map}start(){var e;(e=this.target)==null||e.traverse(t=>{this.objectToMatrix.set(t,t.matrix.clone())})}onPointerClick(e){for(const[t,s]of this.objectToMatrix)t.matrix.copy(s),t.matrix.decompose(t.position,t.quaternion,t.scale),t.matrixWorldNeedsUpdate=!0}createBehaviours(e,t,s){if(t.uuid!==this.gameObject.uuid||!this.target)return;const n=Ht.parallel();for(const[c,l]of this.objectToMatrix){const d=an.createEmpty();d.matrix=l,c.parent&&d.matrix.premultiply(c.parent.matrixWorld),s.document.add(d),n.addAction(Ht.transformAction(c,d,0,"absolute","none"))}const i=new Fr("click_to_reset",zr.tapTrigger(this.gameObject),n);e.addBehavior(i);const r=an.createEmpty();r.name="InputTarget",r.displayName=void 0,r.type="RealityKitComponent",r.onSerialize=c=>{c.appendLine("bool allowsDirectInput = 1"),c.appendLine("bool allowsIndirectInput = 1"),c.appendLine('uniform token info:id = "RealityKit.InputTarget"')},t.add(r);const a=an.createEmpty();a.name="HoverEffect",a.displayName=void 0,a.type="RealityKitComponent",a.onSerialize=c=>{c.appendLine('uniform token info:id = "RealityKit.HoverEffect"')},t.add(a)}}Zh([S(te)],ha.prototype,"target",2);var Qh=Object.defineProperty,Xh=Object.getOwnPropertyDescriptor,pa=(o,e,t,s)=>{for(var n=s>1?void 0:s?Xh(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Qh(e,t,n),n};class ni extends R{constructor(){super(...arguments),this.tempVec1=new J,this.tempVec2=new J}update(){if(!this.lodGroup||!this.text)return;const e=this.context.mainCamera;e.getWorldPosition(this.tempVec1),this.gameObject.getWorldPosition(this.tempVec2);const t=this.tempVec1.distanceTo(this.tempVec2)/e.zoom,s=this.lodGroup._lodsHandler;let n=null;s==null||s.forEach(i=>{var l,d;const r=i.levels[i.getCurrentLevel()],a=i.levels.at(i.getCurrentLevel()+1);let c=null;if(r.object instanceof is){const u=r.object.geometry.attributes,m=Math.floor(((l=u.position)==null?void 0:l.count)||0);c=`Triangles: ${Math.floor((((d=u.index)==null?void 0:d.count)||m)/3)}, Vertices: ${m}`}r.object.name.replace(/_/g,""),r.object.name.includes("Cull")||(n="",c&&(n+=`${c}
`),a==null||a.hysteresis,n+=`${r.distance.toFixed(1)} / ${t.toFixed(1)}`,a&&(n+=` / ${(a.distance-a.distance*a.hysteresis).toFixed(1)}`))}),n||(n="culled"),this.text.text=n}}pa([S(hu)],ni.prototype,"lodGroup",2);pa([S(Ws)],ni.prototype,"text",2);var Jh=Object.defineProperty,ep=Object.getOwnPropertyDescriptor,oi=(o,e,t,s)=>{for(var n=s>1?void 0:s?ep(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Jh(e,t,n),n};class Vn extends R{constructor(){super(...arguments),this.apertureMultiplier=2,this.focalLength=.001,this.focusDistanceCutoff=25,this.volume=null,this.dofEffect=void 0}onEnable(){var e,t,s;this.volume=te.findObjectOfType(pu),this.dofEffect=(s=(t=(e=this.volume)==null?void 0:e.sharedProfile)==null?void 0:t.components)==null?void 0:s.find(n=>n.typeName==="DepthOfField"),this.orbit=te.findObjectOfType(qo)}onBeforeRender(){var t;if(!((t=this.orbit)!=null&&t.controls))return;const e=this.orbit.controls.target.distanceTo(bo(this.orbit.gameObject));if(this.dofEffect){this.dofEffect.focusDistance.value=e,this.dofEffect.focalLength.value=this.focalLength;let s=Z.inverseLerp(0,this.focusDistanceCutoff,e);s=Z.clamp01(s),this.dofEffect.aperture.value=Z.lerp(this.apertureMultiplier,32,s);const n=this.focusDistanceCutoff;e>n&&this.dofEffect.active?this.dofEffect.active=!1:e<n&&!this.dofEffect.active&&(this.dofEffect.active=!0)}}}oi([S()],Vn.prototype,"apertureMultiplier",2);oi([S()],Vn.prototype,"focalLength",2);oi([S()],Vn.prototype,"focusDistanceCutoff",2);class tp extends R{constructor(){super(...arguments),this._previousEnvironmentTexture=null}onEnable(){this._previousEnvironmentTexture=this.context.scene.environment,this.context.scene.environment=null}onDisable(){this.context.scene.environment=this._previousEnvironmentTexture}}var sp=Object.defineProperty,np=Object.getOwnPropertyDescriptor,op=(o,e,t,s)=>{for(var n=s>1?void 0:s?np(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&sp(e,t,n),n};const ip=xt("sample_debugParticlesOnClick");class ma extends R{constructor(){super(...arguments),this.particleSystems=[]}update(){if(!this.context.isInVR&&this.context.input.getPointerClicked(0)){const e=this.context.physics.raycast();e.length>0&&this.spawnParticlesAt(e[0].point)}}onUpdateXR(e){e.xr.controllers.forEach(t=>{var s,n;if(((s=t.getButton("primary"))==null?void 0:s.isDown)===!0){const i=(n=this.context.physics.raycastFromRay(t.ray))==null?void 0:n.at(0);i&&this.spawnParticlesAt(i.point)}})}spawnParticlesAt(e){dn(this.gameObject,e),ip&&dt.DrawWireSphere(e,.5,16711680,1);for(const t of this.particleSystems)t&&(te.setActive(t.gameObject,!0),t.play())}}op([ae(Yo)],ma.prototype,"particleSystems",2);var rp=Object.defineProperty,ap=Object.getOwnPropertyDescriptor,cp=(o,e,t,s)=>{for(var n=s>1?void 0:s?ap(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&rp(e,t,n),n};class fa extends R{constructor(){super(...arguments),this.parameters=[]}awake(){var e=!1;this.parameters.forEach(t=>{xt(t)||(mu(t,""),e=!0)}),e&&window.location.reload()}}cp([S()],fa.prototype,"parameters",2);var lp=Object.defineProperty,dp=Object.getOwnPropertyDescriptor,ga=(o,e,t,s)=>{for(var n=s>1?void 0:s?dp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&lp(e,t,n),n};class ii extends R{constructor(){super(...arguments),this.htmlSelector="button.some-button",this.onClick=new Te,this.onClicked=()=>{this.onClick.invoke()}}onEnable(){this.element=document.querySelector(this.htmlSelector),this.element?this.element.addEventListener("click",this.onClicked):console.warn(`Could not find element with selector "${this.htmlSelector}"`)}onDisable(){this.element&&this.element.removeEventListener("click",this.onClicked)}}ga([ae()],ii.prototype,"htmlSelector",2);ga([S(Te)],ii.prototype,"onClick",2);var up=Object.defineProperty,hp=Object.getOwnPropertyDescriptor,xa=(o,e,t,s)=>{for(var n=s>1?void 0:s?hp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&up(e,t,n),n};const ya=class extends R{onEnable(){var o;if(!(!this.methods||!this.names)){console.log("HTMLMenu.onEnable"),this.wrapper=document.createElement("ul"),this.wrapper.classList.add("needle-menu");for(let e=0;e<this.methods.length;e++){const t=this.methods[e];let s="Button";e<((o=this.names)==null?void 0:o.length)&&(s=this.names[e]);const n=document.createElement("li"),i=document.createElement("button");i.innerHTML=s,i.onclick=()=>{t.invoke()},n.appendChild(i),this.wrapper.appendChild(n)}this.styleElement=document.createElement("style"),this.styleElement.innerHTML=ya.style,document.head.appendChild(this.styleElement),this.context.domElement.appendChild(this.wrapper)}}onDisable(){this.wrapper&&(this.wrapper.remove(),this.wrapper=void 0),this.styleElement&&(this.styleElement.remove(),this.styleElement=void 0)}};let Ln=ya;Ln.style=`
        .needle-menu {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            list-style-type: none;
            margin: 0;
            overflow: hidden;
            background-color: white;
            display: flex;
            padding: 5px;
            border-radius: 20px;
        }

        .needle-menu li button {
            padding: 5px;
            margin: 0 5px;
            background: none;
            outline: none;
            border: 0;
            cursor: pointer;
        }

        .needle-menu li button:hover {
            font-weight: bold;
        }
    `;xa([S(Te)],Ln.prototype,"methods",2);xa([S()],Ln.prototype,"names",2);const Zi=new J,pp=new os,Qi=new J;class mp extends St{constructor(e=document.createElement("div")){super(),this.isCSS3DObject=!0,this.element=e,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable",!1),this.addEventListener("removed",function(){this.traverse(function(t){t.element instanceof Element&&t.element.parentNode!==null&&t.element.parentNode.removeChild(t.element)})})}copy(e,t){return super.copy(e,t),this.element=e.element.cloneNode(!0),this}}const ct=new hs,fp=new hs;class gp{constructor(e={}){const t=this;let s,n,i,r;const a={camera:{style:""},objects:new WeakMap},c=e.element!==void 0?e.element:document.createElement("div");c.style.overflow="hidden",this.domElement=c;const l=document.createElement("div");l.style.transformOrigin="0 0",l.style.pointerEvents="none",c.appendChild(l);const d=document.createElement("div");d.style.transformStyle="preserve-3d",l.appendChild(d),this.getSize=function(){return{width:s,height:n}},this.render=function(N,v){const O=v.projectionMatrix.elements[5]*r;v.view&&v.view.enabled?(l.style.transform=`translate( ${-v.view.offsetX*(s/v.view.width)}px, ${-v.view.offsetY*(n/v.view.height)}px )`,l.style.transform+=`scale( ${v.view.fullWidth/v.view.width}, ${v.view.fullHeight/v.view.height} )`):l.style.transform="",N.matrixWorldAutoUpdate===!0&&N.updateMatrixWorld(),v.parent===null&&v.matrixWorldAutoUpdate===!0&&v.updateMatrixWorld();let P,L;v.isOrthographicCamera&&(P=-(v.right+v.left)/2,L=(v.top+v.bottom)/2);const F=v.view&&v.view.enabled?v.view.height/v.view.fullHeight:1,Q=v.isOrthographicCamera?`scale( ${F} )scale(`+O+")translate("+u(P)+"px,"+u(L)+"px)"+m(v.matrixWorldInverse):`scale( ${F} )translateZ(`+O+"px)"+m(v.matrixWorldInverse),k=(v.isPerspectiveCamera?"perspective("+O+"px) ":"")+Q+"translate("+i+"px,"+r+"px)";a.camera.style!==k&&(d.style.transform=k,a.camera.style=k),T(N,N,v)},this.setSize=function(N,v){s=N,n=v,i=s/2,r=n/2,c.style.width=N+"px",c.style.height=v+"px",l.style.width=N+"px",l.style.height=v+"px",d.style.width=N+"px",d.style.height=v+"px"};function u(N){return Math.abs(N)<1e-10?0:N}function m(N){const v=N.elements;return"matrix3d("+u(v[0])+","+u(-v[1])+","+u(v[2])+","+u(v[3])+","+u(v[4])+","+u(-v[5])+","+u(v[6])+","+u(v[7])+","+u(v[8])+","+u(-v[9])+","+u(v[10])+","+u(v[11])+","+u(v[12])+","+u(-v[13])+","+u(v[14])+","+u(v[15])+")"}function w(N){const v=N.elements;return"translate(-50%,-50%)"+("matrix3d("+u(v[0])+","+u(v[1])+","+u(v[2])+","+u(v[3])+","+u(-v[4])+","+u(-v[5])+","+u(-v[6])+","+u(-v[7])+","+u(v[8])+","+u(v[9])+","+u(v[10])+","+u(v[11])+","+u(v[12])+","+u(v[13])+","+u(v[14])+","+u(v[15])+")")}function T(N,v,O,P){if(N.isCSS3DObject){const L=N.visible===!0&&N.layers.test(O.layers)===!0;if(N.element.style.display=L===!0?"":"none",L===!0){N.onBeforeRender(t,v,O);let F;N.isCSS3DSprite?(ct.copy(O.matrixWorldInverse),ct.transpose(),N.rotation2D!==0&&ct.multiply(fp.makeRotationZ(N.rotation2D)),N.matrixWorld.decompose(Zi,pp,Qi),ct.setPosition(Zi),ct.scale(Qi),ct.elements[3]=0,ct.elements[7]=0,ct.elements[11]=0,ct.elements[15]=1,F=w(ct)):F=w(N.matrixWorld);const Q=N.element,W=a.objects.get(N);if(W===void 0||W.style!==F){Q.style.transform=F;const k={style:F};a.objects.set(N,k)}Q.parentNode!==d&&d.appendChild(Q),N.onAfterRender(t,v,O)}}for(let L=0,F=N.children.length;L<F;L++)T(N.children[L],v,O)}}}var xp=Object.defineProperty,yp=Object.getOwnPropertyDescriptor,Pn=(o,e,t,s)=>{for(var n=s>1?void 0:s?yp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&xp(e,t,n),n};class Ks extends R{constructor(){super(...arguments),this.url="https://www.youtube.com/embed/puWNRrG4MCg",this.pixelsPerUnit=500,this.borderRadius=50,this.animator=null,this.rotate90=new os().setFromAxisAngle(new J(0,1,0),Math.PI)}start(){const e=xt("url");e&&(this.url=e);const t=document.createElement("div");t.innerHTML='<iframe width="1000" height="1000" title="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; xr-spatial-tracking; xr" allowfullscreen></iframe>',t.style.zIndex="10000",t.style.position="absolute",t.style.pointerEvents="initial";const s=t.querySelector("iframe");s.addEventListener("load",()=>{setTimeout(()=>{var c;console.log("Automatically opening iframe"),(c=this.animator)==null||c.SetBool("Open",!0)},1e3)}),s.src=this.url;let n=1e3;const i=Math.round(this.gameObject.scale.x*this.pixelsPerUnit),r=Math.round(this.gameObject.scale.y*this.pixelsPerUnit);n=Math.max(i,r),s.width=i+"px",s.height=r+"px",t.style.position="absolute",this.borderRadius>0&&(t.style.borderRadius=this.borderRadius+"px"),t.style.pointerEvents="initial",document.body.append(t),this.cssRenderer=new gp,this.cssRenderer.domElement.style.pointerEvents="none",this.cssRenderer.domElement.style.position="absolute",this.cssRenderer.domElement.style.top="0px",document.body.append(this.cssRenderer.domElement),this.cssScene=new Kr;const a=new mp(t);a.scale.setScalar(Math.max(this.gameObject.scale.x,this.gameObject.scale.y)/n),dn(a,bo(this.gameObject)),ji(a,$i(this.gameObject)),a.quaternion.multiply(this.rotate90),this.cssScene.add(a),this.cssObj=a,this.context.post_render_callbacks.push(this.onPostRender.bind(this))}onPostRender(){if(!this.cssObj||!this.cssRenderer||!this.cssScene)return;dn(this.cssObj,bo(this.gameObject)),ji(this.cssObj,$i(this.gameObject)),this.cssObj.quaternion.multiply(this.rotate90);const e=this.context.mainCamera,t=this.gameObject;var s=e.position.clone().sub(this.gameObject.position).normalize(),n=t.getWorldDirection(new J);const i=s.dot(n);this.cssObj.visible=i<.15;const r=this.cssRenderer.getSize();(r.width!==this.context.domWidth||r.height!==this.context.domHeight)&&this.cssRenderer.setSize(this.context.domWidth,this.context.domHeight),this.cssRenderer.render(this.cssScene,this.context.mainCamera)}}Pn([ae()],Ks.prototype,"url",2);Pn([ae()],Ks.prototype,"pixelsPerUnit",2);Pn([ae()],Ks.prototype,"borderRadius",2);Pn([ae(ko)],Ks.prototype,"animator",2);class Np extends R{constructor(){super(...arguments),this._ui=null}awake(){const e=te.findObjectsOfType(fu),t=document.createElement("div");t.style.cssText=`
            position: absolute;
            top: 1em;
            left: 1em;
            line-height: 1.5em;
            display: block;
            width: 200px;
        `,this.context.domElement.appendChild(t),this._ui=t;const s=document.createElement("h2");s.style.cssText=`
            margin-bottom: .7em;
        `,s.innerText="Sample Images",t.appendChild(s);const n=document.createElement("p");n.innerHTML=`Download the image and print it or you can also open the image in your browser
        <br><strong>Then enter AR and scan it with your camera.</strong>
        <br>Visit our <a target="_blank" href="https://docs.needle.tools/image-tracking">ImageTracking documentation</a> for more information.
        `,n.style.userSelect="all",t.appendChild(n);for(const i of e)this.createDownloadImageUI(i,t)}update(){var e;this.context.isInAR?(e=this._ui)==null||e.remove():this._ui&&!this._ui.parentNode&&this.context.domElement.appendChild(this._ui)}createDownloadImageUI(e,t){if(e.trackedImages)for(const s of e.trackedImages){if(!s.image)continue;const n=document.createElement("a");n.href=s.image,t.appendChild(n);const i=document.createElement("img");i.src=s.image,i.style.cssText=`
                min-width: 180px;
                max-width: 220px;
                width: 15vw;
                height: auto;
                aspect-ratio: 1.3;
                object-fit: cover;
                background: rgba(0,0,0,0.5);
                border-radius: 10px;
                border: 2px solid rgba(255,255,255,1);
                box-shadow: 0 0 10px rgba(0,0,0,.2);
                margin-left: -.5em;
            `,n.appendChild(i)}}}var vp=Object.defineProperty,wp=Object.getOwnPropertyDescriptor,Rn=(o,e,t,s)=>{for(var n=s>1?void 0:s?wp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&vp(e,t,n),n};class Co extends R{onColorChanged(){typeof this.color=="number"&&(this.color=new Je(this.color)),this.setColorToMaterials()}onPointerClick(e){const t=new Je(Math.random(),Math.random(),Math.random());this.color=t}onEnable(){this.setColorToMaterials()}setColorToMaterials(){var t;const e=this.gameObject.getComponent(ut);if(e)for(let s=0;s<e.sharedMaterials.length;s++){const n=(t=e.sharedMaterials[s])==null?void 0:t.clone();e.sharedMaterials[s]=n,n&&"color"in n&&(n.color=this.color)}else console.warn("No renderer found",this.gameObject)}}Rn([Hs(Co.prototype.onColorChanged),S(Je)],Co.prototype,"color",2);class Mo extends R{constructor(){super(...arguments),this.myArray=[],this.updateArray=()=>{const e=new Date().toLocaleTimeString();console.log("> Update array",e),this.myArray.length>10&&(console.log("Clearing array because we have reached 10 entries"),this.myArray.length=0),this.myArray.push(e),this.myArray=this.myArray,ce('<strong>> Sent</strong> "'+e+'", we now have '+this.myArray.length+" elements")}}awake(){ce("Open this window in another browser tab/window to see the networking in action..."),this.context.connection.beginListen(Ko.JoinedRoom,async()=>{console.log("Will append a new value every 10 seconds"),setInterval(this.updateArray,1e4),await Ls(100),this.updateArray()})}onArrayChanged(){console.log("< Received array",this.myArray[this.myArray.length-1],this.myArray),ce('<strong>< Received</strong> "'+this.myArray[this.myArray.length-1]+'", we now have '+this.myArray.length+" elements")}}Rn([Hs(Mo.prototype.onArrayChanged)],Mo.prototype,"myArray",2);class Tp{constructor(){this.name="",this.age=0}}class hn extends R{constructor(){super(...arguments),this.myObject=new Tp,this._mockAge=0,this.updateObject=()=>{this.myObject.name=this.context.connection.connectionId,this._mockAge+=1,this.myObject.age=this._mockAge,this.myObject=this.myObject,console.log("> Updated",this.myObject),ce('<strong>> Sent</strong> "'+this.myObject.name+'" is '+this.myObject.age+" years old")}}awake(){ce("Open this window in another browser tab/window to see the networking in action..."),this.context.connection.beginListen(Ko.JoinedRoom,async()=>{await Ls(1),this.updateObject()})}onObjectChanged(){console.log("< Received object",this.myObject),ce('<strong>< Received</strong> "'+this.myObject.name+'" is '+this.myObject.age+" years old")}}Rn([Hs(hn.prototype.onObjectChanged)],hn.prototype,"myObject",2);Rn([Hs()],hn.prototype,"_mockAge",2);var bp=Object.defineProperty,_p=Object.getOwnPropertyDescriptor,Na=(o,e,t,s)=>{for(var n=s>1?void 0:s?_p(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&bp(e,t,n),n};class ri extends R{constructor(){super(...arguments),this.clampFrameRate=!0,this._clampFrameRate=!1,this.maxFrameRate=72,this._maxFrameRate=-1024}update(){if(this._clampFrameRate!==this.clampFrameRate||this._maxFrameRate!==this.maxFrameRate){const e=this.clampFrameRate?this.maxFrameRate:void 0;this.context.targetFrameRate=e,this._clampFrameRate=this.clampFrameRate,this._maxFrameRate=this.maxFrameRate}}setTarget(e){this.maxFrameRate=e,this.clampFrameRate=!0}setClamping(e){this.clampFrameRate=e}}Na([S()],ri.prototype,"clampFrameRate",2);Na([S()],ri.prototype,"maxFrameRate",2);var Sp=Object.defineProperty,Cp=Object.getOwnPropertyDescriptor,zt=(o,e,t,s)=>{for(var n=s>1?void 0:s?Cp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Sp(e,t,n),n};class Zs extends R{constructor(){super(...arguments),this.logEvents=!1}onCollisionEnter(e){var t;this.logEvents&&console.log("ENTER",e),(t=this.onEnter)==null||t.invoke(e)}onCollisionStay(e){var t;this.logEvents&&console.log("STAY",e),(t=this.onStay)==null||t.invoke(e)}onCollisionExit(e){var t;this.logEvents&&console.log("EXIT",e),(t=this.onExit)==null||t.invoke(e)}}zt([ae(Te)],Zs.prototype,"onEnter",2);zt([ae(Te)],Zs.prototype,"onStay",2);zt([ae(Te)],Zs.prototype,"onExit",2);zt([ae()],Zs.prototype,"logEvents",2);class Qs extends R{onTriggerEnter(e){var t,s;this.triggerObjects&&this.triggerObjects.length>0&&!((t=this.triggerObjects)!=null&&t.includes(e.gameObject))||(s=this.onEnter)==null||s.invoke()}onTriggerStay(e){var t,s;this.triggerObjects&&this.triggerObjects.length>0&&!((t=this.triggerObjects)!=null&&t.includes(e.gameObject))||(s=this.onStay)==null||s.invoke()}onTriggerExit(e){var t,s;this.triggerObjects&&this.triggerObjects.length>0&&!((t=this.triggerObjects)!=null&&t.includes(e.gameObject))||(s=this.onExit)==null||s.invoke()}}zt([ae(te)],Qs.prototype,"triggerObjects",2);zt([ae(Te)],Qs.prototype,"onEnter",2);zt([ae(Te)],Qs.prototype,"onStay",2);zt([ae(Te)],Qs.prototype,"onExit",2);var Mp=Object.defineProperty,Op=Object.getOwnPropertyDescriptor,Ep=(o,e,t,s)=>{for(var n=s>1?void 0:s?Op(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Mp(e,t,n),n};class va extends R{constructor(){super(...arguments),this._lastTriggerTime=0}onTriggerEnter(e){this.context.time.time-this._lastTriggerTime<.3||(this._lastTriggerTime=this.context.time.time,this.animation&&this.animation.play(0,{loop:!1}))}onTriggerExit(){}}Ep([ae(_n)],va.prototype,"animation",2);var Ap=Object.defineProperty,Vp=Object.getOwnPropertyDescriptor,Lp=(o,e,t,s)=>{for(var n=s>1?void 0:s?Vp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Ap(e,t,n),n};class wa extends R{onTriggerEnter(){var e,t;(e=this.animation)!=null&&e.isPlaying||(t=this.animation)==null||t.play(0,{loop:!1})}}Lp([ae(_n)],wa.prototype,"animation",2);var Pp=Object.defineProperty,Rp=Object.getOwnPropertyDescriptor,Ip=(o,e,t,s)=>{for(var n=s>1?void 0:s?Rp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Pp(e,t,n),n};class Ta extends R{onCollisionEnter(){var e,t;(e=this.audioSource)==null||e.stop(),(t=this.audioSource)==null||t.play()}}Ip([ae(Gs)],Ta.prototype,"audioSource",2);class Dp extends R{onEnable(){const e=te.findObjectOfType(jr);e==null||e.addEventListener("before-export",()=>{this.resetAnimations()})}onEnterXR(e){this.resetAnimations()}resetAnimations(){console.warn("Resetting animations and audio for XR export.");const e=te.findObjectsOfType(_n);for(const s of e)s.actions.forEach(n=>{n.reset(),n.time=0,n.play()});const t=te.findObjectsOfType(Gs);for(const s of t)s.stop(),s.play()}}var Fp=Object.defineProperty,zp=Object.getOwnPropertyDescriptor,ba=(o,e,t,s)=>{for(var n=s>1?void 0:s?zp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Fp(e,t,n),n};class ai extends R{constructor(){super(...arguments),this.referenceSize=512,this.updateSize=()=>{if(this.content){if(this.referenceSize<=0)return console.error("ResponsiveContent: Base width must be greater than 0.");const e=this.context.domWidth/this.referenceSize;this.content.scale.set(e,e,e)}else Ps()&&console.warn("ResponsiveContent: No content object set.")}}onEnable(){window.addEventListener("resize",this.updateSize),this.updateSize()}onDisable(){window.removeEventListener("resize",this.updateSize)}}ba([S(St)],ai.prototype,"content",2);ba([S()],ai.prototype,"referenceSize",2);var jp=Object.defineProperty,$p=Object.getOwnPropertyDescriptor,ci=(o,e,t,s)=>{for(var n=s>1?void 0:s?$p(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&jp(e,t,n),n};class _a extends R{async sceneOpened(){var e;(e=this.animator)==null||e.setBool("SceneOpen",!0),this._htmlElement=this._getHtmlElement(),this.context.domElement.appendChild(this._htmlElement)}async sceneClosing(){var e,t;await Ls(1e3),(e=this.animator)==null||e.setBool("SceneOpen",!1),await Ls(1e3),(t=this._htmlElement)==null||t.remove()}_getHtmlElement(){if(!this._htmlElement){this._htmlElement=document.createElement("div"),this._htmlElement.style.cssText=`
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                // backdrop-filter: blur(10px);
            `;const e=document.createElement("img");e.src="https://engine.needle.tools/branding/needle-logo.png",this._htmlElement.appendChild(e)}return this._htmlElement}}ci([S(ko)],_a.prototype,"animator",2);class li extends R{sceneOpened(){var e;return Ps()&&console.log("Scene opened",this.name),(e=this.opened)==null||e.invoke(),Promise.resolve()}sceneClosing(){var e;return Ps()&&console.log("Scene closing",this.name),(e=this.closing)==null||e.invoke(),Promise.resolve()}}ci([S(Te)],li.prototype,"opened",2);ci([S(Te)],li.prototype,"closing",2);class Up extends R{next(){var e;this.switcher??(this.switcher=this.get()),console.log(this.switcher),(e=this.switcher)==null||e.selectNext()}previous(){var e;this.switcher??(this.switcher=this.get()),(e=this.switcher)==null||e.selectPrev()}get(){return te.findObjectOfType(gu)}}var Wp=Object.defineProperty,Gp=Object.getOwnPropertyDescriptor,Hp=(o,e,t,s)=>{for(var n=s>1?void 0:s?Gp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Wp(e,t,n),n};class Sa extends R{constructor(){super(...arguments),this.text=""}start(){ce(this.text)}}Hp([S()],Sa.prototype,"text",2);var kp=Object.defineProperty,Bp=Object.getOwnPropertyDescriptor,qp=(o,e,t,s)=>{for(var n=s>1?void 0:s?Bp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&kp(e,t,n),n};const Yp=xt("testleaderboard");class Oo extends R{constructor(){super(...arguments),this._ready=!1}get ready(){return this._ready}onEnable(){this.context.connection.beginListen(Ko.JoinedRoom,async()=>{await Ls(100),this.context.connection.tryGetState(this.guid)||(this.data={scores:[]}),this._ready=!0}),Yp?(console.log("Enabled test leaderboard, adding random scores"),setInterval(()=>{this.insertScore("Player",Math.floor(Math.random()*1e3))},2e3)):Ps()&&ce("You can add ?testleaderboard to the url to test the leaderboard")}insertScore(e,t){if(!this._ready){console.warn("Cannot insert score, data not received yet");return}const s=10,n=this.data.scores;for(;n.length>=s;){this.sortScores();const i=n.pop();if(i.score>t){console.log(`Score ${t} is lower than ${i==null?void 0:i.score} (lowest score), ignoring`),n.push(i);return}}console.log("Inserting score",e,t),n.push({name:e,score:t}),this.sortScores(),this.data=this.data}sortScores(){this.data.scores.sort((e,t)=>t.score-e.score)}onDataChanged(e){if(console.warn("Data changed!",e,this.data.scores),this.data.scores.length>0){const t=this.data.scores[0];ce("HIGHSCORE - "+t.name+": "+t.score)}this.dispatchEvent(new CustomEvent("changed",{detail:this.data}))}}qp([Hs(Oo.prototype.onDataChanged)],Oo.prototype,"data",2);var Kp=Object.defineProperty,Zp=Object.getOwnPropertyDescriptor,Qp=(o,e,t,s)=>{for(var n=s>1?void 0:s?Zp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Kp(e,t,n),n};class Ca extends R{start(){this.updateStartPosition();const e=te.findObjectOfType(jr);e&&e.addEventListener("before-export",()=>{this.resetToStart()})}updateStartPosition(){this.gameObject.updateMatrix(),this.startPosition=this.gameObject.position.clone(),this.startMatrix=this.gameObject.matrix.clone()}resetToStart(){if(!this.startPosition)return;const e=te.getComponent(this.gameObject,Pt);e==null||e.teleport(this.startPosition)}}class Ma extends Ca{start(){super.start(),this.worldCollider||console.warn("Missing collider to reset",this)}onTriggerExit(e){e===this.worldCollider&&this.resetToStart()}createBehaviours(e,t,s){if(t.uuid!==this.gameObject.uuid||!this.startPosition||!this.startMatrix)return;const n=an.createEmpty();this.gameObject.parent?n.matrix=this.gameObject.parent.matrixWorld.clone().multiply(this.startMatrix):n.matrix=this.startMatrix,s.document.add(n);const i=new Fr("_reset_"+this.name+"_afterTime",zr.sceneStartTrigger(),Ht.sequence(Ht.waitAction(Math.random()*4+1),Ht.sequence(Ht.transformAction(this.gameObject,n,0,"absolute","none"),Ht.waitAction(5)).makeLooping())).makeExclusive(!0);e.addBehavior(i)}}Qp([ae(Sn)],Ma.prototype,"worldCollider",2);var Xp=Object.defineProperty,Jp=Object.getOwnPropertyDescriptor,em=(o,e,t,s)=>{for(var n=s>1?void 0:s?Jp(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Xp(e,t,n),n};class Oa extends R{constructor(){super(...arguments),this.roomId="",this.playerCount=0}update(){const e=this.context.connection;let t=!1;e.currentRoomName&&e.currentRoomName!==this.roomId&&(this.roomId=e.currentRoomName,t=!0),e.usersInRoom().length!==this.playerCount&&(this.playerCount=e.usersInRoom().length,t=!0),t&&this.connectionLabel&&(this.connectionLabel.text=`Room: ${this.roomId}
Users: ${this.playerCount}
Your id: ${e.connectionId}`)}}em([S(Ws)],Oa.prototype,"connectionLabel",2);var tm=Object.defineProperty,sm=Object.getOwnPropertyDescriptor,nm=(o,e,t,s)=>{for(var n=s>1?void 0:s?sm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&tm(e,t,n),n};class Ea extends R{constructor(){super(...arguments),this.interval=1e3,this.max=100,this.spawned=0}awake(){if(!this.object){console.warn("TimedSpawn: no object to spawn"),ce("TimedSpawn: no object to spawn",$r.Warn);return}te.setActive(this.object,!1),this.startCoroutine(this.spawn())}*spawn(){if(this.object)for(;this.spawned<this.max;){const e=te.instantiate(this.object);te.setActive(e,!0),this.spawned+=1,yield xu(this.interval/1e3)}}}nm([ae(te)],Ea.prototype,"object",2);class om extends R{async awake(){const e=document.createElement("video");e.style.cssText=`
            position: fixed;
            min-width: 100%;
            min-height: 100%;
            z-index: -1;
        `,this.context.domElement.shadowRoot.appendChild(e);const t=await navigator.mediaDevices.getUserMedia({video:!0});if(!t)return;e.srcObject=t,e.play();const s=this.context.mainCameraComponent;s&&(s.clearFlags=yu.SolidColor,s.backgroundColor=new Pr(125,125,125,0))}}var im=Object.defineProperty,rm=Object.getOwnPropertyDescriptor,In=(o,e,t,s)=>{for(var n=s>1?void 0:s?rm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&im(e,t,n),n};class Xs extends R{constructor(){super(...arguments),this.interval=3,this.resetPosition=!0,this.resetRotation=!1,this.resetVelocity=!1}start(){const e=this.gameObject.position.clone(),t=this.gameObject.rotation.clone(),s=this.gameObject.getComponent(Pt),n=this.context.time.frame;setInterval(()=>{this.resetPosition&&this.gameObject.position.copy(e),this.resetRotation&&this.gameObject.rotation.copy(t),s&&this.resetVelocity&&this.context.time.frame!==n&&s.resetVelocities()},this.interval*1e3)}}In([S()],Xs.prototype,"interval",2);In([S()],Xs.prototype,"resetPosition",2);In([S()],Xs.prototype,"resetRotation",2);In([S()],Xs.prototype,"resetVelocity",2);class am extends R{constructor(){super(...arguments),this.toggleRendererOnly=!1}start(){setInterval(()=>{if(ce('This is a sample for showing how to <a href="https://engine.needle.tools/docs/scripting.html#component-architecture" target="_blank">toggle visibility of a GameObject</a>'),this.toggleRendererOnly){const e=this.gameObject.getComponent(ut);e&&(e.enabled=!e.enabled)}else this.gameObject.visible=!this.gameObject.visible},1e3)}}var cm=Object.defineProperty,lm=Object.getOwnPropertyDescriptor,dm=(o,e,t,s)=>{for(var n=s>1?void 0:s?lm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&cm(e,t,n),n};class Aa extends R{awake(){this.material&&(this.material.wireframe=!0)}}dm([S(ks)],Aa.prototype,"material",2);var um=Object.defineProperty,hm=Object.getOwnPropertyDescriptor,Va=(o,e,t,s)=>{for(var n=s>1?void 0:s?hm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&um(e,t,n),n};class di extends R{constructor(){super(...arguments),this.onSessionStart=new Te,this.onSessionEnd=new Te}onEnterXR(e){this.onWebXRStarted()}onExitXR(e){this.onWebXREnded()}onWebXRStarted(){Ui(this.context.scene,!1),this.onSessionStart.invoke()}onWebXREnded(){Ui(this.context.scene,!1),this.onSessionEnd.invoke()}}Va([S(Te)],di.prototype,"onSessionStart",2);Va([S(Te)],di.prototype,"onSessionEnd",2);const on=xt("debugbodytracking");class pm extends R{constructor(){super(...arguments),this.jointPositions=new Map,this.size=new J(.01,.01,.01),this.hasWarnedForName=new Set}onEnable(){on&&console.log(Xi.join(`
`))}onBeforeXR(e,t){t.optionalFeatures=t.optionalFeatures||[],t.optionalFeatures.includes("body-tracking")||t.optionalFeatures.push("body-tracking")}onUpdateXR(e){const t=e.xr.frame;if(!t)return;const s=e.xr.rig.gameObject,n=this.context.renderer.xr.getReferenceSpace();if(t.session&&"body"in t&&n){const i=t.body;if(!i)return;i.forEach(r=>{const a=t.getPose(r,n);if(!a)return;const c=a.transform.position,l=be();l.copy(c),l.x*=-1,l.z*=-1,s.localToWorld(l);const d=r.jointName;this.jointPositions.has(d)||this.jointPositions.set(d,new J),this.jointPositions.get(d).copy(l),on&&dt.DrawWireBox(l,this.size,16711680,void 0,!1);const u=be();u.copy(c),u.x*=-1,s.localToWorld(u);const m=r.jointName+"-flipped";this.jointPositions.has(m)||this.jointPositions.set(m,new J),this.jointPositions.get(m).copy(u),on&&dt.DrawWireBox(u,this.size,65280,void 0,!1);const w=Xi.indexOf(d);on&&dt.DrawLabel(u,w.toString(),.015,void 0,16777215,85),w<0&&(this.hasWarnedForName.has(d)||(this.hasWarnedForName.add(d),console.warn("Wrong name: "+d+" -> "+w+". Please report a bug.")))});for(const r of mm){const a=this.jointPositions.get(r.from),c=this.jointPositions.get(r.to);if(a&&c){dt.DrawLine(a,c,16776960,void 0,!1);const l=this.jointPositions.get(r.from+"-flipped"),d=this.jointPositions.get(r.to+"-flipped");l&&d&&dt.DrawLine(l,d,65535,void 0,!1)}}}}}var La=(o=>(o[o.root=0]="root",o[o.hips=1]="hips",o[o["spine-lower"]=2]="spine-lower",o[o["spine-middle"]=3]="spine-middle",o[o["spine-upper"]=4]="spine-upper",o[o.chest=5]="chest",o[o.neck=6]="neck",o[o.head=7]="head",o[o["left-shoulder"]=8]="left-shoulder",o[o["left-scapula"]=9]="left-scapula",o[o["left-arm-upper"]=10]="left-arm-upper",o[o["left-arm-lower"]=11]="left-arm-lower",o[o["left-hand-wrist-twist"]=12]="left-hand-wrist-twist",o[o["right-shoulder"]=13]="right-shoulder",o[o["right-scapula"]=14]="right-scapula",o[o["right-arm-upper"]=15]="right-arm-upper",o[o["right-arm-lower"]=16]="right-arm-lower",o[o["right-hand-wrist-twist"]=17]="right-hand-wrist-twist",o[o["left-hand-palm"]=18]="left-hand-palm",o[o["left-hand-wrist"]=19]="left-hand-wrist",o[o["left-hand-thumb-metacarpal"]=20]="left-hand-thumb-metacarpal",o[o["left-hand-thumb-phalanx-proximal"]=21]="left-hand-thumb-phalanx-proximal",o[o["left-hand-thumb-phalanx-distal"]=22]="left-hand-thumb-phalanx-distal",o[o["left-hand-thumb-tip"]=23]="left-hand-thumb-tip",o[o["left-hand-index-metacarpal"]=24]="left-hand-index-metacarpal",o[o["left-hand-index-phalanx-proximal"]=25]="left-hand-index-phalanx-proximal",o[o["left-hand-index-phalanx-intermediate"]=26]="left-hand-index-phalanx-intermediate",o[o["left-hand-index-phalanx-distal"]=27]="left-hand-index-phalanx-distal",o[o["left-hand-index-tip"]=28]="left-hand-index-tip",o[o["left-hand-middle-phalanx-metacarpal"]=29]="left-hand-middle-phalanx-metacarpal",o[o["left-hand-middle-phalanx-proximal"]=30]="left-hand-middle-phalanx-proximal",o[o["left-hand-middle-phalanx-intermediate"]=31]="left-hand-middle-phalanx-intermediate",o[o["left-hand-middle-phalanx-distal"]=32]="left-hand-middle-phalanx-distal",o[o["left-hand-middle-tip"]=33]="left-hand-middle-tip",o[o["left-hand-ring-metacarpal"]=34]="left-hand-ring-metacarpal",o[o["left-hand-ring-phalanx-proximal"]=35]="left-hand-ring-phalanx-proximal",o[o["left-hand-ring-phalanx-intermediate"]=36]="left-hand-ring-phalanx-intermediate",o[o["left-hand-ring-phalanx-distal"]=37]="left-hand-ring-phalanx-distal",o[o["left-hand-ring-tip"]=38]="left-hand-ring-tip",o[o["left-hand-little-metacarpal"]=39]="left-hand-little-metacarpal",o[o["left-hand-little-phalanx-proximal"]=40]="left-hand-little-phalanx-proximal",o[o["left-hand-little-phalanx-intermediate"]=41]="left-hand-little-phalanx-intermediate",o[o["left-hand-little-phalanx-distal"]=42]="left-hand-little-phalanx-distal",o[o["left-hand-little-tip"]=43]="left-hand-little-tip",o[o["right-hand-palm"]=44]="right-hand-palm",o[o["right-hand-wrist"]=45]="right-hand-wrist",o[o["right-hand-thumb-metacarpal"]=46]="right-hand-thumb-metacarpal",o[o["right-hand-thumb-phalanx-proximal"]=47]="right-hand-thumb-phalanx-proximal",o[o["right-hand-thumb-phalanx-distal"]=48]="right-hand-thumb-phalanx-distal",o[o["right-hand-thumb-tip"]=49]="right-hand-thumb-tip",o[o["right-hand-index-metacarpal"]=50]="right-hand-index-metacarpal",o[o["right-hand-index-phalanx-proximal"]=51]="right-hand-index-phalanx-proximal",o[o["right-hand-index-phalanx-intermediate"]=52]="right-hand-index-phalanx-intermediate",o[o["right-hand-index-phalanx-distal"]=53]="right-hand-index-phalanx-distal",o[o["right-hand-index-tip"]=54]="right-hand-index-tip",o[o["right-hand-middle-metacarpal"]=55]="right-hand-middle-metacarpal",o[o["right-hand-middle-phalanx-proximal"]=56]="right-hand-middle-phalanx-proximal",o[o["right-hand-middle-phalanx-intermediate"]=57]="right-hand-middle-phalanx-intermediate",o[o["right-hand-middle-phalanx-distal"]=58]="right-hand-middle-phalanx-distal",o[o["right-hand-middle-tip"]=59]="right-hand-middle-tip",o[o["right-hand-ring-metacarpal"]=60]="right-hand-ring-metacarpal",o[o["right-hand-ring-phalanx-proximal"]=61]="right-hand-ring-phalanx-proximal",o[o["right-hand-ring-phalanx-intermediate"]=62]="right-hand-ring-phalanx-intermediate",o[o["right-hand-ring-phalanx-distal"]=63]="right-hand-ring-phalanx-distal",o[o["right-hand-ring-tip"]=64]="right-hand-ring-tip",o[o["right-hand-little-metacarpal"]=65]="right-hand-little-metacarpal",o[o["right-hand-little-phalanx-proximal"]=66]="right-hand-little-phalanx-proximal",o[o["right-hand-little-phalanx-intermediate"]=67]="right-hand-little-phalanx-intermediate",o[o["right-hand-little-phalanx-distal"]=68]="right-hand-little-phalanx-distal",o[o["right-hand-little-tip"]=69]="right-hand-little-tip",o[o["left-upper-leg"]=70]="left-upper-leg",o[o["left-lower-leg"]=71]="left-lower-leg",o[o["left-foot-ankle-twist"]=72]="left-foot-ankle-twist",o[o["left-foot-ankle"]=73]="left-foot-ankle",o[o["left-foot-subtalar"]=74]="left-foot-subtalar",o[o["left-foot-transverse"]=75]="left-foot-transverse",o[o["left-foot-ball"]=76]="left-foot-ball",o[o["right-upper-leg"]=77]="right-upper-leg",o[o["right-lower-leg"]=78]="right-lower-leg",o[o["right-foot-ankle-twist"]=79]="right-foot-ankle-twist",o[o["right-foot-ankle"]=80]="right-foot-ankle",o[o["right-foot-subtalar"]=81]="right-foot-subtalar",o[o["right-foot-transverse"]=82]="right-foot-transverse",o[o["right-foot-ball"]=83]="right-foot-ball",o))(La||{});const Xi=Object.values(La),mm=[{from:"hips",to:"spine-lower"},{from:"spine-lower",to:"spine-middle"},{from:"spine-middle",to:"spine-upper"},{from:"spine-upper",to:"chest"},{from:"chest",to:"neck"},{from:"neck",to:"head"},{from:"chest",to:"left-shoulder"},{from:"left-shoulder",to:"left-scapula"},{from:"left-scapula",to:"left-arm-upper"},{from:"left-arm-upper",to:"left-arm-lower"},{from:"left-arm-lower",to:"left-hand-wrist-twist"},{from:"left-hand-wrist-twist",to:"left-hand-wrist"},{from:"left-hand-wrist",to:"left-hand-palm"},{from:"left-hand-wrist",to:"left-hand-thumb-metacarpal"},{from:"left-hand-thumb-metacarpal",to:"left-hand-thumb-phalanx-proximal"},{from:"left-hand-thumb-phalanx-proximal",to:"left-hand-thumb-phalanx-distal"},{from:"left-hand-thumb-phalanx-distal",to:"left-hand-thumb-tip"},{from:"left-hand-wrist",to:"left-hand-index-metacarpal"},{from:"left-hand-index-metacarpal",to:"left-hand-index-phalanx-proximal"},{from:"left-hand-index-phalanx-proximal",to:"left-hand-index-phalanx-intermediate"},{from:"left-hand-index-phalanx-intermediate",to:"left-hand-index-phalanx-distal"},{from:"left-hand-index-phalanx-distal",to:"left-hand-index-tip"},{from:"left-hand-wrist",to:"left-hand-middle-phalanx-metacarpal"},{from:"left-hand-middle-phalanx-metacarpal",to:"left-hand-middle-phalanx-proximal"},{from:"left-hand-middle-phalanx-proximal",to:"left-hand-middle-phalanx-intermediate"},{from:"left-hand-middle-phalanx-intermediate",to:"left-hand-middle-phalanx-distal"},{from:"left-hand-middle-phalanx-distal",to:"left-hand-middle-tip"},{from:"left-hand-wrist",to:"left-hand-ring-metacarpal"},{from:"left-hand-ring-metacarpal",to:"left-hand-ring-phalanx-proximal"},{from:"left-hand-ring-phalanx-proximal",to:"left-hand-ring-phalanx-intermediate"},{from:"left-hand-ring-phalanx-intermediate",to:"left-hand-ring-phalanx-distal"},{from:"left-hand-ring-phalanx-distal",to:"left-hand-ring-tip"},{from:"left-hand-wrist",to:"left-hand-little-metacarpal"},{from:"left-hand-little-metacarpal",to:"left-hand-little-phalanx-proximal"},{from:"left-hand-little-phalanx-proximal",to:"left-hand-little-phalanx-intermediate"},{from:"left-hand-little-phalanx-intermediate",to:"left-hand-little-phalanx-distal"},{from:"left-hand-little-phalanx-distal",to:"left-hand-little-tip"},{from:"chest",to:"right-shoulder"},{from:"right-shoulder",to:"right-scapula"},{from:"right-scapula",to:"right-arm-upper"},{from:"right-arm-upper",to:"right-arm-lower"},{from:"right-arm-lower",to:"right-hand-wrist-twist"},{from:"right-hand-wrist-twist",to:"right-hand-wrist"},{from:"right-hand-wrist",to:"right-hand-palm"},{from:"right-hand-wrist",to:"right-hand-thumb-metacarpal"},{from:"right-hand-thumb-metacarpal",to:"right-hand-thumb-phalanx-proximal"},{from:"right-hand-thumb-phalanx-proximal",to:"right-hand-thumb-phalanx-distal"},{from:"right-hand-thumb-phalanx-distal",to:"right-hand-thumb-tip"},{from:"right-hand-wrist",to:"right-hand-index-metacarpal"},{from:"right-hand-index-metacarpal",to:"right-hand-index-phalanx-proximal"},{from:"right-hand-index-phalanx-proximal",to:"right-hand-index-phalanx-intermediate"},{from:"right-hand-index-phalanx-intermediate",to:"right-hand-index-phalanx-distal"},{from:"right-hand-index-phalanx-distal",to:"right-hand-index-tip"},{from:"right-hand-wrist",to:"right-hand-middle-metacarpal"},{from:"right-hand-middle-metacarpal",to:"right-hand-middle-phalanx-proximal"},{from:"right-hand-middle-phalanx-proximal",to:"right-hand-middle-phalanx-intermediate"},{from:"right-hand-middle-phalanx-intermediate",to:"right-hand-middle-phalanx-distal"},{from:"right-hand-middle-phalanx-distal",to:"right-hand-middle-tip"},{from:"right-hand-wrist",to:"right-hand-ring-metacarpal"},{from:"right-hand-ring-metacarpal",to:"right-hand-ring-phalanx-proximal"},{from:"right-hand-ring-phalanx-proximal",to:"right-hand-ring-phalanx-intermediate"},{from:"right-hand-ring-phalanx-intermediate",to:"right-hand-ring-phalanx-distal"},{from:"right-hand-ring-phalanx-distal",to:"right-hand-ring-tip"},{from:"right-hand-wrist",to:"right-hand-little-metacarpal"},{from:"right-hand-little-metacarpal",to:"right-hand-little-phalanx-proximal"},{from:"right-hand-little-phalanx-proximal",to:"right-hand-little-phalanx-intermediate"},{from:"right-hand-little-phalanx-intermediate",to:"right-hand-little-phalanx-distal"},{from:"right-hand-little-phalanx-distal",to:"right-hand-little-tip"},{from:"hips",to:"left-upper-leg"},{from:"left-upper-leg",to:"left-lower-leg"},{from:"left-lower-leg",to:"left-foot-ankle-twist"},{from:"left-foot-ankle-twist",to:"left-foot-ankle"},{from:"left-foot-ankle",to:"left-foot-subtalar"},{from:"left-foot-subtalar",to:"left-foot-transverse"},{from:"left-foot-transverse",to:"left-foot-ball"},{from:"hips",to:"right-upper-leg"},{from:"right-upper-leg",to:"right-lower-leg"},{from:"right-lower-leg",to:"right-foot-ankle-twist"},{from:"right-foot-ankle-twist",to:"right-foot-ankle"},{from:"right-foot-ankle",to:"right-foot-subtalar"},{from:"right-foot-subtalar",to:"right-foot-transverse"},{from:"right-foot-transverse",to:"right-foot-ball"}];var fm=Object.defineProperty,gm=Object.getOwnPropertyDescriptor,xm=(o,e,t,s)=>{for(var n=s>1?void 0:s?gm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&fm(e,t,n),n};class ui extends R{constructor(){super(...arguments),this.destroyTarget=!1,this._startTime=0}awake(){if(this._rigidbody=this.gameObject.getComponentInParent(Pt)||void 0,this._rigidbody){const e=this.gameObject.getComponentsInChildren(Sn);for(const t of e){const s=te.addComponent(t.gameObject,ym);s.rigidBody=this._rigidbody,s.arrow=this,s.audioOnImpact=this.audioOnImpact,s.destroyTarget=this.destroyTarget}}this._startTime=this.context.time.time}onBeforeRender(){if(this.context.time.time-this._startTime>5){this.gameObject.destroy();return}if(this._rigidbody){const e=this._rigidbody.getVelocity();if(e.lengthSq()>0){const t=be().set(e.x,e.y,e.z).normalize(),s=Ur();s.setFromUnitVectors(be(0,0,1),t),this.gameObject.quaternion.copy(s)}}}}xm([S(Gs)],ui.prototype,"audioOnImpact",2);class ym extends R{constructor(){super(...arguments),this.destroyTarget=!1}onCollisionEnter(e){var t,s;if(this.arrow)if((t=this.audioOnImpact)==null||t.stop(),(s=this.audioOnImpact)==null||s.play(),this.destroyTarget)e.gameObject.destroy(),this.arrow.gameObject.destroy();else{e.gameObject.attach(this.arrow.gameObject),e.rigidBody instanceof Pt&&e.rigidBody.applyImpulse(e.gameObject.position.clone().multiply(this.rigidBody.getVelocity()),!0);const n=this.rigidBody.gameObject.getComponentsInChildren(Sn);for(const i of n)i.destroy();this.rigidBody.destroy(),this.arrow.destroy()}}}var Nm=Object.defineProperty,vm=Object.getOwnPropertyDescriptor,De=(o,e,t,s)=>{for(var n=s>1?void 0:s?vm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Nm(e,t,n),n};const wm=xt("debugarrow");class Le extends R{constructor(){super(...arguments),this.power=1.5,this.drawMaxPhysicalDistance=.47269,this.drawMinPhysicalDistance=.1132593,this.desktopIdleDrawAmount=.25,this.interactionPixelOrigin=new oe(.5,.65),this.interactionPixelTreshold=85,this.drawMaxPixelDistance=100,this._isAiming=!1,this._aimingPointerStartPos=new oe(0,0),this._bowController=void 0,this._stringController=void 0,this.onDown=e=>{var t;if(e.origin instanceof Wi){if(e.button===0){this._bowController===void 0?this._bowController=e.origin.index:this._stringController===void 0&&(this._stringController=e.origin.index),this._bowController===this._stringController&&(this._stringController=void 0);const s=(t=this.bowObject)==null?void 0:t.getComponentInParent(vu);s&&(s.side=this._bowController),this._isAiming=this._stringController!==void 0}}else e.button===0&&(this._isAiming=!0,this._aimingPointerId=e.pointerId)},this.onRelease=e=>{var t;if(e.button===0&&this._isAiming){if(this._isAiming=!1,this._aimingPointerId=void 0,e.origin instanceof Wi){const s=e.origin;if(s.index===this._stringController&&this._bowController!==void 0){const n=(t=Ir.active)==null?void 0:t.getController(this._bowController);if(s&&n){const i=s.gripWorldPosition;if(i){const r=n.gripWorldPosition.clone().sub(i);let a=n.object.worldPosition.distanceTo(s.object.worldPosition);a-=this.drawMinPhysicalDistance;const c=Z.clamp01(a/this.drawMaxPhysicalDistance);r.normalize().multiplyScalar(c*this.power),this.shoot(i,r),wm&&dt.DrawArrow(i,r.clone().add(i),16776960,1)}}}s.index===this._bowController&&(this._bowController=void 0),s.index===this._stringController&&(this._stringController=void 0)}else if(this.arrowSpawnSpot){const s=this.arrowSpawnSpot.getWorldPosition(be()),n=this.gameObject.getWorldDirection(be()),i=this.getPointerDinstanceTo(this._aimingPointerStartPos,e.pointerId),r=Z.clamp01(i/this.drawMaxPixelDistance)*this.power;n.multiplyScalar(r),i>this.interactionPixelTreshold&&this.shoot(s,n)}}},this.shotStamp=Number.MIN_SAFE_INTEGER,this.fakeArrowRespawnDuration=.3,this._initRot=new os,this._tempLookMatrix=new hs,this._tempLookRot=new os,this._rotate90=new os().setFromAxisAngle(new J(0,0,1),Math.PI/2),this.tempDir=new oe,this.tempUpRef=new oe}awake(){var e;(e=this.arrowPrefab)!=null&&e.asset&&(this.arrowPrefab.asset.visible=!1),this.bowObject&&this._initRot.copy(this.bowObject.quaternion),this.nonMountedParent=this.gameObject.parent,this.mount()}async onEnable(){var e;await((e=this.arrowPrefab)==null?void 0:e.loadAssetAsync()),this._isAiming=!1,this.context.input.addEventListener("pointerdown",this.onDown),this.context.input.addEventListener("pointerup",this.onRelease),this.setupPreDraw()}onDisable(){this._isAiming=!1,this.context.input.removeEventListener("pointerdown",this.onDown),this.context.input.removeEventListener("pointerup",this.onRelease)}getPointerDinstanceTo(e,t){const s=this.context.input.getPointerPosition(t);return e.distanceTo(s)}async setupPreDraw(){var t,s,n;if(!this.arrowPrefab||!this.arrowSpawnSpot||this.fakeArrow)return;const e=await this.arrowPrefab.instantiate({parent:this.arrowSpawnSpot});e&&(e.visible=!0,e.worldScale=be(1,1,1),this.fakeArrow=e,(t=e.getComponent(ui))==null||t.destroy(),(s=e.getComponent(Pt))==null||s.destroy(),(n=e.getComponentInChildren(Yo))==null||n.destroy(),e.getComponentsInChildren(Sn).forEach(i=>i.destroy()))}async shoot(e,t){var l,d;if(!this.arrowPrefab)return;this.shotStamp=this.context.time.time;const s=e.clone(),n=s.clone().add(t),i=Math.pow(t.length()+.5,2),r=t.clone().normalize(),a=await this.arrowPrefab.instantiate({parent:this.context.scene});if(!a){console.error("Failed to instantiate arrow prefab");return}a.worldPosition=s,a.lookAt(n),a.visible=!0;const c=a.getComponent(Pt);c&&(c.isKinematic=!1,c.autoMass=!1,c.mass=.05,(l=this.sound)==null||l.stop(),(d=this.sound)==null||d.play(),await Bo(1),c.applyImpulse(r.multiplyScalar(i),!0))}mount(){this.cameraParent&&(this.gameObject.parent=this.cameraParent,this.gameObject.position.set(0,0,0),this.gameObject.quaternion.set(0,0,0,1))}unmount(){this.gameObject.parent=this.nonMountedParent}get _hasControllers(){var e;return(((e=this.context.xr)==null?void 0:e.controllers.length)??0)>0}onEnterXR(e){(e.xr.isVR||e.xr.isPassThrough)&&this.unmount()}onLeaveXR(e){this.mount()}onBeforeRender(){if(!this.animationComponent||!this.bowObject)return;if(!this._mixer){this._mixer=new Eu(this.bowObject);const i=this.animationComponent.animations.at(0);i&&(this._animation=this._mixer.clipAction(i))}const e=.1;let t=0;if(this._hasControllers){if(!this._isAiming)t=0,this.shotStamp=this.context.time.time;else if(this.context.xr&&this.context.xr.controllers.length>1&&this._bowController!==void 0&&this._stringController!==void 0){const i=this.context.xr.controllers[this._stringController],r=this.context.xr.controllers[this._bowController];if(!i||!r)return;let a=be(0,1,0);!r.hand&&r.targetRayMode==="tracked-pointer"&&a.applyQuaternion(this._rotate90),a.applyQuaternion(r.gripWorldQuaternion).normalize(),this._tempLookMatrix.lookAt(i.gripWorldPosition,r.gripWorldPosition,a),this._tempLookRot.setFromRotationMatrix(this._tempLookMatrix),this.bowObject.worldQuaternion=this._tempLookRot;let c=i.object.worldPosition.distanceTo(r.object.worldPosition);c-=this.drawMinPhysicalDistance,t=Z.clamp01(c/this.drawMaxPhysicalDistance)}}else{const i=this.interactionPixelOrigin;if(this._aimingPointerStartPos.set(this.context.domWidth*i.x,this.context.domHeight*i.y),!this._isAiming)t=this.desktopIdleDrawAmount;else{const r=this.context.input;if(this._aimingPointerId!=null){const a=this._aimingPointerStartPos,c=r.getPointerPosition(this._aimingPointerId),l=this.tempDir.copy(c).sub(a),u=l.length(),m=be();m.x=l.x,m.z=l.y,m.normalize();const w=this.gameObject.getWorldDirection(be());w.y=0,w.normalize();const T=m.dot(w),N=u>this.interactionPixelTreshold;(T>0||N)&&(t=Z.clamp01(u/this.drawMaxPixelDistance)),this.tempUpRef.set(1,0);const O=this.tempUpRef.dot(l)>0?-1:1;this.tempUpRef.set(0,1);const P=this.tempUpRef.angleTo(l)*O;if(N){const L=Ur().setFromAxisAngle(be().set(1,0,0),P);this.gameObject.quaternion.slerp(L,this.context.time.deltaTime/.05)}}}}this.drawProgression&&(t=this.drawProgression.evaluate(t)),this._animation.timeScale=0;const s=Z.lerp(this._animation.time,t,this.context.time.deltaTime/e),n=this._animation.time;if(this._animation.time=s,Math.abs(s-n)>Number.EPSILON&&(this._animation.setEffectiveWeight(1),this._animation.play()),this._mixer.update(this.context.time.deltaTime),this.fakeArrow){let i=(this.context.time.time-this.shotStamp)/this.fakeArrowRespawnDuration;i=this.easeInOutSine(Z.clamp01(i)),this.fakeArrow.worldScale=be(1,1,1).multiplyScalar(i)}}easeInOutSine(e){return Z.clamp01(-.5*(Math.cos(Math.PI*e)-1))}}De([S()],Le.prototype,"power",2);De([S()],Le.prototype,"drawMaxPhysicalDistance",2);De([S()],Le.prototype,"drawMinPhysicalDistance",2);De([S(Rr)],Le.prototype,"drawProgression",2);De([S(St)],Le.prototype,"cameraParent",2);De([S()],Le.prototype,"desktopIdleDrawAmount",2);De([S(oe)],Le.prototype,"interactionPixelOrigin",2);De([S()],Le.prototype,"interactionPixelTreshold",2);De([S()],Le.prototype,"drawMaxPixelDistance",2);De([S(St)],Le.prototype,"bowObject",2);De([S(_n)],Le.prototype,"animationComponent",2);De([S(Nu)],Le.prototype,"arrowPrefab",2);De([S(St)],Le.prototype,"arrowSpawnSpot",2);De([S(Gs)],Le.prototype,"sound",2);De([S()],Le.prototype,"fakeArrowRespawnDuration",2);var Tm=Object.defineProperty,bm=Object.getOwnPropertyDescriptor,_m=(o,e,t,s)=>{for(var n=s>1?void 0:s?bm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Tm(e,t,n),n};class Pa extends R{start(){this._meshRenderer=this.gameObject.getComponentInChildren(wu)}onDestroy(){if(this.gameObject.visible&&this.particleSystem){if(this.particleSystem.shape.shapeType===no.MeshRenderer&&this._meshRenderer&&!Wr(this._meshRenderer.gameObject)){this.particleSystem.shape.shapeType=no.MeshRenderer,this.particleSystem.shape.setMesh(this._meshRenderer),this.particleSystem.play();return}this.particleSystem.shape.shapeType=no.Sphere,this.particleSystem.worldPosition=this.gameObject.worldPosition,this.particleSystem.play()}}}_m([S(Yo)],Pa.prototype,"particleSystem",2);var Sm=Object.defineProperty,Cm=Object.getOwnPropertyDescriptor,Mm=(o,e,t,s)=>{for(var n=s>1?void 0:s?Cm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Sm(e,t,n),n};class Ra extends R{constructor(){super(...arguments),this._instances=new Array}awake(){var e,t;if(!((e=this.prefabs)!=null&&e.length)||((t=this.prefabs)==null?void 0:t.length)===0){console.warn("BowTargetSpawner start: no prefab set"),this.enabled=!1;return}this.prefabs.forEach(s=>s.visible=!1)}update(){var t;if(!((t=this.prefabs)!=null&&t.length))return;const e=be();for(let s=this._instances.length-1;s>=0;s--){const n=this._instances[s];Wr(n.instance)?this._instances.splice(s,1):(e.setScalar(n.scale),n.instance.scale.lerp(e,this.context.time.deltaTime))}if(this.context.time.frame%20===0&&Math.random()>.5){const s=this.worldPosition;s.x+=Math.random()*12-6,s.y+=Math.random()*3,s.z+=Math.random()*6;const n=Math.random()*3+.5,i=this.prefabs[Math.floor(Math.random()*this.prefabs.length)],r=Tu(i,{parent:this.scene,position:s.clone(),scale:new J(.01,.01,.01),keepWorldPosition:!0});r.visible=!0,this._instances.push({instance:r,scale:n}),setTimeout(()=>{r.destroy()},7e3),Bo(1).then(()=>{const a=r.getComponentInChildren(Pt);a&&(a.gravityScale=.2+Math.random()*.3,a.mass=2,a.autoMass=!1),a==null||a.setAngularVelocity(Z.random(-2,2),Z.random(-2,2),Z.random(-2,2)),a==null||a.applyImpulse({x:0,y:5+Math.random()*12,z:0})})}}}Mm([S(St)],Ra.prototype,"prefabs",2);class Om extends R{start(){console.log("UserAgent",window.navigator.userAgent),console.log("isMobileDevice",oo()),console.log("isiOSDevice",io()),console.log("isMozillaXR",Gi()),console.log("isSafari",Hi()),console.log("isQuest",ki()),oo()?io()?ce("iOS 🍎"):window.navigator.userAgent.indexOf("Android")>-1?ce("Android 🤖"):ce("Other Mobile 📱"):bu()?ce("Desktop 🖥️"):ce("Other Device 🌏"),oo()&&io()&&Hi()?ce("Safari 🌏"):Gi()?ce("Mozilla XR 🦊"):ki()?ce("Quest 🎮"):window.navigator.userAgent.indexOf("Chrome")>-1?ce("Chrome 🌏"):ce("Other Browser 🌏"),ce("UserAgent: "+window.navigator.userAgent)}}var Em=Object.defineProperty,Am=Object.getOwnPropertyDescriptor,Mt=(o,e,t,s)=>{for(var n=s>1?void 0:s?Am(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Em(e,t,n),n};class fs{constructor(){this.name="Name"}}Mt([S()],fs.prototype,"name",2);Mt([S(Zo)],fs.prototype,"icon",2);Mt([S(Te)],fs.prototype,"click",2);class Kt{constructor(){this.title="Title",this.items=[]}}Mt([S()],Kt.prototype,"title",2);Mt([S(Zo)],Kt.prototype,"icon",2);Mt([S(Te)],Kt.prototype,"select",2);Mt([S(Te)],Kt.prototype,"deselect",2);Mt([S(fs)],Kt.prototype,"items",2);class Dn extends R{constructor(){super(...arguments),this.categories=[]}awake(){document.body.insertAdjacentHTML("afterbegin",`<style>${Im}</style>`),document.body.insertAdjacentHTML("afterbegin",Rm),this.mainmenu=document.querySelector(".mainmenu"),this.submenuRoot=document.querySelector(".submenu-wrapper"),this.submenu=document.querySelector(".submenu"),this.submenuTitle=document.querySelector(".submenu-title"),this.submenuContent=document.querySelector(".submenu-content"),this.categories.forEach(e=>this.addCategory(e)),this.hideSubmenu()}addNewCategory(e){this.categories.push(e),this.addCategory(e)}addCategory(e){if(!this.mainmenu)return;const t=Lm(e);this.mainmenu.appendChild(t),t.onclick=()=>{this.selectedCategory===e?this.hideSubmenu():this.showSubmenu(e)}}addItem(e){if(!this.submenuContent)return;const t=Pm(e);this.submenuContent.appendChild(t),t.onclick=()=>{var s;(s=e.click)==null||s.invoke()}}showSubmenu(e){var t,s,n,i;for(this.selectedCategory=e,(s=(t=this.selectedCategory)==null?void 0:t.select)==null||s.invoke(),this.submenuTitle&&(this.submenuTitle.textContent=e.title);(n=this.submenuContent)!=null&&n.firstChild;)this.submenuContent.removeChild(this.submenuContent.firstChild);e.items.forEach(r=>this.addItem(r)),(i=this.submenuRoot)==null||i.classList.remove("close")}hideSubmenu(){var e,t,s,n,i;for((t=(e=this.selectedCategory)==null?void 0:e.deselect)==null||t.invoke(),this.selectedCategory=void 0;(s=this.submenuContent)!=null&&s.firstChild;)(n=this.submenuContent)==null||n.removeChild(this.submenuContent.firstChild);(i=this.submenuRoot)==null||i.classList.add("close")}}Mt([S(Kt)],Dn.prototype,"categories",2);const Vm="https://upload.wikimedia.org/wikipedia/commons/2/21/City_locator_4.svg",Lm=o=>{var t;const e=document.createElement("button");return e.classList.add("room"),e.classList.add("open-submenu"),e.innerHTML=`
        <button class="open-submenu">
            <span class="icon">
                <img src=${((t=o.icon)==null?void 0:t.url)??Vm} alt=${o.title??"?"}>
            </span>
        </button>
    `,e},Pm=o=>{var n;const e=document.createElement("button");e.classList.add("submenu-button");const t=`
        <img src=${(n=o.icon)==null?void 0:n.url} alt=${o.name??"?"}>
    `,s=`
        <a>${o.name}</a>
    `;return o.icon&&(e.innerHTML+=t),e.innerHTML+=s,e},Rm=`
  <div class="mainmenu">
    <!-- Content -->
  </div>

  <div class="submenu-wrapper">
    <h2 class="submenu-title"></h2>
    <div class="submenu">
        <div class="submenu-content">
            <!-- Content -->
        </div>
    </div>
  </div>
`,Im=`
/* @import url('https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@400;600;700;800&display=swap'); */


.mainmenu {
    position: absolute;
    top: 16px;
    right: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 54px;
    height: auto;
    background: rgba(229, 230, 233, 0.8);
    border-radius: 27px;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    box-shadow: 0 0 4px rgba(2, 2, 43, 0.2);
    z-index: 1;
    padding-top: 6px;

    /* default font settings */
    font-size: 1rem;
    font-family: 'Roboto Flex', sans-serif;
    /* font-optical-sizing: auto; */
    /* font-variation-settings: "width" 100; */
    color: rgb(40, 40, 40);
}

.mainmenu button {
    width: 42px;
    height: 42px;
    border: none;
    border-radius: 50%;
    margin-bottom: 4px;
    background: transparent;
    transition: background-color 0.5s;
    outline: rgba(0, 0, 0, 0) 1px solid;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
}

.mainmenu button.active,
.mainmenu button:hover {
    background: rgba(245, 245, 245, .8);
    transition: all 0.1s linear .02s;
    outline: rgba(0, 0, 0, .05) 1px solid;
}

.mainmenu button.active img,
.mainmenu button:hover img
{
    /* filter: invert(100%) sepia(0%) saturate(7478%) hue-rotate(317deg) brightness(109%) contrast(99%); */
}

.mainmenu button img {
    width: 32px;
    height: 32px;
}

.mainmenu button .state-icon {
    position: absolute;
    top: 9px;
    left: 11px;
    width: 32px; 
    height: 32px; 
    background-size: cover;
    background-repeat: no-repeat;
    pointer-events: none; 
    filter: invert(61%) sepia(85%) saturate(1169%) hue-rotate(92deg) brightness(92%) contrast(86%);
}

.mainmenu button.active .state-icon,
.mainmenu button:hover .state-icon
{
    filter: invert(61%) sepia(85%) saturate(1169%) hue-rotate(92deg) brightness(92%) contrast(86%);
}

/*Submenu*/
.submenu-wrapper {
    position: absolute;
    top: 16px;
    right: calc(70px + 10px);
    width: 333px;
    max-height: 60vh;
    padding: 22px;
    z-index: 1;

    background: #ffffff5c;
    border: 1px solid rgba(255, 255, 255, .1);
    border-radius: 1.1999rem;
    outline: rgb(0 0 0 / 5%) 1px solid;
    box-shadow: 0px 7px 0.5rem 0px rgb(0 0 0 / 6%), inset 0px 0px 1.3rem rgba(0, 0, 0, .05);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);

    overflow: hidden;
}

.submenu {
    overflow-x: hidden;
    overflow-y: scroll;
    max-height: calc(60vh - 22px * 2);
    font-family: 'Roboto Flex', sans-serif;
}

/* width */
.submenu::-webkit-scrollbar {
    scrollbar-color: #ff0000;
    width: 5px;
}

/* Track */
.submenu::-webkit-scrollbar-track {
    background: #8880;
    margin-right: 20px;
}

/* Handle */
.submenu::-webkit-scrollbar-thumb {
    background: #8888;
    border-radius: 10px; /* Rounded corners */
    margin: 0 8px; /* Offset the track to move the thumb left */
}

/* Handle on hover */
.submenu::-webkit-scrollbar-thumb:hover {
    background: #555A;
}

.submenu-title {
    color: #282828;
    font-size: 22px;
    font-weight: 800;
    line-height: 32px;
    margin-bottom: 16px;
    margin-top: 0px;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    border-bottom: 1px solid rgba(40, 40, 40, .4);
}

.submenu-button {
    height: 1.8rem;
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 1rem;
    line-height: 32px;
    border: none;
    cursor: pointer;
    font-family: 'Roboto Flex', sans-serif;
    font-weight: 200;
    width: 100%;
    
    background: transparent;
    outline: rgba(0, 0, 0, 0) 1px solid;
    border-radius: 0.8rem;
}

.submenu-button:hover { 
    background: rgba(245, 245, 245, .8);
    transition: all 0.1s linear .02s;
    outline: rgba(0, 0, 0, .05) 1px solid;
}

.submenu-button img {
    width: 32px;
    height: 32px;
    margin-right: 6px;
    margin-left: -6px;
}

.submenu-button a {
    color: #282828;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
}

.submenu-content img {
    max-width: 100%;
    height: auto;
    margin-right: 6px;
}

.special {
    display: flex;
    align-items: center;
    margin-top: 16px;
    font-size: 13px;
    line-height: 20px;
    color: #919191;
    border: none;
    background: none;
}

.special img {
    width: 16px;
    height: 16px;
    filter: invert(61%) sepia(85%) saturate(1169%) hue-rotate(92deg) brightness(92%) contrast(86%);
}

.submenu-wrapper.close {
    display: none;
}

@media screen and (max-width: 768px) {
    .mainmenu {
        width: 42px;
        height: auto;
        padding-bottom: 2px;
    }

    .mainmenu button {
        width: 32px;
        height: 32px;
    }

    .mainmenu button img {
        width: 24px;
        height: 24px;
    }

    .mainmenu button .state-icon {
        position: absolute;
        top: 9px;
        left: 9px;
        width: 24px; 
        height: 24px; 
    }

    .submenu-wrapper {
        right: calc(60px + 5px);
        width: 256px;
        border-radius: 21px;
        padding: 16px;
        max-height: 40vh;
    }

    .submenu {
        max-height: calc(40vh - 16px * 2);
    }

    .submenu-title {
        font-size: 18px;
        line-height: 28px;
        margin-bottom: 10px;
    }

    .submenu-button {
        margin-bottom: 6px;
        /* font-size: 1.3rem; */
        line-height: 24px;
    }

    .submenu-button img {
        width: 24px;
        height: 24px;
    }

    .special {
        margin-top: 10px;
        font-size: 11px;
    }

    .special img {
        width: 10px;
        height: 10px;
    }
}`;var Dm=Object.defineProperty,Fm=Object.getOwnPropertyDescriptor,gs=(o,e,t,s)=>{for(var n=s>1?void 0:s?Fm(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Dm(e,t,n),n};class hi{}gs([S(Dr)],hi.prototype,"button",2);gs([S(Ws)],hi.prototype,"label",2);class Js extends R{constructor(){super(...arguments),this.categoryName="",this.data=[]}awake(){var t;this.galleryUI??(this.galleryUI=_u(Dn));const e=(t=this.galleryUI)==null?void 0:t.categories.find(s=>s.title===this.categoryName);e&&this.data.forEach(s=>{var i,r;const n=new fs;n.name=((i=s.label)==null?void 0:i.text)||"",n.icon=this.icon,n.click=new Te,(r=n.click)==null||r.addEventListener(()=>{var a,c;(c=(a=s.button)==null?void 0:a.onClick)==null||c.invoke()}),e.items.push(n)})}}gs([S(Dn)],Js.prototype,"galleryUI",2);gs([S()],Js.prototype,"categoryName",2);gs([S(Zo)],Js.prototype,"icon",2);gs([S(hi)],Js.prototype,"data",2);const Ji={VERTEX:"vertex",FRAGMENT:"fragment"},H={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},Os=["fragment","vertex"],er=["setup","analyze","generate"],zm=[...Os,"compute"],Fn=["x","y","z","w"];function Ia(o){let e="{";o.isNode===!0&&(e+=o.id);for(const{property:t,childNode:s}of pn(o))e+=","+t.slice(0,-4)+":"+s.getCacheKey();return e+="}",e}function*pn(o,e=!1){for(const t in o){if(t.startsWith("_")===!0)continue;const s=o[t];if(Array.isArray(s)===!0)for(let n=0;n<s.length;n++){const i=s[n];i&&(i.isNode===!0||e&&typeof i.toJSON=="function")&&(yield{property:t,index:n,childNode:i})}else if(s&&s.isNode===!0)yield{property:t,childNode:s};else if(typeof s=="object")for(const n in s){const i=s[n];i&&(i.isNode===!0||e&&typeof i.toJSON=="function")&&(yield{property:t,index:n,childNode:i})}}}function Vt(o){if(o==null)return null;const e=typeof o;return o.isNode===!0?"node":e==="number"?"float":e==="boolean"?"bool":e==="string"?"string":e==="function"?"shader":o.isVector2===!0?"vec2":o.isVector3===!0?"vec3":o.isVector4===!0?"vec4":o.isMatrix3===!0?"mat3":o.isMatrix4===!0?"mat4":o.isColor===!0?"color":o instanceof ArrayBuffer?"ArrayBuffer":null}function Da(o,...e){const t=o?o.slice(-4):void 0;return e.length===1&&(t==="vec2"?e=[e[0],e[0]]:t==="vec3"?e=[e[0],e[0],e[0]]:t==="vec4"&&(e=[e[0],e[0],e[0],e[0]])),o==="color"?new Je(...e):t==="vec2"?new oe(...e):t==="vec3"?new J(...e):t==="vec4"?new it(...e):t==="mat3"?new Zr(...e):t==="mat4"?new hs(...e):o==="bool"?e[0]||!1:o==="float"||o==="int"||o==="uint"?e[0]||0:o==="string"?e[0]||"":o==="ArrayBuffer"?za(e[0]):null}function Fa(o){let e="";const t=new Uint8Array(o);for(let s=0;s<t.length;s++)e+=String.fromCharCode(t[s]);return btoa(e)}function za(o){return Uint8Array.from(atob(o),e=>e.charCodeAt(0)).buffer}const tr=new Map;let jm=0;class D extends Qr{constructor(e=null){super(),this.nodeType=e,this.updateType=H.NONE,this.updateBeforeType=H.NONE,this.uuid=Xr.generateUUID(),this.isNode=!0,Object.defineProperty(this,"id",{value:jm++})}get type(){return this.constructor.type}getSelf(){return this.self||this}setReference(){return this}isGlobal(){return!1}*getChildren(){for(const{childNode:e}of pn(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}getCacheKey(){return Ia(this)}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){const t=e.getNodeProperties(this);for(const s of this.getChildren())t["_node"+s.id]=s;return null}construct(e){return console.warn("THREE.Node: construct() is deprecated. Use setup() instead."),this.setup(e)}increaseUsage(e){const t=e.getDataFromNode(this);return t.usageCount=t.usageCount===void 0?1:t.usageCount+1,t.usageCount}analyze(e){if(this.increaseUsage(e)===1){const s=e.getNodeProperties(this);for(const n of Object.values(s))n&&n.isNode===!0&&n.build(e)}}generate(e,t){const{outputNode:s}=e.getNodeProperties(this);if(s&&s.isNode===!0)return s.build(e,t)}updateBefore(){console.warn("Abstract function.")}update(){console.warn("Abstract function.")}build(e,t=null){const s=this.getShared(e);if(this!==s)return s.build(e,t);e.addNode(this),e.addChain(this);let n=null;const i=e.getBuildStage();if(i==="setup"){this.setReference(e);const r=e.getNodeProperties(this);if(r.initialized!==!0||e.context.tempRead===!1){const a=e.stack.nodes.length;r.initialized=!0,r.outputNode=this.setup(e),r.outputNode!==null&&e.stack.nodes.length!==a&&(r.outputNode=e.stack);for(const c of Object.values(r))c&&c.isNode===!0&&c.build(e)}}else if(i==="analyze")this.analyze(e);else if(i==="generate")if(this.generate.length===1){const a=this.getNodeType(e),c=e.getDataFromNode(this);n=c.snippet,n===void 0&&(n=this.generate(e)||"",c.snippet=n),n=e.format(n,a,t)}else n=this.generate(e,t)||"";return e.removeChain(this),n}getSerializeChildren(){return pn(this)}serialize(e){const t=this.getSerializeChildren(),s={};for(const{property:n,index:i,childNode:r}of t)i!==void 0?(s[n]===void 0&&(s[n]=Number.isInteger(i)?[]:{}),s[n][i]=r.toJSON(e.meta).uuid):s[n]=r.toJSON(e.meta).uuid;Object.keys(s).length>0&&(e.inputNodes=s)}deserialize(e){if(e.inputNodes!==void 0){const t=e.meta.nodes;for(const s in e.inputNodes)if(Array.isArray(e.inputNodes[s])){const n=[];for(const i of e.inputNodes[s])n.push(t[i]);this[s]=n}else if(typeof e.inputNodes[s]=="object"){const n={};for(const i in e.inputNodes[s]){const r=e.inputNodes[s][i];n[i]=t[r]}this[s]=n}else{const n=e.inputNodes[s];this[s]=t[n]}}}toJSON(e){const{uuid:t,type:s}=this,n=e===void 0||typeof e=="string";n&&(e={textures:{},images:{},nodes:{}});let i=e.nodes[t];i===void 0&&(i={uuid:t,type:s,meta:e,metadata:{version:4.6,type:"Node",generator:"Node.toJSON"}},n!==!0&&(e.nodes[i.uuid]=i),this.serialize(i),delete i.meta);function r(a){const c=[];for(const l in a){const d=a[l];delete d.metadata,c.push(d)}return c}if(n){const a=r(e.textures),c=r(e.images),l=r(e.nodes);a.length>0&&(i.textures=a),c.length>0&&(i.images=c),l.length>0&&(i.nodes=l)}return i}}function b(o,e){if(typeof e!="function"||!o)throw new Error(`Node class ${o} is not a class`);if(tr.has(o)){console.warn(`Redefinition of node class ${o}`);return}tr.set(o,e),e.type=o}class se extends D{constructor(e){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if(e.getBuildStage()==="generate"){const n=e.getVectorType(this.getNodeType(e,t)),i=e.getDataFromNode(this);if(e.context.tempRead!==!1&&i.propertyName!==void 0)return e.format(i.propertyName,n,t);if(e.context.tempWrite!==!1&&n!=="void"&&t!=="void"&&this.hasDependencies(e)){const r=super.build(e,n),a=e.getVarFromNode(this,null,n),c=e.getPropertyName(a);return e.addLineFlowCode(`${c} = ${r}`),i.snippet=r,i.propertyName=c,e.format(i.propertyName,n,t)}}return super.build(e,t)}}b("TempNode",se);class xs extends D{constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getNodeType(e)}generate(e){const t=this.node.build(e),s=this.indexNode.build(e,"uint");return`${t}[ ${s} ]`}}b("ArrayElementNode",xs);class pi extends D{constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let s=null;for(const n of this.convertTo.split("|"))(s===null||e.getTypeLength(t)===e.getTypeLength(n))&&(s=n);return s}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const s=this.node,n=this.getNodeType(e),i=s.build(e,n);return e.format(i,n,t)}}b("ConvertNode",pi);class ja extends se{constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return this.nodeType!==null?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce((t,s)=>t+e.getTypeLength(s.getNodeType(e)),0))}generate(e,t){const s=this.getNodeType(e),n=this.nodes,i=e.getComponentType(s),r=[];for(const c of n){let l=c.build(e);const d=e.getComponentType(c.getNodeType(e));d!==i&&(l=e.format(l,d,i)),r.push(l)}const a=`${e.getType(s)}( ${r.join(", ")} )`;return e.format(a,s,t)}}b("JoinNode",ja);const $m=Fn.join("");class Eo extends D{constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max(Fn.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}generate(e,t){const s=this.node,n=e.getTypeLength(s.getNodeType(e));let i=null;if(n>1){let r=null;this.getVectorLength()>=n&&(r=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));const c=s.build(e,r);this.components.length===n&&this.components===$m.slice(0,this.components.length)?i=e.format(c,r,t):i=e.format(`${c}.${this.components}`,this.getNodeType(e),t)}else i=s.build(e,t);return i}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}b("SplitNode",Eo);class $a extends se{constructor(e,t,s){super(),this.sourceNode=e,this.components=t,this.targetNode=s}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:s,targetNode:n}=this,i=this.getNodeType(e),r=e.getTypeFromLength(s.length),a=n.build(e,r),c=t.build(e,i),l=e.getTypeLength(i),d=[];for(let u=0;u<l;u++){const m=Fn[u];m===s[0]?(d.push(a),u+=s.length-1):d.push(c+"."+m)}return`${e.getType(i)}( ${d.join(", ")} )`}}b("SetNode",$a);class zn extends D{constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return this.nodeType===null?Vt(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=Vt(this.value),e.nodeType=this.nodeType,e.valueType==="ArrayBuffer"&&(e.value=Fa(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?Da(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn("Abstract function.")}}b("InputNode",zn);class tt extends zn{constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){const s=this.getNodeType(e);return e.format(this.generateConst(e),s,t)}}b("ConstNode",tt);let ds=null;const ts=new Map;function g(o,e){if(ts.has(o)){console.warn(`Redefinition of node element ${o}`);return}if(typeof e!="function")throw new Error(`Node element ${o} is not a function`);ts.set(o,e)}const sr=o=>o.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),Ua={setup(o,e){const t=e.shift();return o(Un(t),...e)},get(o,e,t){if(typeof e=="string"&&o[e]===void 0){if(o.isStackNode!==!0&&e==="assign")return(...s)=>(ds.assign(t,...s),t);if(ts.has(e)){const s=ts.get(e);return o.isStackNode?(...n)=>t.add(s(...n)):(...n)=>s(t,...n)}else{if(e==="self")return o;if(e.endsWith("Assign")&&ts.has(e.slice(0,e.length-6))){const s=ts.get(e.slice(0,e.length-6));return o.isStackNode?(...n)=>t.assign(n[0],s(...n)):(...n)=>t.assign(s(t,...n))}else{if(/^[xyzwrgbastpq]{1,4}$/.test(e)===!0)return e=sr(e),A(new Eo(t,e));if(/^set[XYZWRGBASTPQ]{1,4}$/.test(e)===!0)return e=sr(e.slice(3).toLowerCase()),e=e.split("").sort().join(""),s=>A(new $a(o,e,s));if(e==="width"||e==="height"||e==="depth")return e==="width"?e="x":e==="height"?e="y":e==="depth"&&(e="z"),A(new Eo(o,e));if(/^\d+$/.test(e)===!0)return A(new xs(t,new tt(Number(e),"uint")))}}}return Reflect.get(o,e,t)},set(o,e,t,s){return typeof e=="string"&&o[e]===void 0&&(/^[xyzwrgbastpq]{1,4}$/.test(e)===!0||e==="width"||e==="height"||e==="depth"||/^\d+$/.test(e)===!0)?(s[e].assign(t),!0):Reflect.set(o,e,t,s)}},ao=new WeakMap,nr=new WeakMap,Um=function(o,e=null){const t=Vt(o);if(t==="node"){let s=ao.get(o);return s===void 0&&(s=new Proxy(o,Ua),ao.set(o,s),ao.set(s,s)),s}else{if(e===null&&(t==="float"||t==="boolean")||t&&t!=="shader"&&t!=="string")return A(Ao(o,e));if(t==="shader")return _(o)}return o},Wm=function(o,e=null){for(const t in o)o[t]=A(o[t],e);return o},Gm=function(o,e=null){const t=o.length;for(let s=0;s<t;s++)o[s]=A(o[s],e);return o},Hm=function(o,e=null,t=null,s=null){const n=i=>A(s!==null?Object.assign(i,s):i);return e===null?(...i)=>n(new o(...rs(i))):t!==null?(t=A(t),(...i)=>n(new o(e,...rs(i),t))):(...i)=>n(new o(e,...rs(i)))},km=function(o,...e){return A(new o(...rs(e)))};class Bm extends D{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t}getNodeType(e){const{outputNode:t}=e.getNodeProperties(this);return t?t.getNodeType(e):super.getNodeType(e)}call(e){const{shaderNode:t,inputNodes:s}=this;if(t.layout){let r=nr.get(e.constructor);r===void 0&&(r=new WeakMap,nr.set(e.constructor,r));let a=r.get(t);return a===void 0&&(a=A(e.buildFunctionNode(t)),r.set(t,a)),e.currentFunctionNode!==null&&e.currentFunctionNode.includes.push(a),A(a.call(s))}const n=t.jsFunc,i=s!==null?n(s,e.stack,e):n(e.stack,e);return A(i)}setup(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}generate(e,t){const{outputNode:s}=e.getNodeProperties(this);return s===null?this.call(e).build(e,t):super.generate(e,t)}}class qm extends D{constructor(e){super(),this.jsFunc=e,this.layout=null}get isArrayInput(){return/^\((\s+)?\[/.test(this.jsFunc.toString())}setLayout(e){return this.layout=e,this}call(e=null){return Un(e),A(new Bm(this,e))}setup(){return this.call()}}const Ym=[!1,!0],Km=[0,1,2,3],Zm=[-1,-2],Wa=[.5,1.5,1/3,1e-6,1e6,Math.PI,Math.PI*2,1/Math.PI,2/Math.PI,1/(Math.PI*2),Math.PI/2],mi=new Map;for(const o of Ym)mi.set(o,new tt(o));const fi=new Map;for(const o of Km)fi.set(o,new tt(o,"uint"));const gi=new Map([...fi].map(o=>new tt(o.value,"int")));for(const o of Zm)gi.set(o,new tt(o,"int"));const jn=new Map([...gi].map(o=>new tt(o.value)));for(const o of Wa)jn.set(o,new tt(o));for(const o of Wa)jn.set(-o,new tt(-o));const $n={bool:mi,uint:fi,ints:gi,float:jn},or=new Map([...mi,...jn]),Ao=(o,e)=>or.has(o)?or.get(o):o.isNode===!0?o:new tt(o,e),Qm=o=>{try{return o.getNodeType()}catch{return}},Y=function(o,e=null){return(...t)=>{if((t.length===0||!["bool","float","int","uint"].includes(o)&&t.every(n=>typeof n!="object"))&&(t=[Da(o,...t)]),t.length===1&&e!==null&&e.has(t[0]))return A(e.get(t[0]));if(t.length===1){const n=Ao(t[0],o);return Qm(n)===o?A(n):A(new pi(n,o))}const s=t.map(n=>Ao(n));return A(new ja(s,o))}},Xm=o=>o!=null?o.nodeType||o.convertTo||(typeof o=="string"?o:null):null;function Es(o){return new Proxy(new qm(o),Ua)}const A=(o,e=null)=>Um(o,e),Un=(o,e=null)=>new Wm(o,e),rs=(o,e=null)=>new Gm(o,e),y=(...o)=>new Hm(...o),C=(...o)=>new km(...o),_=o=>{const e=new Es(o),t=(...s)=>{let n;return Un(s),s[0]&&s[0].isNode?n=[...s]:n=s[0],e.call(n)};return t.shaderNode=e,t.setLayout=s=>(e.setLayout(s),t),t};b("ShaderNode",Es);const mn=o=>{ds=o},Ga=()=>ds,ee=(...o)=>ds.if(...o);function Jm(o){return ds&&ds.add(o),o}g("append",Jm);const Vo=new Y("color"),h=new Y("float",$n.float),p=new Y("int",$n.int),E=new Y("uint",$n.uint),It=new Y("bool",$n.bool),j=new Y("vec2"),Ha=new Y("ivec2"),ef=new Y("uvec2"),tf=new Y("bvec2"),x=new Y("vec3"),sf=new Y("ivec3"),en=new Y("uvec3"),ka=new Y("bvec3"),I=new Y("vec4"),nf=new Y("ivec4"),of=new Y("uvec4"),rf=new Y("bvec4"),Ba=new Y("mat2"),af=new Y("imat2"),cf=new Y("umat2"),lf=new Y("bmat2"),ht=new Y("mat3"),df=new Y("imat3"),uf=new Y("umat3"),hf=new Y("bmat3"),As=new Y("mat4"),pf=new Y("imat4"),mf=new Y("umat4"),ff=new Y("bmat4"),gf=(o="")=>A(new tt(o,"string")),xf=o=>A(new tt(o,"ArrayBuffer"));g("color",Vo);g("float",h);g("int",p);g("uint",E);g("bool",It);g("vec2",j);g("ivec2",Ha);g("uvec2",ef);g("bvec2",tf);g("vec3",x);g("ivec3",sf);g("uvec3",en);g("bvec3",ka);g("vec4",I);g("ivec4",nf);g("uvec4",of);g("bvec4",rf);g("mat2",Ba);g("imat2",af);g("umat2",cf);g("bmat2",lf);g("mat3",ht);g("imat3",df);g("umat3",uf);g("bmat3",hf);g("mat4",As);g("imat4",pf);g("umat4",mf);g("bmat4",ff);g("string",gf);g("arrayBuffer",xf);const yf=y(xs),Nf=(o,e)=>A(new pi(A(o),e));g("element",yf);g("convert",Nf);class qa extends se{constructor(e,t){super(),this.targetNode=e,this.sourceNode=t}hasDependencies(){return!1}getNodeType(e,t){return t!=="void"?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){const{targetNode:t}=this;if(e.isAvailable("swizzleAssign")===!1&&t.isSplitNode&&t.components.length>1){const s=e.getTypeLength(t.node.getNodeType(e));return Fn.join("").slice(0,s)!==t.components}return!1}generate(e,t){const{targetNode:s,sourceNode:n}=this,i=this.needsSplitAssign(e),r=s.getNodeType(e),a=s.context({assign:!0}).build(e),c=n.build(e,r),l=n.getNodeType(e),d=e.getDataFromNode(this);let u;if(d.initialized===!0)t!=="void"&&(u=a);else if(i){const m=e.getVarFromNode(this,null,r),w=e.getPropertyName(m);e.addLineFlowCode(`${w} = ${c}`);const T=s.node.context({assign:!0}).build(e);for(let N=0;N<s.components.length;N++){const v=s.components[N];e.addLineFlowCode(`${T}.${v} = ${w}[ ${N} ]`)}t!=="void"&&(u=a)}else u=`${a} = ${c}`,(t==="void"||l==="void")&&(e.addLineFlowCode(u),t!=="void"&&(u=a));return d.initialized=!0,e.format(u,r,t)}}const vf=y(qa);b("AssignNode",qa);g("assign",vf);class Ya extends D{constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0}isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{name:t,node:s}=this,n=this.getNodeType(e),i=e.getVaryingFromNode(this,t,n);i.needsInterpolation||(i.needsInterpolation=e.shaderStage==="fragment");const r=e.getPropertyName(i,Ji.VERTEX);return e.flowNodeFromShaderStage(Ji.VERTEX,s,n,r),e.getPropertyName(i)}}const ue=y(Ya);g("varying",ue);b("VaryingNode",Ya);class Wn extends D{constructor(e,t=null){super(t),this._attributeName=e}isGlobal(){return!0}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=super.getNodeType(e);if(t===null){const s=this.getAttributeName(e);if(e.hasGeometryAttribute(s)){const n=e.geometry.getAttribute(s);t=e.getTypeFromAttribute(n)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),s=this.getNodeType(e);if(e.hasGeometryAttribute(t)===!0){const i=e.geometry.getAttribute(t),r=e.getTypeFromAttribute(i),a=e.getAttribute(t,r);return e.shaderStage==="vertex"?e.format(a.name,r,s):ue(this).build(e,s)}else return console.warn(`AttributeNode: Vertex attribute "${t}" not found on geometry.`),e.generateConst(s)}}const Pe=(o,e)=>A(new Wn(o,e));b("AttributeNode",Wn);class Ka extends D{constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){const t=this.callNode.build(e,"void");return t!==""&&e.addLineFlowCode(t),this.outputNode.build(e)}}const Za=y(Ka);g("bypass",Za);b("BypassNode",Ka);let wf=0;class Qa{constructor(){this.id=wf++,this.nodesData=new WeakMap}getNodeData(e){return this.nodesData.get(e)}setNodeData(e,t){this.nodesData.set(e,t)}}class Xa extends D{constructor(e,t=new Qa){super(),this.isCacheNode=!0,this.node=e,this.cache=t}getNodeType(e){return this.node.getNodeType(e)}build(e,...t){const s=e.getCache(),n=this.cache||e.globalCache;e.setCache(n);const i=this.node.build(e,...t);return e.setCache(s),i}}const fn=y(Xa),Tf=o=>fn(o,null);g("cache",fn);g("globalCache",Tf);b("CacheNode",Xa);class xi extends D{constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.context=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){const t=e.getContext();e.setContext({...e.context,...this.context});const s=this.node.build(e);return e.setContext(t),s}generate(e,t){const s=e.getContext();e.setContext({...e.context,...this.context});const n=this.node.build(e,t);return e.setContext(s),n}}const bt=y(xi),bf=(o,e)=>bt(o,{label:e});g("context",bt);g("label",bf);b("ContextNode",xi);class pt extends D{constructor(e){super("uint"),this.scope=e,this.isInstanceIndexNode=!0}generate(e){const t=this.getNodeType(e),s=this.scope;let n;if(s===pt.VERTEX)n=e.getVertexIndex();else if(s===pt.INSTANCE)n=e.getInstanceIndex();else throw new Error("THREE.IndexNode: Unknown scope: "+s);let i;return e.shaderStage==="vertex"||e.shaderStage==="compute"?i=n:i=ue(this).build(e,t),i}}pt.VERTEX="vertex";pt.INSTANCE="instance";const _f=C(pt,pt.VERTEX),Sf=C(pt,pt.INSTANCE);b("IndexNode",pt);class Ja{start(){}finish(){}direct(){}indirectDiffuse(){}indirectSpecular(){}ambientOcclusion(){}}class ec extends D{constructor(e,t=null){super(),this.node=e,this.name=t,this.isVarNode=!0}isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{node:t,name:s}=this,n=e.getVarFromNode(this,s,e.getVectorType(this.getNodeType(e))),i=e.getPropertyName(n),r=t.build(e,n.type);return e.addLineFlowCode(`${i} = ${r}`),i}}const Is=y(ec);g("temp",Is);g("toVar",(...o)=>Is(...o).append());b("VarNode",ec);class ir{constructor(e,t,s=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=s}}class Cf{constructor(e,t,s,n=void 0){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=s.getSelf(),this.needsUpdate=n}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}}class tc{constructor(e,t){this.isNodeVar=!0,this.name=e,this.type=t}}class Mf extends tc{constructor(e,t){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0}}class Of{constructor(e,t,s=""){this.name=e,this.type=t,this.code=s,Object.defineProperty(this,"isNodeCode",{value:!0})}}class Ef{constructor(){this.keywords=[],this.nodes=[],this.keywordsCallback={}}getNode(e){let t=this.nodes[e];return t===void 0&&this.keywordsCallback[e]!==void 0&&(t=this.keywordsCallback[e](e),this.nodes[e]=t),t}addKeyword(e,t){return this.keywords.push(e),this.keywordsCallback[e]=t,this}parse(e){const t=this.keywords,s=new RegExp(`\\b${t.join("\\b|\\b")}\\b`,"g"),n=e.match(s),i=[];if(n!==null)for(const r of n){const a=this.getNode(r);a!==void 0&&i.indexOf(a)===-1&&i.push(a)}return i}include(e,t){const s=this.parse(t);for(const n of s)n.build(e)}}class ye extends D{constructor(e,t=null,s=!1){super(e),this.name=t,this.varying=s,this.isPropertyNode=!0}getHash(e){return this.name||super.getHash(e)}isGlobal(){return!0}generate(e){let t;return this.varying===!0?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}}const Me=(o,e)=>A(new ye(o,e)),Ot=(o,e)=>A(new ye(o,e,!0)),Se=C(ye,"vec4","DiffuseColor"),Vs=C(ye,"float","Roughness"),Af=C(ye,"float","Metalness"),Lo=C(ye,"float","Clearcoat"),gn=C(ye,"float","ClearcoatRoughness"),ss=C(ye,"vec3","Sheen"),yi=C(ye,"float","SheenRoughness"),Ni=C(ye,"float","Iridescence"),sc=C(ye,"float","IridescenceIOR"),nc=C(ye,"float","IridescenceThickness"),vt=C(ye,"color","SpecularColor"),Po=C(ye,"float","Shininess"),Vf=C(ye,"vec4","Output"),as=C(ye,"float","dashSize"),xn=C(ye,"float","gapSize");C(ye,"float","pointWidth");b("PropertyNode",ye);class Ro extends ye{constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}b("ParameterNode",Ro);class vi extends D{constructor(e="",t=[],s=""){super("code"),this.isCodeNode=!0,this.code=e,this.language=s,this.includes=t}isGlobal(){return!0}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){const t=this.getIncludes(e);for(const n of t)n.build(e);const s=e.getCodeFromNode(this,this.getNodeType(e));return s.code=this.code,s.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}}y(vi);b("CodeNode",vi);class oc extends vi{constructor(e="",t=[],s=""){super(e,t,s),this.keywords={}}getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){const t=e.getDataFromNode(this);let s=t.nodeFunction;return s===void 0&&(s=e.parser.parseFunction(this.code),t.nodeFunction=s),s}generate(e,t){super.generate(e);const s=this.getNodeFunction(e),n=s.name,i=s.type,r=e.getCodeFromNode(this,i);n!==""&&(r.name=n);const a=e.getPropertyName(r);let c=this.getNodeFunction(e).getCode(a);const l=this.keywords,d=Object.keys(l);if(d.length>0)for(const u of d){const m=new RegExp(`\\b${u}\\b`,"g"),w=l[u].build(e,"property");c=c.replace(m,w)}return r.code=c+`
`,t==="property"?a:e.format(`${a}()`,i,t)}}b("FunctionNode",oc);class wi extends D{constructor(e,t=!1){super("string"),this.name=e,this.version=0,this.shared=t,this.isUniformGroup=!0}set needsUpdate(e){e===!0&&this.version++}}const Lf=o=>new wi(o),ic=o=>new wi(o,!0);ic("frame");ic("render");const Pf=Lf("object");b("UniformGroupNode",wi);class Zt extends zn{constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.groupNode=Pf}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}generate(e,t){const s=this.getNodeType(e),n=this.getUniformHash(e);let i=e.getNodeFromHash(n);i===void 0&&(e.setHashNode(this,n),i=this);const r=i.getInputType(e),a=e.getUniformFromNode(i,r,e.shaderStage,e.context.label),c=e.getPropertyName(a);return e.context.label!==void 0&&delete e.context.label,e.format(c,s,t)}}const de=(o,e)=>{const t=Xm(e||o),s=o&&o.isNode===!0?o.node&&o.node.value||o.value:o;return A(new Zt(s,t))};b("UniformNode",Zt);class rc extends Wn{constructor(e=0){super(null,"vec2"),this.isUVNode=!0,this.index=e}getAttributeName(){const e=this.index;return"uv"+(e>0?e:"")}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}const fe=(...o)=>A(new rc(...o));b("UVNode",rc);class ac extends D{constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const s=this.textureNode.build(e,"property"),n=this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${s}, ${n} )`,this.getNodeType(e),t)}}const cc=y(ac);g("textureSize",cc);b("TextureSizeNode",ac);class le extends se{constructor(e,t,s,...n){if(super(),this.op=e,n.length>0){let i=s;for(let r=0;r<n.length;r++)i=new le(e,i,n[r]);s=i}this.aNode=t,this.bNode=s}getNodeType(e,t){const s=this.op,n=this.aNode,i=this.bNode,r=n.getNodeType(e),a=typeof i<"u"?i.getNodeType(e):null;if(r==="void"||a==="void")return"void";if(s==="%")return r;if(s==="~"||s==="&"||s==="|"||s==="^"||s===">>"||s==="<<")return e.getIntegerType(r);if(s==="!"||s==="=="||s==="&&"||s==="||"||s==="^^")return"bool";if(s==="<"||s===">"||s==="<="||s===">="){const c=t?e.getTypeLength(t):Math.max(e.getTypeLength(r),e.getTypeLength(a));return c>1?`bvec${c}`:"bool"}else return r==="float"&&e.isMatrix(a)?a:e.isMatrix(r)&&e.isVector(a)?e.getVectorFromMatrix(r):e.isVector(r)&&e.isMatrix(a)?e.getVectorFromMatrix(a):e.getTypeLength(a)>e.getTypeLength(r)?a:r}generate(e,t){const s=this.op,n=this.aNode,i=this.bNode,r=this.getNodeType(e,t);let a=null,c=null;r!=="void"?(a=n.getNodeType(e),c=typeof i<"u"?i.getNodeType(e):null,s==="<"||s===">"||s==="<="||s===">="||s==="=="?e.isVector(a)?c=a:a=c="float":s===">>"||s==="<<"?(a=r,c=e.changeComponentType(c,"uint")):e.isMatrix(a)&&e.isVector(c)?c=e.getVectorFromMatrix(a):e.isVector(a)&&e.isMatrix(c)?a=e.getVectorFromMatrix(c):a=c=r):a=c=r;const l=n.build(e,a),d=typeof i<"u"?i.build(e,c):null,u=e.getTypeLength(t),m=e.getFunctionOperator(s);if(t!=="void")return s==="<"&&u>1?e.format(`${e.getMethod("lessThan")}( ${l}, ${d} )`,r,t):s==="<="&&u>1?e.format(`${e.getMethod("lessThanEqual")}( ${l}, ${d} )`,r,t):s===">"&&u>1?e.format(`${e.getMethod("greaterThan")}( ${l}, ${d} )`,r,t):s===">="&&u>1?e.format(`${e.getMethod("greaterThanEqual")}( ${l}, ${d} )`,r,t):s==="!"||s==="~"?e.format(`(${s}${l})`,a,t):m?e.format(`${m}( ${l}, ${d} )`,r,t):e.format(`( ${l} ${s} ${d} )`,r,t);if(a!=="void")return m?e.format(`${m}( ${l}, ${d} )`,r,t):e.format(`${l} ${s} ${d}`,r,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}const He=y(le,"+"),he=y(le,"-"),G=y(le,"*"),Bt=y(le,"/"),Rf=y(le,"%"),If=y(le,"=="),Df=y(le,"!="),Ff=y(le,"<"),lc=y(le,">"),zf=y(le,"<="),jf=y(le,">="),$f=y(le,"&&"),Uf=y(le,"||"),Wf=y(le,"!"),Gf=y(le,"^^"),Hf=y(le,"&"),kf=y(le,"~"),Bf=y(le,"|"),qf=y(le,"^"),Yf=y(le,"<<"),Kf=y(le,">>");g("add",He);g("sub",he);g("mul",G);g("div",Bt);g("remainder",Rf);g("equal",If);g("notEqual",Df);g("lessThan",Ff);g("greaterThan",lc);g("lessThanEqual",zf);g("greaterThanEqual",jf);g("and",$f);g("or",Uf);g("not",Wf);g("xor",Gf);g("bitAnd",Hf);g("bitNot",kf);g("bitOr",Bf);g("bitXor",qf);g("shiftLeft",Yf);g("shiftRight",Kf);b("OperatorNode",le);class f extends se{constructor(e,t,s=null,n=null){super(),this.method=e,this.aNode=t,this.bNode=s,this.cNode=n}getInputType(e){const t=this.aNode.getNodeType(e),s=this.bNode?this.bNode.getNodeType(e):null,n=this.cNode?this.cNode.getNodeType(e):null,i=e.isMatrix(t)?0:e.getTypeLength(t),r=e.isMatrix(s)?0:e.getTypeLength(s),a=e.isMatrix(n)?0:e.getTypeLength(n);return i>r&&i>a?t:r>a?s:a>i?n:t}getNodeType(e){const t=this.method;return t===f.LENGTH||t===f.DISTANCE||t===f.DOT?"float":t===f.CROSS?"vec3":t===f.ALL?"bool":t===f.EQUALS?e.changeComponentType(this.aNode.getNodeType(e),"bool"):t===f.MOD?this.aNode.getNodeType(e):this.getInputType(e)}generate(e,t){const s=this.method,n=this.getNodeType(e),i=this.getInputType(e),r=this.aNode,a=this.bNode,c=this.cNode,l=e.renderer.isWebGLRenderer===!0;if(s===f.TRANSFORM_DIRECTION){let d=r,u=a;e.isMatrix(d.getNodeType(e))?u=I(x(u),0):d=I(x(d),0);const m=G(d,u).xyz;return Ke(m).build(e,t)}else{if(s===f.NEGATE)return e.format("( - "+r.build(e,i)+" )",n,t);if(s===f.ONE_MINUS)return he(1,r).build(e,t);if(s===f.RECIPROCAL)return Bt(1,r).build(e,t);if(s===f.DIFFERENCE)return je(he(r,a)).build(e,t);{const d=[];return s===f.CROSS||s===f.MOD?d.push(r.build(e,n),a.build(e,n)):s===f.STEP?d.push(r.build(e,e.getTypeLength(r.getNodeType(e))===1?"float":i),a.build(e,i)):l&&(s===f.MIN||s===f.MAX)||s===f.MOD?d.push(r.build(e,i),a.build(e,e.getTypeLength(a.getNodeType(e))===1?"float":i)):s===f.REFRACT?d.push(r.build(e,i),a.build(e,i),c.build(e,"float")):s===f.MIX?d.push(r.build(e,i),a.build(e,i),c.build(e,e.getTypeLength(c.getNodeType(e))===1?"float":i)):(d.push(r.build(e,i)),a!==null&&d.push(a.build(e,i)),c!==null&&d.push(c.build(e,i))),e.format(`${e.getMethod(s,n)}( ${d.join(", ")} )`,n,t)}}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}f.ALL="all";f.ANY="any";f.EQUALS="equals";f.RADIANS="radians";f.DEGREES="degrees";f.EXP="exp";f.EXP2="exp2";f.LOG="log";f.LOG2="log2";f.SQRT="sqrt";f.INVERSE_SQRT="inversesqrt";f.FLOOR="floor";f.CEIL="ceil";f.NORMALIZE="normalize";f.FRACT="fract";f.SIN="sin";f.COS="cos";f.TAN="tan";f.ASIN="asin";f.ACOS="acos";f.ATAN="atan";f.ABS="abs";f.SIGN="sign";f.LENGTH="length";f.NEGATE="negate";f.ONE_MINUS="oneMinus";f.DFDX="dFdx";f.DFDY="dFdy";f.ROUND="round";f.RECIPROCAL="reciprocal";f.TRUNC="trunc";f.FWIDTH="fwidth";f.BITCAST="bitcast";f.ATAN2="atan2";f.MIN="min";f.MAX="max";f.MOD="mod";f.STEP="step";f.REFLECT="reflect";f.DISTANCE="distance";f.DIFFERENCE="difference";f.DOT="dot";f.CROSS="cross";f.POW="pow";f.TRANSFORM_DIRECTION="transformDirection";f.MIX="mix";f.CLAMP="clamp";f.REFRACT="refract";f.SMOOTHSTEP="smoothstep";f.FACEFORWARD="faceforward";const dc=h(1e-6);h(1e6);const rr=h(Math.PI);h(Math.PI*2);const Zf=y(f,f.ALL),Qf=y(f,f.ANY),Xf=y(f,f.EQUALS),Jf=y(f,f.RADIANS),eg=y(f,f.DEGREES),uc=y(f,f.EXP),tg=y(f,f.EXP2),sg=y(f,f.LOG),hc=y(f,f.LOG2),jt=y(f,f.SQRT),ng=y(f,f.INVERSE_SQRT),ys=y(f,f.FLOOR),Ti=y(f,f.CEIL),Ke=y(f,f.NORMALIZE),bi=y(f,f.FRACT),wt=y(f,f.SIN),At=y(f,f.COS),pc=y(f,f.TAN),mc=y(f,f.ASIN),fc=y(f,f.ACOS),og=y(f,f.ATAN),je=y(f,f.ABS),Gn=y(f,f.SIGN),gc=y(f,f.LENGTH),ig=y(f,f.NEGATE),rg=y(f,f.ONE_MINUS),ag=y(f,f.DFDX),cg=y(f,f.DFDY),xc=y(f,f.ROUND),lg=y(f,f.RECIPROCAL),yc=y(f,f.TRUNC),dg=y(f,f.FWIDTH);y(f,f.BITCAST);const Nc=y(f,f.ATAN2),us=y(f,f.MIN),et=y(f,f.MAX),vc=y(f,f.MOD),ug=y(f,f.STEP),hg=y(f,f.REFLECT),pg=y(f,f.DISTANCE),mg=y(f,f.DIFFERENCE),Qt=y(f,f.DOT),wc=y(f,f.CROSS),st=y(f,f.POW),fg=y(f,f.POW,2),gg=y(f,f.POW,3),xg=y(f,f.POW,4),yg=y(f,f.TRANSFORM_DIRECTION),Ng=o=>G(Gn(o),st(je(o),1/3)),vg=o=>Qt(o,o),Ve=y(f,f.MIX),Ds=(o,e=0,t=1)=>A(new f(f.CLAMP,A(o),A(e),A(t))),wg=o=>Ds(o),Tg=y(f,f.REFRACT),rt=y(f,f.SMOOTHSTEP),bg=y(f,f.FACEFORWARD),_g=(o,e,t)=>Ve(e,t,o),Sg=(o,e,t)=>rt(e,t,o);g("all",Zf);g("any",Qf);g("equals",Xf);g("radians",Jf);g("degrees",eg);g("exp",uc);g("exp2",tg);g("log",sg);g("log2",hc);g("sqrt",jt);g("inverseSqrt",ng);g("floor",ys);g("ceil",Ti);g("normalize",Ke);g("fract",bi);g("sin",wt);g("cos",At);g("tan",pc);g("asin",mc);g("acos",fc);g("atan",og);g("abs",je);g("sign",Gn);g("length",gc);g("lengthSq",vg);g("negate",ig);g("oneMinus",rg);g("dFdx",ag);g("dFdy",cg);g("round",xc);g("reciprocal",lg);g("trunc",yc);g("fwidth",dg);g("atan2",Nc);g("min",us);g("max",et);g("mod",vc);g("step",ug);g("reflect",hg);g("distance",pg);g("dot",Qt);g("cross",wc);g("pow",st);g("pow2",fg);g("pow3",gg);g("pow4",xg);g("transformDirection",yg);g("mix",_g);g("clamp",Ds);g("refract",Tg);g("smoothstep",Sg);g("faceForward",bg);g("difference",mg);g("saturate",wg);g("cbrt",Ng);b("MathNode",f);const Cg=_(o=>{const{value:e}=o,{rgb:t}=e,s=t.mul(.9478672986).add(.0521327014).pow(2.4),n=t.mul(.0773993808),i=t.lessThanEqual(.04045),r=Ve(s,n,i);return I(r,e.a)}),Mg=_(o=>{const{value:e}=o,{rgb:t}=e,s=t.pow(.41666).mul(1.055).sub(.055),n=t.mul(12.92),i=t.lessThanEqual(.0031308),r=Ve(s,n,i);return I(r,e.a)}),ar=o=>{let e=null;return o===Cn?e="Linear":o===Au&&(e="sRGB"),e},Tc=(o,e)=>ar(o)+"To"+ar(e);class ke extends se{constructor(e,t){super("vec4"),this.method=e,this.node=t}setup(){const{method:e,node:t}=this;return e===ke.LINEAR_TO_LINEAR?t:Og[e]({value:t})}}ke.LINEAR_TO_LINEAR="LinearToLinear";ke.LINEAR_TO_sRGB="LinearTosRGB";ke.sRGB_TO_LINEAR="sRGBToLinear";const Og={[ke.LINEAR_TO_sRGB]:Mg,[ke.sRGB_TO_LINEAR]:Cg},Eg=(o,e)=>A(new ke(Tc(Cn,e),A(o))),bc=(o,e)=>A(new ke(Tc(e,Cn),A(o))),Ag=y(ke,ke.LINEAR_TO_sRGB),Vg=y(ke,ke.sRGB_TO_LINEAR);g("linearTosRGB",Ag);g("sRGBToLinear",Vg);g("linearToColorSpace",Eg);g("colorSpaceToLinear",bc);b("ColorSpaceNode",ke);class _c extends D{constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const s=this.getNodeType(e),n=this.snippet;if(s==="void")e.addLineFlowCode(n);else return e.format(`( ${n} )`,s,t)}}const _i=y(_c);b("ExpressionNode",_c);class Sc extends Zt{constructor(e){super(0),this.textureNode=e,this.updateType=H.FRAME}get texture(){return this.textureNode.value}update(){const e=this.texture,t=e.images,s=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(s&&s.width!==void 0){const{width:n,height:i}=s;this.value=Math.log2(Math.max(n,i))}}}const Si=y(Sc);b("MaxMipLevelNode",Sc);class Ns extends Zt{constructor(e,t=null,s=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=s,this.compareNode=null,this.depthNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=H.NONE,this.setUpdateMatrix(t===null)}getUniformHash(){return this.value.uuid}getNodeType(){return this.value.isDepthTexture===!0?"float":"vec4"}getInputType(){return"texture"}getDefaultUV(){return fe(this.value.channel)}setReference(){return this.value}getTransformedUV(e){const t=this.value;return de(t.matrix).mul(x(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?H.FRAME:H.NONE,this}setupUV(e,t){const s=this.value;return e.isFlipY()&&(s.isRenderTargetTexture===!0||s.isFramebufferTexture===!0||s.isDepthTexture===!0)&&(t=t.setY(t.y.oneMinus())),t}setup(e){const t=e.getNodeProperties(this);let s=this.uvNode;(s===null||e.context.forceUVContext===!0)&&e.context.getUV&&(s=e.context.getUV(this)),s||(s=this.getDefaultUV()),this.updateMatrix===!0&&(s=this.getTransformedUV(s)),s=this.setupUV(e,s);let n=this.levelNode;n===null&&e.context.getTextureLevel&&(n=e.context.getTextureLevel(this)),n!==null&&e.context.getTextureLevelAlgorithm!==void 0&&(n=e.context.getTextureLevelAlgorithm(this,n)),t.uvNode=s,t.levelNode=n,t.compareNode=this.compareNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,this.sampler===!0?"vec2":"ivec2")}generateSnippet(e,t,s,n,i,r){const a=this.value;let c;return n?c=e.generateTextureLevel(a,t,s,n,i):r?c=e.generateTextureCompare(a,t,s,r,i):this.sampler===!1?c=e.generateTextureLoad(a,t,s,i):c=e.generateTexture(a,t,s,i),c}generate(e,t){const s=e.getNodeProperties(this),n=this.value;if(!n||n.isTexture!==!0)throw new Error("TextureNode: Need a three.js texture.");const i=super.generate(e,"property");if(t==="sampler")return i+"_sampler";if(e.isReference(t))return i;{const r=e.getDataFromNode(this);let a=r.propertyName;if(a===void 0){const{uvNode:d,levelNode:u,compareNode:m,depthNode:w}=s,T=this.generateUV(e,d),N=u?u.build(e,"float"):null,v=w?w.build(e,"int"):null,O=m?m.build(e,"float"):null,P=e.getVarFromNode(this);a=e.getPropertyName(P);const L=this.generateSnippet(e,i,T,N,v,O);e.addLineFlowCode(`${a} = ${L}`),e.context.tempWrite!==!1&&(r.snippet=L,r.propertyName=a)}let c=a;const l=this.getNodeType(e);return e.needsColorSpaceToLinear(n)&&(c=bc(_i(c,l),n.colorSpace).setup(e).build(e,l)),e.format(c,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){const t=this.clone();return t.uvNode=e,A(t)}blur(e){const t=this.clone();return t.levelNode=e.mul(Si(t)),A(t)}level(e){const t=this.clone();return t.levelNode=e,t}size(e){return cc(this,e)}compare(e){const t=this.clone();return t.compareNode=A(e),A(t)}depth(e){const t=this.clone();return t.depthNode=A(e),A(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value]}update(){const e=this.value;e.matrixAutoUpdate===!0&&e.updateMatrix()}clone(){const e=new this.constructor(this.value,this.uvNode,this.levelNode);return e.sampler=this.sampler,e}}const Re=y(Ns),Lg=(...o)=>Re(...o).setSampler(!1);g("texture",Re);b("TextureNode",Ns);class Hn extends Zt{constructor(e,t,s=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=s}getInputType(){return"buffer"}}const Ci=(o,e,t)=>A(new Hn(o,e,t));b("BufferNode",Hn);class Pg extends xs{constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){const t=super.generate(e),s=this.getNodeType();return e.format(t,"vec4",s)}}class Cc extends Hn{constructor(e,t=null){super(null,"vec4"),this.array=e,this.elementType=t,this._elementType=null,this._elementLength=0,this.updateType=H.RENDER,this.isArrayBufferNode=!0}getElementType(){return this.elementType||this._elementType}getElementLength(){return this._elementLength}update(){const{array:e,value:t}=this,s=this.getElementLength(),n=this.getElementType();if(s===1)for(let i=0;i<e.length;i++){const r=i*4;t[r]=e[i]}else if(n==="color")for(let i=0;i<e.length;i++){const r=i*4,a=e[i];t[r]=a.r,t[r+1]=a.g,t[r+2]=a.b||0}else for(let i=0;i<e.length;i++){const r=i*4,a=e[i];t[r]=a.x,t[r+1]=a.y,t[r+2]=a.z||0,t[r+3]=a.w||0}}setup(e){const t=this.array.length;return this._elementType=this.elementType===null?Vt(this.array[0]):this.elementType,this._elementLength=e.getTypeLength(this._elementType),this.value=new Float32Array(t*4),this.bufferCount=t,super.setup(e)}element(e){return A(new Pg(this,A(e)))}}const Io=(o,e)=>A(new Cc(o,e));b("UniformsNode",Cc);class Rg extends xs{constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),s=this.referenceNode.getNodeType(),n=this.getNodeType();return e.format(t,s,n)}}class tn extends D{constructor(e,t,s=null,n=null){super(),this.property=e,this.uniformType=t,this.object=s,this.count=n,this.properties=e.split("."),this.reference=null,this.node=null,this.updateType=H.OBJECT}element(e){return A(new Rg(this,A(e)))}setNodeType(e){let t=null;this.count!==null?t=Ci(null,e,this.count):Array.isArray(this.getValueFromReference())?t=Io(null,e):e==="texture"?t=Re(null):t=de(null,e),this.node=t}getNodeType(e){return this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let s=e[t[0]];for(let n=1;n<t.length;n++)s=s[t[n]];return s}setReference(e){return this.reference=this.object!==null?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){this.node===null&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}const mt=(o,e,t)=>A(new tn(o,e,t)),Ig=(o,e,t,s)=>A(new tn(o,e,s,t));b("ReferenceNode",tn);class Mc extends tn{constructor(e,t,s=null){super(e,t,s),this.material=s}setReference(e){return this.reference=this.material!==null?this.material:e.material,this.reference}}const Dg=(o,e,t)=>A(new Mc(o,e,t));b("MaterialReferenceNode",Mc);class $ extends D{constructor(e=$.VIEW_MATRIX,t=null){super(),this.scope=e,this.object3d=t,this.updateType=H.OBJECT,this._uniformNode=new Zt(null)}getNodeType(){const e=this.scope;if(e===$.WORLD_MATRIX||e===$.VIEW_MATRIX)return"mat4";if(e===$.NORMAL_MATRIX)return"mat3";if(e===$.POSITION||e===$.VIEW_POSITION||e===$.DIRECTION||e===$.SCALE)return"vec3"}update(e){const t=this.object3d,s=this._uniformNode,n=this.scope;if(n===$.VIEW_MATRIX)s.value=t.modelViewMatrix;else if(n===$.NORMAL_MATRIX)s.value=t.normalMatrix;else if(n===$.WORLD_MATRIX)s.value=t.matrixWorld;else if(n===$.POSITION)s.value=s.value||new J,s.value.setFromMatrixPosition(t.matrixWorld);else if(n===$.SCALE)s.value=s.value||new J,s.value.setFromMatrixScale(t.matrixWorld);else if(n===$.DIRECTION)s.value=s.value||new J,t.getWorldDirection(s.value);else if(n===$.VIEW_POSITION){const i=e.camera;s.value=s.value||new J,s.value.setFromMatrixPosition(t.matrixWorld),s.value.applyMatrix4(i.matrixWorldInverse)}}generate(e){const t=this.scope;return t===$.WORLD_MATRIX||t===$.VIEW_MATRIX?this._uniformNode.nodeType="mat4":t===$.NORMAL_MATRIX?this._uniformNode.nodeType="mat3":(t===$.POSITION||t===$.VIEW_POSITION||t===$.DIRECTION||t===$.SCALE)&&(this._uniformNode.nodeType="vec3"),this._uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}$.VIEW_MATRIX="viewMatrix";$.NORMAL_MATRIX="normalMatrix";$.WORLD_MATRIX="worldMatrix";$.POSITION="position";$.SCALE="scale";$.VIEW_POSITION="viewPosition";$.DIRECTION="direction";y($,$.DIRECTION);y($,$.VIEW_MATRIX);y($,$.NORMAL_MATRIX);y($,$.WORLD_MATRIX);const Do=y($,$.POSITION);y($,$.SCALE);const Oc=y($,$.VIEW_POSITION);b("Object3DNode",$);class U extends ${constructor(e=U.POSITION){super(e),this.updateType=H.RENDER}getNodeType(e){const t=this.scope;return t===U.PROJECTION_MATRIX||t===U.PROJECTION_MATRIX_INVERSE?"mat4":t===U.NEAR||t===U.FAR||t===U.LOG_DEPTH?"float":super.getNodeType(e)}update(e){const t=e.camera,s=this._uniformNode,n=this.scope;n===U.VIEW_MATRIX?s.value=t.matrixWorldInverse:n===U.PROJECTION_MATRIX?s.value=t.projectionMatrix:n===U.PROJECTION_MATRIX_INVERSE?s.value=t.projectionMatrixInverse:n===U.NEAR?s.value=t.near:n===U.FAR?s.value=t.far:n===U.LOG_DEPTH?s.value=2/(Math.log(t.far+1)/Math.LN2):(this.object3d=t,super.update(e))}generate(e){const t=this.scope;return t===U.PROJECTION_MATRIX||t===U.PROJECTION_MATRIX_INVERSE?this._uniformNode.nodeType="mat4":(t===U.NEAR||t===U.FAR||t===U.LOG_DEPTH)&&(this._uniformNode.nodeType="float"),super.generate(e)}}U.PROJECTION_MATRIX="projectionMatrix";U.PROJECTION_MATRIX_INVERSE="projectionMatrixInverse";U.NEAR="near";U.FAR="far";U.LOG_DEPTH="logDepth";const Tt=C(U,U.PROJECTION_MATRIX);C(U,U.PROJECTION_MATRIX_INVERSE);const co=C(U,U.NEAR),lo=C(U,U.FAR),Fg=C(U,U.LOG_DEPTH),$t=C(U,U.VIEW_MATRIX);C(U,U.NORMAL_MATRIX);C(U,U.WORLD_MATRIX);C(U,U.POSITION);b("CameraNode",U);class Ae extends ${constructor(e=Ae.VIEW_MATRIX){super(e)}update(e){this.object3d=e.object,super.update(e)}}C(Ae,Ae.DIRECTION);const qt=C(Ae,Ae.VIEW_MATRIX).label("modelViewMatrix").temp("ModelViewMatrix"),Ec=C(Ae,Ae.NORMAL_MATRIX),yn=C(Ae,Ae.WORLD_MATRIX);C(Ae,Ae.POSITION);C(Ae,Ae.SCALE);C(Ae,Ae.VIEW_POSITION);b("ModelNode",Ae);class Ne extends D{constructor(e=Ne.LOCAL){super("vec3"),this.scope=e}isGlobal(){return!0}getHash(){return`normal-${this.scope}`}generate(e){const t=this.scope;let s=null;if(t===Ne.GEOMETRY)s=Pe("normal","vec3");else if(t===Ne.LOCAL)s=ue(Nn);else if(t===Ne.VIEW){const n=Ec.mul(ft);s=Ke(ue(n))}else if(t===Ne.WORLD){const n=_t.transformDirection($t);s=Ke(ue(n))}return s.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}Ne.GEOMETRY="geometry";Ne.LOCAL="local";Ne.VIEW="view";Ne.WORLD="world";const Nn=C(Ne,Ne.GEOMETRY),ft=C(Ne,Ne.LOCAL).temp("Normal"),_t=C(Ne,Ne.VIEW),kn=C(Ne,Ne.WORLD),me=Me("vec3","TransformedNormalView"),zg=me.transformDirection($t).normalize(),ns=Me("vec3","TransformedClearcoatNormalView");b("NormalNode",Ne);const cr=new Map;class M extends D{constructor(e){super(),this.scope=e}getCache(e,t){let s=cr.get(e);return s===void 0&&(s=Dg(e,t),cr.set(e,s)),s}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache(e==="map"?"map":e+"Map","texture")}setup(e){const t=e.context.material,s=this.scope;let n=null;if(s===M.COLOR){const i=this.getColor(s);t.map&&t.map.isTexture===!0?n=i.mul(this.getTexture("map")):n=i}else if(s===M.OPACITY){const i=this.getFloat(s);t.alphaMap&&t.alphaMap.isTexture===!0?n=i.mul(this.getTexture("alpha")):n=i}else if(s===M.SPECULAR_STRENGTH)t.specularMap&&t.specularMap.isTexture===!0?n=this.getTexture(s).r:n=h(1);else if(s===M.ROUGHNESS){const i=this.getFloat(s);t.roughnessMap&&t.roughnessMap.isTexture===!0?n=i.mul(this.getTexture(s).g):n=i}else if(s===M.METALNESS){const i=this.getFloat(s);t.metalnessMap&&t.metalnessMap.isTexture===!0?n=i.mul(this.getTexture(s).b):n=i}else if(s===M.EMISSIVE){const i=this.getColor(s);t.emissiveMap&&t.emissiveMap.isTexture===!0?n=i.mul(this.getTexture(s)):n=i}else if(s===M.NORMAL)t.normalMap?n=this.getTexture("normal").normalMap(this.getCache("normalScale","vec2")):t.bumpMap?n=this.getTexture("bump").r.bumpMap(this.getFloat("bumpScale")):n=_t;else if(s===M.CLEARCOAT){const i=this.getFloat(s);t.clearcoatMap&&t.clearcoatMap.isTexture===!0?n=i.mul(this.getTexture(s).r):n=i}else if(s===M.CLEARCOAT_ROUGHNESS){const i=this.getFloat(s);t.clearcoatRoughnessMap&&t.clearcoatRoughnessMap.isTexture===!0?n=i.mul(this.getTexture(s).r):n=i}else if(s===M.CLEARCOAT_NORMAL)t.clearcoatNormalMap?n=this.getTexture(s).normalMap(this.getCache(s+"Scale","vec2")):n=_t;else if(s===M.SHEEN){const i=this.getColor("sheenColor").mul(this.getFloat("sheen"));t.sheenColorMap&&t.sheenColorMap.isTexture===!0?n=i.mul(this.getTexture("sheenColor").rgb):n=i}else if(s===M.SHEEN_ROUGHNESS){const i=this.getFloat(s);t.sheenRoughnessMap&&t.sheenRoughnessMap.isTexture===!0?n=i.mul(this.getTexture(s).a):n=i,n=n.clamp(.07,1)}else if(s===M.IRIDESCENCE_THICKNESS){const i=mt("1","float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){const r=mt("0","float",t.iridescenceThicknessRange);n=i.sub(r).mul(this.getTexture(s).g).add(r)}else n=i}else{const i=this.getNodeType(e);n=this.getCache(s,i)}return n}}M.ALPHA_TEST="alphaTest";M.COLOR="color";M.OPACITY="opacity";M.SHININESS="shininess";M.SPECULAR_COLOR="specular";M.SPECULAR_STRENGTH="specularStrength";M.REFLECTIVITY="reflectivity";M.ROUGHNESS="roughness";M.METALNESS="metalness";M.NORMAL="normal";M.CLEARCOAT="clearcoat";M.CLEARCOAT_ROUGHNESS="clearcoatRoughness";M.CLEARCOAT_NORMAL="clearcoatNormal";M.EMISSIVE="emissive";M.ROTATION="rotation";M.SHEEN="sheen";M.SHEEN_ROUGHNESS="sheenRoughness";M.IRIDESCENCE="iridescence";M.IRIDESCENCE_IOR="iridescenceIOR";M.IRIDESCENCE_THICKNESS="iridescenceThickness";M.LINE_SCALE="scale";M.LINE_DASH_SIZE="dashSize";M.LINE_GAP_SIZE="gapSize";M.LINE_WIDTH="linewidth";M.LINE_DASH_OFFSET="dashOffset";M.POINT_WIDTH="pointWidth";const jg=C(M,M.ALPHA_TEST),Fs=C(M,M.COLOR),$g=C(M,M.SHININESS),Ug=C(M,M.EMISSIVE),Ac=C(M,M.OPACITY),Wg=C(M,M.SPECULAR_COLOR),Gg=C(M,M.SPECULAR_STRENGTH);C(M,M.REFLECTIVITY);const Hg=C(M,M.ROUGHNESS),kg=C(M,M.METALNESS),Bg=C(M,M.NORMAL),qg=C(M,M.CLEARCOAT),Yg=C(M,M.CLEARCOAT_ROUGHNESS),Kg=C(M,M.CLEARCOAT_NORMAL),Zg=C(M,M.ROTATION),Qg=C(M,M.SHEEN),Xg=C(M,M.SHEEN_ROUGHNESS),Jg=C(M,M.IRIDESCENCE),ex=C(M,M.IRIDESCENCE_IOR),tx=C(M,M.IRIDESCENCE_THICKNESS),Fo=C(M,M.LINE_SCALE),Vc=C(M,M.LINE_DASH_SIZE),Lc=C(M,M.LINE_GAP_SIZE),uo=C(M,M.LINE_WIDTH),lr=C(M,M.LINE_DASH_OFFSET),sx=C(M,M.POINT_WIDTH);b("MaterialNode",M);class X extends D{constructor(e=X.LOCAL){super("vec3"),this.scope=e}isGlobal(){return!0}getHash(){return`position-${this.scope}`}generate(e){const t=this.scope;let s=null;if(t===X.GEOMETRY)s=Pe("position","vec3");else if(t===X.LOCAL)s=ue(Fe);else if(t===X.WORLD){const n=yn.mul(Ie);s=ue(n)}else if(t===X.VIEW){const n=qt.mul(Ie);s=ue(n)}else if(t===X.VIEW_DIRECTION){const n=Ue.negate();s=Ke(ue(n))}else if(t===X.WORLD_DIRECTION){const n=Ie.transformDirection(yn);s=Ke(ue(n))}return s.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}X.GEOMETRY="geometry";X.LOCAL="local";X.WORLD="world";X.WORLD_DIRECTION="worldDirection";X.VIEW="view";X.VIEW_DIRECTION="viewDirection";const Fe=C(X,X.GEOMETRY),Ie=C(X,X.LOCAL).temp("Position"),Pc=C(X,X.WORLD),Rc=C(X,X.WORLD_DIRECTION),Ue=C(X,X.VIEW),ge=C(X,X.VIEW_DIRECTION);b("PositionNode",X);class Ic extends se{constructor(e=null){super("vec4"),this.positionNode=e}setup(e){if(e.shaderStage==="fragment")return ue(e.context.mvp);const t=this.positionNode||Ie;return Tt.mul(qt).mul(t)}}const dr=y(Ic);b("ModelViewProjectionNode",Ic);class Dc extends zn{constructor(e,t=null,s=0,n=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=s,this.bufferOffset=n,this.usage=Vu,this.instanced=!1,this.attribute=null,e&&e.isBufferAttribute===!0&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getNodeType(e){return this.bufferType===null&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(this.attribute!==null)return;const t=this.getNodeType(e),s=this.value,n=e.getTypeLength(t),i=this.bufferStride||n,r=this.bufferOffset,a=s.isInterleavedBuffer===!0?s:new kr(s,i),c=new _o(a,n,r);a.setUsage(this.usage),this.attribute=c,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),s=e.getBufferAttributeFromNode(this,t),n=e.getPropertyName(s);let i=null;return e.shaderStage==="vertex"||e.shaderStage==="compute"?(this.name=n,i=n):i=ue(this).build(e,t),i}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this}setInstanced(e){return this.instanced=e,this}}const Bn=(o,e,t,s)=>A(new Dc(o,e,t,s)),nx=(o,e,t,s)=>Bn(o,e,t,s).setUsage(Jr),ox=(o,e,t,s)=>Bn(o,e,t,s).setInstanced(!0),ix=(o,e,t,s)=>nx(o,e,t,s).setInstanced(!0);g("toAttribute",o=>Bn(o.value));b("BufferAttributeNode",Dc);class Fc extends D{constructor(e){super("void"),this.instanceMesh=e,this.instanceMatrixNode=null}setup(){let e=this.instanceMatrixNode;if(e===null){const a=this.instanceMesh.instanceMatrix,c=new Lu(a.array,16,1),l=a.usage===Jr?ix:ox,d=[l(c,"vec4",16,0),l(c,"vec4",16,4),l(c,"vec4",16,8),l(c,"vec4",16,12)];e=As(...d),this.instanceMatrixNode=e}const t=e.mul(Ie).xyz,s=ht(e[0].xyz,e[1].xyz,e[2].xyz),n=ft.div(x(s[0].dot(s[0]),s[1].dot(s[1]),s[2].dot(s[2]))),i=s.mul(n).xyz;Ie.assign(t),ft.assign(i)}}const rx=y(Fc);b("InstanceNode",Fc);class xe extends D{constructor(e=xe.LOCAL){super(),this.scope=e}getHash(){return`tangent-${this.scope}`}getNodeType(){return this.scope===xe.GEOMETRY?"vec4":"vec3"}generate(e){const t=this.scope;let s=null;if(t===xe.GEOMETRY)s=Pe("tangent","vec4"),e.geometry.hasAttribute("tangent")===!1&&e.geometry.computeTangents();else if(t===xe.LOCAL)s=ue(vn.xyz);else if(t===xe.VIEW){const n=qt.mul(I(qn,0)).xyz;s=Ke(ue(n))}else if(t===xe.WORLD){const n=Yn.transformDirection($t);s=Ke(ue(n))}return s.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}xe.GEOMETRY="geometry";xe.LOCAL="local";xe.VIEW="view";xe.WORLD="world";const vn=C(xe,xe.GEOMETRY),qn=C(xe,xe.LOCAL),Yn=C(xe,xe.VIEW),zc=C(xe,xe.WORLD),jc=Is(Yn,"TransformedTangentView");Ke(jc.transformDirection($t));b("TangentNode",xe);class $c extends D{constructor(e,t=!1){super("void"),this.skinnedMesh=e,this.useReference=t,this.updateType=H.OBJECT,this.skinIndexNode=Pe("skinIndex","uvec4"),this.skinWeightNode=Pe("skinWeight","vec4");let s,n,i;t?(s=mt("bindMatrix","mat4"),n=mt("bindMatrixInverse","mat4"),i=Ig("skeleton.boneMatrices","mat4",e.skeleton.bones.length)):(s=de(e.bindMatrix,"mat4"),n=de(e.bindMatrixInverse,"mat4"),i=Ci(e.skeleton.boneMatrices,"mat4",e.skeleton.bones.length)),this.bindMatrixNode=s,this.bindMatrixInverseNode=n,this.boneMatricesNode=i}setup(e){const{skinIndexNode:t,skinWeightNode:s,bindMatrixNode:n,bindMatrixInverseNode:i,boneMatricesNode:r}=this,a=r.element(t.x),c=r.element(t.y),l=r.element(t.z),d=r.element(t.w),u=n.mul(Ie),m=He(a.mul(s.x).mul(u),c.mul(s.y).mul(u),l.mul(s.z).mul(u),d.mul(s.w).mul(u)),w=i.mul(m).xyz;let T=He(s.x.mul(a),s.y.mul(c),s.z.mul(l),s.w.mul(d));T=i.mul(T).mul(n);const N=T.transformDirection(ft).xyz;Ie.assign(w),ft.assign(N),e.hasGeometryAttribute("tangent")&&qn.assign(N)}generate(e,t){if(t!=="void")return Ie.build(e,t)}update(e){(this.useReference?e.object:this.skinnedMesh).skeleton.update()}}const ax=o=>A(new $c(o,!0));b("SkinningNode",$c);class Uc extends D{constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode("i".charCodeAt()+e)}getProperties(e){const t=e.getNodeProperties(this);if(t.stackNode!==void 0)return t;const s={};for(let n=0,i=this.params.length-1;n<i;n++){const r=this.params[n],a=r.isNode!==!0&&r.name||this.getVarName(n),c=r.isNode!==!0&&r.type||"int";s[a]=_i(a,c)}return t.returnsNode=this.params[this.params.length-1](s,e.addStack(),e),t.stackNode=e.removeStack(),t}getNodeType(e){const{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){const t=this.getProperties(e),s={tempWrite:!1},n=this.params,i=t.stackNode;for(let c=0,l=n.length-1;c<l;c++){const d=n[c];let u=null,m=null,w=null,T=null,N=null,v=null;d.isNode?(T="int",w=this.getVarName(c),u="0",m=d.build(e,T),N="<"):(T=d.type||"int",w=d.name||this.getVarName(c),u=d.start,m=d.end,N=d.condition,v=d.update,typeof u=="number"?u=u.toString():u&&u.isNode&&(u=u.build(e,T)),typeof m=="number"?m=m.toString():m&&m.isNode&&(m=m.build(e,T)),u!==void 0&&m===void 0?(u=u+" - 1",m="0",N=">="):m!==void 0&&u===void 0&&(u="0",N="<"),N===void 0&&(Number(u)>Number(m)?N=">=":N="<"));const O={start:u,end:m,condition:N},P=O.start,L=O.end;let F="",Q="",W="";v||(T==="int"||T==="uint"?N.includes("<")?v="++":v="--":N.includes("<")?v="+= 1.":v="-= 1."),F+=e.getVar(T,w)+" = "+P,Q+=w+" "+N+" "+L,W+=w+" "+v;const k=`for ( ${F}; ${Q}; ${W} )`;e.addFlowCode((c===0?`
`:"")+e.tab+k+` {

`).addFlowTab()}const r=bt(i,s).build(e,"void"),a=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode(`
`+e.tab+r);for(let c=0,l=this.params.length-1;c<l;c++)e.addFlowCode((c===0?"":e.tab)+`}

`).removeFlowTab();return e.addFlowTab(),a}}const ie=(...o)=>A(new Uc(rs(o,"int"))).append();g("loop",(o,...e)=>Za(o,ie(...e)));b("LoopNode",Uc);const ho=new WeakMap,Ye=new it,ur=_(({bufferMap:o,influence:e,stride:t,width:s,depth:n,offset:i})=>{const r=p(_f).mul(t).add(i),a=r.div(s),c=r.sub(a.mul(s));return Lg(o,Ha(c,a)).depth(n).mul(e)});function cx(o){const e=o.morphAttributes.position!==void 0,t=o.morphAttributes.normal!==void 0,s=o.morphAttributes.color!==void 0,n=o.morphAttributes.position||o.morphAttributes.normal||o.morphAttributes.color,i=n!==void 0?n.length:0;let r=ho.get(o);if(r===void 0||r.count!==i){let O=function(){N.dispose(),ho.delete(o),o.removeEventListener("dispose",O)};r!==void 0&&r.texture.dispose();const a=o.morphAttributes.position||[],c=o.morphAttributes.normal||[],l=o.morphAttributes.color||[];let d=0;e===!0&&(d=1),t===!0&&(d=2),s===!0&&(d=3);let u=o.attributes.position.count*d,m=1;const w=4096;u>w&&(m=Math.ceil(u/w),u=w);const T=new Float32Array(u*m*4*i),N=new Pu(T,u,m,i);N.type=Ru,N.needsUpdate=!0;const v=d*4;for(let P=0;P<i;P++){const L=a[P],F=c[P],Q=l[P],W=u*m*4*P;for(let k=0;k<L.count;k++){const K=k*v;e===!0&&(Ye.fromBufferAttribute(L,k),T[W+K+0]=Ye.x,T[W+K+1]=Ye.y,T[W+K+2]=Ye.z,T[W+K+3]=0),t===!0&&(Ye.fromBufferAttribute(F,k),T[W+K+4]=Ye.x,T[W+K+5]=Ye.y,T[W+K+6]=Ye.z,T[W+K+7]=0),s===!0&&(Ye.fromBufferAttribute(Q,k),T[W+K+8]=Ye.x,T[W+K+9]=Ye.y,T[W+K+10]=Ye.z,T[W+K+11]=Q.itemSize===4?Ye.w:1)}}r={count:i,texture:N,stride:d,size:new oe(u,m)},ho.set(o,r),o.addEventListener("dispose",O)}return r}class Wc extends D{constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=de(1),this.updateType=H.OBJECT}setup(e){const{geometry:t}=e,s=t.morphAttributes.position!==void 0,n=t.morphAttributes.normal!==void 0,i=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,r=i!==void 0?i.length:0,{texture:a,stride:c,size:l}=cx(t);s===!0&&Ie.mulAssign(this.morphBaseInfluence),n===!0&&ft.mulAssign(this.morphBaseInfluence);const d=p(l.width);ie(r,({i:u})=>{const m=mt("morphTargetInfluences","float").element(u);s===!0&&Ie.addAssign(ur({bufferMap:a,influence:m,stride:c,width:d,depth:u,offset:p(0)})),n===!0&&ft.addAssign(ur({bufferMap:a,influence:m,stride:c,width:d,depth:u,offset:p(1)}))})}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((t,s)=>t+s,0)}}const lx=y(Wc);b("MorphNode",Wc);class Gc extends D{constructor(){super("vec3")}getHash(){return"reflectVector"}setup(){return ge.negate().reflect(me).transformDirection($t)}}const dx=C(Gc);b("ReflectVectorNode",Gc);class Hc extends Ns{constructor(e,t=null,s=null){super(e,t,s),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){return dx}setUpdateMatrix(){}setupUV(e,t){const s=this.value;return e.renderer.coordinateSystem===ea||!s.isRenderTargetTexture?x(t.x.negate(),t.yz):t}generateUV(e,t){return t.build(e,"vec3")}}const Mi=y(Hc);g("cubeTexture",Mi);b("CubeTextureNode",Hc);class Kn extends D{constructor(){super("vec3")}generate(){console.warn("Abstract function.")}}b("LightingNode",Kn);let Ss=null;class Xt extends Kn{constructor(e=null){super(),this.updateType=H.FRAME,this.light=e,this.rtt=null,this.shadowNode=null,this.color=new Je,this._defaultColorNode=de(this.color),this.colorNode=this._defaultColorNode,this.isAnalyticLightNode=!0}getCacheKey(){return super.getCacheKey()+"-"+(this.light.id+"-"+(this.light.castShadow?"1":"0"))}getHash(){return this.light.uuid}setupShadow(e){let t=this.shadowNode;if(t===null){Ss===null&&(Ss=e.createNodeMaterial(),Ss.fragmentNode=I(0,0,0,1),Ss.isShadowNodeMaterial=!0);const s=this.light.shadow,n=e.getRenderTarget(s.mapSize.width,s.mapSize.height),i=new Qo;i.minFilter=qi,i.magFilter=qi,i.image.width=s.mapSize.width,i.image.height=s.mapSize.height,i.compareFunction=Iu,n.depthTexture=i,s.camera.updateProjectionMatrix();const r=mt("bias","float",s),a=mt("normalBias","float",s);let c=de(s.matrix).mul(Pc.add(kn.mul(a)));c=c.xyz.div(c.w);const l=c.x.greaterThanEqual(0).and(c.x.lessThanEqual(1)).and(c.y.greaterThanEqual(0)).and(c.y.lessThanEqual(1)).and(c.z.lessThanEqual(1));let d=c.z.add(r);e.renderer.coordinateSystem===ea&&(d=d.mul(2).sub(1)),c=x(c.x,c.y.oneMinus(),d),t=((w,T,N)=>Re(w,T).compare(N))(i,c.xy,c.z);const m=Re(n.texture,c);this.rtt=n,this.colorNode=this.colorNode.mul(l.mix(1,t.mix(m.a.mix(1,m),1))),this.shadowNode=t,this.updateBeforeType=H.RENDER}}setup(e){this.light.castShadow?this.setupShadow(e):this.shadowNode!==null&&this.disposeShadow()}updateShadow(e){const{rtt:t,light:s}=this,{renderer:n,scene:i}=e,r=i.overrideMaterial;i.overrideMaterial=Ss,t.setSize(s.shadow.mapSize.width,s.shadow.mapSize.height),s.shadow.updateMatrices(s);const a=n.getRenderTarget(),c=n.getRenderObjectFunction();n.setRenderObjectFunction((l,...d)=>{l.castShadow===!0&&n.renderObject(l,...d)}),n.setRenderTarget(t),n.render(i,s.shadow.camera),n.setRenderTarget(a),n.setRenderObjectFunction(c),i.overrideMaterial=r}disposeShadow(){this.rtt.dispose(),this.shadowNode=null,this.rtt=null,this.colorNode=this._defaultColorNode}updateBefore(e){const{light:t}=this;t.castShadow&&this.updateShadow(e)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}b("AnalyticLightNode",Xt);const wn=new WeakMap,ux=o=>o.sort((e,t)=>e.id-t.id);class hx extends D{constructor(e=[]){super("vec3"),this.totalDiffuseNode=x().temp("totalDiffuse"),this.totalSpecularNode=x().temp("totalSpecular"),this.outgoingLightNode=x().temp("outgoingLight"),this.lightNodes=e,this._hash=null}get hasLight(){return this.lightNodes.length>0}getHash(){if(this._hash===null){const e=[];for(const t of this.lightNodes)e.push(t.getHash());this._hash="lights-"+e.join(",")}return this._hash}setup(e){const t=e.context,s=t.lightingModel;let n=this.outgoingLightNode;if(s){const{lightNodes:i,totalDiffuseNode:r,totalSpecularNode:a}=this;t.outgoingLight=n;const c=e.addStack();s.start(t,c,e);for(const v of i)v.build(e);s.indirectDiffuse(t,c,e),s.indirectSpecular(t,c,e),s.ambientOcclusion(t,c,e);const{backdrop:l,backdropAlpha:d}=t,{directDiffuse:u,directSpecular:m,indirectDiffuse:w,indirectSpecular:T}=t.reflectedLight;let N=u.add(w);l!==null&&(N=x(d!==null?d.mix(N,l):l)),r.assign(N),a.assign(m.add(T)),n.assign(r.add(a)),s.finish(t,c,e),n=n.bypass(e.removeStack())}return n}_getLightNodeById(e){for(const t of this.lightNodes)if(t.isAnalyticLightNode&&t.light.id===e)return t;return null}fromLights(e=[]){const t=[];e=ux(e);for(const s of e){let n=this._getLightNodeById(s.id);if(n===null){const i=s.constructor,r=wn.has(i)?wn.get(i):Xt;n=A(new r(s))}t.push(n)}return this.lightNodes=t,this._hash=null,this}}const px=y(hx);function vs(o,e){if(wn.has(o)){console.warn(`Redefinition of light node ${e.type}`);return}if(typeof o!="function")throw new Error(`Light ${o.name} is not a class`);if(typeof e!="function"||!e.type)throw new Error(`Light node ${e.type} is not a class`);wn.set(o,e)}class kc extends Kn{constructor(e=null){super(),this.aoNode=e}setup(e){const s=this.aoNode.x.sub(1).mul(1).add(1);e.context.ambientOcclusion.mulAssign(s)}}b("AONode",kc);class Bc extends xi{constructor(e,t=null,s=null,n=null){super(e),this.lightingModel=t,this.backdropNode=s,this.backdropAlphaNode=n,this._context=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,s=x().temp("directDiffuse"),n=x().temp("directSpecular"),i=x().temp("indirectDiffuse"),r=x().temp("indirectSpecular"),a={directDiffuse:s,directSpecular:n,indirectDiffuse:i,indirectSpecular:r};return{radiance:x().temp("radiance"),irradiance:x().temp("irradiance"),iblIrradiance:x().temp("iblIrradiance"),ambientOcclusion:h(1).temp("ambientOcclusion"),reflectedLight:a,backdrop:e,backdropAlpha:t}}setup(e){return this.context=this._context||(this._context=this.getContext()),this.context.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}const qc=y(Bc);g("lightingContext",qc);b("LightingContextNode",Bc);class Yc extends se{constructor(e=Rc){super("vec2"),this.dirNode=e}setup(){const e=this.dirNode,t=e.z.atan2(e.x).mul(1/(Math.PI*2)).add(.5),s=e.y.negate().clamp(-1,1).asin().mul(1/Math.PI).add(.5);return j(t,s)}}const Oi=y(Yc);b("EquirectUVNode",Yc);class Kc extends D{constructor(e,t=null){super("float"),this.textureNode=e,this.roughnessNode=t}setup(){const{textureNode:e,roughnessNode:t}=this,s=Si(e),n=t.mul(t).mul(Math.PI).div(t.add(1));return s.add(n.log2()).clamp(0,s)}}const mx=y(Kc);b("SpecularMIPLevelNode",Kc);const hr=new WeakMap;class Zc extends Kn{constructor(e=null){super(),this.envNode=e}setup(e){let t=this.envNode;if(t.isTextureNode&&t.value.isCubeTexture!==!0){let c=hr.get(t.value);if(c===void 0){const l=t.value,d=e.renderer,u=e.getCubeRenderTarget(512).fromEquirectangularTexture(d,l);c=Mi(u.texture),hr.set(t.value,c)}t=c}const s=mt("envMapIntensity","float",e.material),n=bt(t,pr(Vs,me)).mul(s),i=bt(t,fx(zg)).mul(Math.PI).mul(s),r=fn(n);e.context.radiance.addAssign(r),e.context.iblIrradiance.addAssign(i);const a=e.context.lightingModel.clearcoatRadiance;if(a){const c=bt(t,pr(gn,ns)).mul(s),l=fn(c);a.addAssign(l)}}}const pr=(o,e)=>{let t=null,s=null;return{getUV:n=>{let i=null;return t===null&&(t=ge.negate().reflect(e),t=o.mul(o).mix(t,e).normalize(),t=t.transformDirection($t)),n.isCubeTextureNode?i=t:n.isTextureNode&&(s===null&&(s=Oi(t)),i=s),i},getTextureLevel:()=>o,getTextureLevelAlgorithm:(n,i)=>mx(n,i)}},fx=o=>{let e=null;return{getUV:t=>{let s=null;return t.isCubeTextureNode?s=o:t.isTextureNode&&(e===null&&(e=Oi(o),e=j(e.x,e.y.oneMinus())),s=e),s},getTextureLevel:t=>Si(t)}};b("EnvironmentNode",Zc);let po,mo;class q extends D{constructor(e){super(),this.scope=e,this.isViewportNode=!0}getNodeType(){return this.scope===q.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=H.NONE;return(this.scope===q.RESOLUTION||this.scope===q.VIEWPORT)&&(e=H.FRAME),this.updateType=e,e}update({renderer:e}){this.scope===q.VIEWPORT?e.getViewport(mo):e.getDrawingBufferSize(po)}setup(){const e=this.scope;let t=null;if(e===q.RESOLUTION)t=de(po||(po=new oe));else if(e===q.VIEWPORT)t=de(mo||(mo=new it));else{t=gx.div(mr);let s=t.x,n=t.y;/bottom/i.test(e)&&(n=n.oneMinus()),/right/i.test(e)&&(s=s.oneMinus()),t=j(s,n)}return t}generate(e){if(this.scope===q.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){const s=e.getNodeProperties(mr).outputNode.build(e);t=`${e.getType("vec2")}( ${t}.x, ${s}.y - ${t}.y )`}return t}return super.generate(e)}}q.COORDINATE="coordinate";q.RESOLUTION="resolution";q.VIEWPORT="viewport";q.TOP_LEFT="topLeft";q.BOTTOM_LEFT="bottomLeft";q.TOP_RIGHT="topRight";q.BOTTOM_RIGHT="bottomRight";const gx=C(q,q.COORDINATE),mr=C(q,q.RESOLUTION),cs=C(q,q.VIEWPORT),zs=C(q,q.TOP_LEFT);C(q,q.BOTTOM_LEFT);C(q,q.TOP_RIGHT);C(q,q.BOTTOM_RIGHT);b("ViewportNode",q);const Cs=new oe;class sn extends Ns{constructor(e=zs,t=null,s=null){s===null&&(s=new un,s.minFilter=ta),super(s,e,t),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=H.FRAME}updateBefore(e){const t=e.renderer;t.getDrawingBufferSize(Cs);const s=this.value;(s.image.width!==Cs.width||s.image.height!==Cs.height)&&(s.image.width=Cs.width,s.image.height=Cs.height,s.needsUpdate=!0);const n=s.generateMipmaps;s.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(s),s.generateMipmaps=n}clone(){return new this.constructor(this.uvNode,this.levelNode,this.value)}}const xx=y(sn),yx=y(sn,null,null,{generateMipmaps:!0});g("viewportTexture",xx);g("viewportMipTexture",yx);b("ViewportTextureNode",sn);let fo=null;class Qc extends sn{constructor(e=zs,t=null){fo===null&&(fo=new Qo),super(e,t,fo)}}const Xc=y(Qc);g("viewportDepthTexture",Xc);b("ViewportDepthTextureNode",Qc);class Oe extends D{constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(e){const{scope:t}=this;return t===Oe.DEPTH_PIXEL?e.getFragDepth():super.generate(e)}setup(){const{scope:e}=this;let t=null;if(e===Oe.DEPTH)t=zo(Ue.z,co,lo);else if(e===Oe.DEPTH_TEXTURE){const s=this.valueNode||Xc(),n=Jc(s,co,lo);t=zo(n,co,lo)}else e===Oe.DEPTH_PIXEL&&this.valueNode!==null&&(t=el().assign(this.valueNode));return t}}const zo=(o,e,t)=>o.add(e).div(e.sub(t)),Jc=(o,e,t)=>e.mul(t).div(t.sub(e).mul(o).sub(t));Oe.DEPTH="depth";Oe.DEPTH_TEXTURE="depthTexture";Oe.DEPTH_PIXEL="depthPixel";const el=y(Oe,Oe.DEPTH_PIXEL);C(Oe,Oe.DEPTH);y(Oe,Oe.DEPTH_TEXTURE);const tl=C(Oe,Oe.DEPTH_PIXEL);tl.assign=o=>el(o);b("ViewportDepthNode",Oe);class Dt extends D{constructor(e=Dt.DEFAULT){super(),this.scope=e}setup(e){super.setup(e);const t=e.clippingContext,{localClipIntersection:s,localClippingCount:n,globalClippingCount:i}=t,r=i+n,a=s?r-n:r;return this.scope===Dt.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(t.planes,r,a):this.setupDefault(t.planes,r,a)}setupAlphaToCoverage(e,t,s){return _(()=>{const n=Io(e),i=Me("float","distanceToPlane"),r=Me("float","distanceToGradient"),a=Me("float","clipOpacity");a.assign(1);let c;if(ie(s,({i:l})=>{c=n.element(l),i.assign(Ue.dot(c.xyz).negate().add(c.w)),r.assign(i.fwidth().div(2)),a.mulAssign(rt(r.negate(),r,i)),a.equal(0).discard()}),s<t){const l=Me("float","unionclipOpacity");l.assign(1),ie({start:s,end:t},({i:d})=>{c=n.element(d),i.assign(Ue.dot(c.xyz).negate().add(c.w)),r.assign(i.fwidth().div(2)),l.mulAssign(rt(r.negate(),r,i).oneMinus())}),a.mulAssign(l.oneMinus())}Se.a.mulAssign(a),Se.a.equal(0).discard()})()}setupDefault(e,t,s){return _(()=>{const n=Io(e);let i;if(ie(s,({i:r})=>{i=n.element(r),Ue.dot(i.xyz).greaterThan(i.w).discard()}),s<t){const r=Me("bool","clipped");r.assign(!0),ie({start:s,end:t},({i:a})=>{i=n.element(a),r.assign(Ue.dot(i.xyz).greaterThan(i.w).and(r))}),r.discard()}})()}}Dt.ALPHA_TO_COVERAGE="alphaToCoverage";Dt.DEFAULT="default";const Nx=()=>A(new Dt),vx=()=>A(new Dt(Dt.ALPHA_TO_COVERAGE));class sl extends D{constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){return e.getFrontFacing()}}const wx=C(sl),Tn=h(wx).mul(2).sub(1);b("FrontFacingNode",sl);const jo=new Map;class Ze extends Du{constructor(){super(),this.isNodeMaterial=!0,this.type=this.constructor.type,this.forceSinglePass=!1,this.fog=!0,this.lights=!0,this.normals=!0,this.colorSpaced=!0,this.lightsNode=null,this.envNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.positionNode=null,this.depthNode=null,this.shadowNode=null,this.outputNode=null,this.fragmentNode=null,this.vertexNode=null}customProgramCacheKey(){return this.type+Ia(this)}build(e){this.setup(e)}setup(e){e.addStack(),e.stack.outputNode=this.vertexNode||this.setupPosition(e),e.addFlow("vertex",e.removeStack()),e.addStack();let t;const s=this.setupClipping(e);if(this.fragmentNode===null){this.depthWrite===!0&&this.setupDepth(e),this.normals===!0&&this.setupNormal(e),this.setupDiffuseColor(e),this.setupVariants(e);const n=this.setupLighting(e);s!==null&&e.stack.add(s),t=this.setupOutput(e,I(n,Se.a)),Vf.assign(t),this.outputNode!==null&&(t=this.outputNode)}else t=this.setupOutput(e,this.fragmentNode);e.stack.outputNode=t,e.addFlow("fragment",e.removeStack())}setupClipping(e){const{globalClippingCount:t,localClippingCount:s}=e.clippingContext;let n=null;return(t||s)&&(this.alphaToCoverage?n=vx():e.stack.add(Nx())),n}setupDepth(e){const{renderer:t}=e;let s=this.depthNode;s===null&&t.logarithmicDepthBuffer===!0&&(s=dr().w.add(1).log2().mul(Fg).mul(.5)),s!==null&&tl.assign(s).append()}setupPosition(e){const{object:t}=e,s=t.geometry;e.addStack(),(s.morphAttributes.position||s.morphAttributes.normal||s.morphAttributes.color)&&lx(t).append(),t.isSkinnedMesh===!0&&ax(t).append(),t.instanceMatrix&&t.instanceMatrix.isInstancedBufferAttribute===!0&&e.isAvailable("instance")===!0&&rx(t).append(),this.positionNode!==null&&Ie.assign(this.positionNode);const n=dr();return e.context.vertex=e.removeStack(),e.context.mvp=n,n}setupDiffuseColor({geometry:e}){let t=this.colorNode?I(this.colorNode):Fs;this.vertexColors===!0&&e.hasAttribute("color")&&(t=I(t.xyz.mul(Pe("color","vec3")),t.a)),Se.assign(t);const s=this.opacityNode?h(this.opacityNode):Ac;if(Se.a.assign(Se.a.mul(s)),this.alphaTestNode!==null||this.alphaTest>0){const n=this.alphaTestNode!==null?h(this.alphaTestNode):jg;Se.a.lessThanEqual(n).discard()}}setupVariants(){}setupNormal(){if(this.flatShading===!0){const e=Ue.dFdx().cross(Ue.dFdy()).normalize();me.assign(e.mul(Tn))}else{const e=this.normalNode?x(this.normalNode):Bg;me.assign(e.mul(Tn))}}getEnvNode(e){let t=null;return this.envNode?t=this.envNode:this.envMap?t=this.envMap.isCubeTexture?Mi(this.envMap):Re(this.envMap):e.environmentNode&&(t=e.environmentNode),t}setupLights(e){const t=this.getEnvNode(e),s=[];t&&s.push(new Zc(t)),e.material.aoMap&&s.push(new kc(Re(e.material.aoMap)));let n=this.lightsNode||e.lightsNode;return s.length>0&&(n=px([...n.lightNodes,...s])),n}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:s,backdropAlphaNode:n,emissiveNode:i}=this,a=this.lights===!0||this.lightsNode!==null?this.setupLights(e):null;let c=Se.rgb;if(a&&a.hasLight!==!1){const l=this.setupLightingModel(e);c=qc(a,l,s,n)}else s!==null&&(c=x(n!==null?Ve(c,s,n):s));return(i&&i.isNode===!0||t.emissive&&t.emissive.isColor===!0)&&(c=c.add(x(i||Ug))),c}setupOutput(e,t){const s=e.renderer,n=e.toneMappingNode;if(this.toneMapped===!0&&n&&(t=I(n.context({color:t.rgb}),t.a)),this.fog===!0){const i=e.fogNode;i&&(t=I(i.mixAssign(t.rgb),t.a))}if(this.colorSpaced===!0){const i=s.currentColorSpace;i!==Cn&&i!==sa&&(t=t.linearToColorSpace(i))}return t}setDefaultValues(e){for(const s in e){const n=e[s];this[s]===void 0&&(this[s]=n,n&&n.clone&&(this[s]=n.clone()))}Object.assign(this.defines,e.defines);const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const s in t)Object.getOwnPropertyDescriptor(this.constructor.prototype,s)===void 0&&t[s].get!==void 0&&Object.defineProperty(this.constructor.prototype,s,t[s])}toJSON(e){const t=e===void 0||typeof e=="string";t&&(e={textures:{},images:{},nodes:{}});const s=ks.prototype.toJSON.call(this,e),n=pn(this);s.inputNodes={};for(const{property:r,childNode:a}of n)s.inputNodes[r]=a.toJSON(e).uuid;function i(r){const a=[];for(const c in r){const l=r[c];delete l.metadata,a.push(l)}return a}if(t){const r=i(e.textures),a=i(e.images),c=i(e.nodes);r.length>0&&(s.textures=r),a.length>0&&(s.images=a),c.length>0&&(s.nodes=c)}return s}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.positionNode=e.positionNode,this.depthNode=e.depthNode,this.shadowNode=e.shadowNode,this.outputNode=e.outputNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}static fromMaterial(e){if(e.isNodeMaterial===!0)return e;const t=e.type.replace("Material","NodeMaterial"),s=Zn(t);if(s===void 0)throw new Error(`NodeMaterial: Material "${e.type}" is not compatible.`);for(const n in e)s[n]=e[n];return s}}function Be(o,e){if(typeof e!="function"||!o)throw new Error(`Node material ${o} is not a class`);if(jo.has(o)){console.warn(`Redefinition of node material ${o}`);return}jo.set(o,e),e.type=o}function Zn(o){const e=jo.get(o);if(e!==void 0)return new e}Be("NodeMaterial",Ze);class Jt{constructor(e,t=null){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class Tx extends Jt{constructor(e,t=0){super(e,t),this.isFloatUniform=!0,this.boundary=4,this.itemSize=1}}class bx extends Jt{constructor(e,t=new oe){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class _x extends Jt{constructor(e,t=new J){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class Sx extends Jt{constructor(e,t=new it){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class Cx extends Jt{constructor(e,t=new Je){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class Mx extends Jt{constructor(e,t=new Zr){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class Ox extends Jt{constructor(e,t=new hs){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class Ex extends Tx{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Ax extends bx{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Vx extends _x{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Lx extends Sx{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Px extends Cx{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Rx extends Mx{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Ix extends Ox{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}}class Ei extends D{constructor(e,t,s=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=s}getNodeType(e){const t=this.ifNode.getNodeType(e);if(this.elseNode!==null){const s=this.elseNode.getNodeType(e);if(e.getTypeLength(s)>e.getTypeLength(t))return s}return t}generate(e,t){const s=this.getNodeType(e),n={tempWrite:!1},i=e.getDataFromNode(this);if(i.nodeProperty!==void 0)return i.nodeProperty;const{ifNode:r,elseNode:a}=this,c=t!=="void",l=c?Me(s).build(e):"";i.nodeProperty=l;const d=bt(this.condNode).build(e,"bool");e.addFlowCode(`
${e.tab}if ( ${d} ) {

`).addFlowTab();let u=bt(r,n).build(e,s);if(u&&(c?u=l+" = "+u+";":u="return "+u+";"),e.removeFlowTab().addFlowCode(e.tab+"	"+u+`

`+e.tab+"}"),a!==null){e.addFlowCode(` else {

`).addFlowTab();let m=bt(a,n).build(e,s);m&&(c?m=l+" = "+m+";":m="return "+m+";"),e.removeFlowTab().addFlowCode(e.tab+"	"+m+`

`+e.tab+`}

`)}else e.addFlowCode(`

`);return e.format(l,s,t)}}const Lt=y(Ei);g("cond",Lt);b("CondNode",Ei);class nl extends D{constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}add(e){return this.nodes.push(e),this}if(e,t){const s=new Es(t);return this._currentCond=Lt(e,s),this.add(this._currentCond)}elseif(e,t){const s=new Es(t),n=Lt(e,s);return this._currentCond.elseNode=n,this._currentCond=n,this}else(e){return this._currentCond.elseNode=new Es(e),this}build(e,...t){const s=Ga();mn(this);for(const n of this.nodes)n.build(e,"void");return mn(s),this.outputNode?this.outputNode.build(e,...t):super.build(e,...t)}}const fr=y(nl);b("StackNode",nl);class Dx extends Fu{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const s=t.minFilter,n=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i=new zu(5,5,5),r=Oi(Rc),a=Zn("MeshBasicNodeMaterial");a.colorNode=Re(t,r,0),a.side=ju,a.blending=$u;const c=new is(i,a),l=new Kr;return l.add(c),t.minFilter===ta&&(t.minFilter=Uu),new Wu(1,10,this).update(e,l),t.minFilter=s,t.currentGenerateMipmaps=n,c.geometry.dispose(),c.material.dispose(),this}}const Fx=Dx;class zx{constructor(){this.weakMap=new WeakMap}get(e){if(Array.isArray(e)){let t=this.weakMap;for(let s=0;s<e.length;s++)if(t=t.get(e[s]),t===void 0)return;return t.get(e[e.length-1])}else return super.get(e)}set(e,t){if(Array.isArray(e)){let s=this.weakMap;for(let n=0;n<e.length;n++){const i=e[n];s.has(i)===!1&&s.set(i,new WeakMap),s=s.get(i)}return s.set(e[e.length-1],t)}else return super.set(e,t)}delete(e){if(Array.isArray(e)){let t=this.weakMap;for(let s=0;s<e.length;s++)if(t=t.get(e[s]),t===void 0)return!1;return t.delete(e[e.length-1])}else return super.delete(e)}dispose(){this.weakMap.clear()}}const gr=new zx,jx=new Map([[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),$x=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),rn=o=>(o=Number(o),o+(o%1?"":".0"));class Ux{constructor(e,t,s,n=null,i=null){this.object=e,this.material=i||e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=s,this.scene=n,this.nodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.hashNodes={},this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.toneMappingNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:[]},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:[],fragment:[],compute:[]},this.bindingsOffset={vertex:0,fragment:0,compute:0},this.bindingsArray=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.flow={code:""},this.chaining=[],this.stack=fr(),this.stacks=[],this.tab="	",this.currentFunctionNode=null,this.context={keywords:new Ef,material:this.material},this.cache=new Qa,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null}getRenderTarget(e,t,s){return new Rt(e,t,s)}getCubeRenderTarget(e,t){return new Fx(e,t)}includes(e){return this.nodes.includes(e)}_getSharedBindings(e){const t=[];for(const s of e)if(s.shared===!0){const n=s.getNodes();let i=gr.get(n);i===void 0&&(gr.set(n,s),i=s),t.push(i)}else t.push(s);return t}getBindings(){let e=this.bindingsArray;if(e===null){const t=this.bindings;this.bindingsArray=e=this._getSharedBindings(this.material!==null?[...t.vertex,...t.fragment]:t.compute)}return e}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){this.nodes.includes(e)===!1&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}buildUpdateNodes(){for(const e of this.nodes){const t=e.getUpdateType(),s=e.getUpdateBeforeType();t!==H.NONE&&this.updateNodes.push(e.getSelf()),s!==H.NONE&&this.updateBeforeNodes.push(e)}}get currentNode(){return this.chaining[this.chaining.length-1]}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}setCache(e){this.cache=e}getCache(){return this.cache}isAvailable(){return!1}getVertexIndex(){console.warn("Abstract function.")}getInstanceIndex(){console.warn("Abstract function.")}getFrontFacing(){console.warn("Abstract function.")}getFragCoord(){console.warn("Abstract function.")}isFlipY(){return!1}generateTexture(){console.warn("Abstract function.")}generateTextureLod(){console.warn("Abstract function.")}generateConst(e,t=null){if(t===null&&(e==="float"||e==="int"||e==="uint"?t=0:e==="bool"?t=!1:e==="color"?t=new Je:e==="vec2"?t=new oe:e==="vec3"?t=new J:e==="vec4"&&(t=new it)),e==="float")return rn(t);if(e==="int")return`${Math.round(t)}`;if(e==="uint")return t>=0?`${Math.round(t)}u`:"0u";if(e==="bool")return t?"true":"false";if(e==="color")return`${this.getType("vec3")}( ${rn(t.r)}, ${rn(t.g)}, ${rn(t.b)} )`;const s=this.getTypeLength(e),n=this.getComponentType(e),i=r=>this.generateConst(n,r);if(s===2)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)} )`;if(s===3)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)}, ${i(t.z)} )`;if(s===4)return`${this.getType(e)}( ${i(t.x)}, ${i(t.y)}, ${i(t.z)}, ${i(t.w)} )`;if(s>4&&t&&(t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(i).join(", ")} )`;if(s>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return e==="color"?"vec3":e}generateMethod(e){return e}hasGeometryAttribute(e){return this.geometry&&this.geometry.getAttribute(e)!==void 0}getAttribute(e,t){const s=this.attributes;for(const i of s)if(i.name===e)return i;const n=new ir(e,t);return s.push(n),n}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return e==="void"||e==="property"||e==="sampler"||e==="texture"||e==="cubeTexture"||e==="storageTexture"}needsColorSpaceToLinear(){return!1}getTextureColorSpaceFromMap(e){let t;return e&&e.isTexture?t=e.colorSpace:e&&e.isWebGLRenderTarget?t=e.texture.colorSpace:t=sa,t}getComponentType(e){if(e=this.getVectorType(e),e==="float"||e==="bool"||e==="int"||e==="uint")return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return t===null?null:t[1]==="b"?"bool":t[1]==="i"?"int":t[1]==="u"?"uint":"float"}getVectorType(e){return e==="color"?"vec3":e==="texture"||e==="cubeTexture"||e==="storageTexture"?"vec4":e}getTypeFromLength(e,t="float"){if(e===1)return t;const s=jx.get(e);return(t==="float"?"":t[0])+s}getTypeFromArray(e){return $x.get(e.constructor)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const s=t.array,n=e.itemSize,i=e.normalized;let r;return!(e instanceof Gu)&&i!==!0&&(r=this.getTypeFromArray(s)),this.getTypeFromLength(n,r)}getTypeLength(e){const t=this.getVectorType(e),s=/vec([2-4])/.exec(t);return s!==null?Number(s[1]):t==="float"||t==="bool"||t==="int"||t==="uint"?1:/mat2/.test(e)===!0?4:/mat3/.test(e)===!0?9:/mat4/.test(e)===!0?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return t==="int"||t==="uint"?e:this.changeComponentType(e,"int")}addStack(){return this.stack=fr(this.stack),this.stacks.push(Ga()||this.stack),mn(this.stack),this.stack}removeStack(){const e=this.stack;return this.stack=e.parent,mn(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,s=null){s=s===null?e.isGlobal(this)?this.globalCache:this.cache:s;let n=s.getNodeData(e);return n===void 0&&(n={},s.setNodeData(e,n)),n[t]===void 0&&(n[t]={}),n[t]}getNodeProperties(e,t="any"){const s=this.getDataFromNode(e,t);return s.properties||(s.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const s=this.getDataFromNode(e);let n=s.bufferAttribute;if(n===void 0){const i=this.uniforms.index++;n=new ir("nodeAttribute"+i,t,e),this.bufferAttributes.push(n),s.bufferAttribute=n}return n}getStructTypeFromNode(e,t=this.shaderStage){const s=this.getDataFromNode(e,t);if(s.structType===void 0){const n=this.structs.index++;e.name=`StructType${n}`,this.structs[t].push(e),s.structType=e}return e}getUniformFromNode(e,t,s=this.shaderStage,n=null){const i=this.getDataFromNode(e,s,this.globalCache);let r=i.uniform;if(r===void 0){const a=this.uniforms.index++;r=new Cf(n||"nodeUniform"+a,t,e),this.uniforms[s].push(r),i.uniform=r}return r}getVarFromNode(e,t=null,s=e.getNodeType(this),n=this.shaderStage){const i=this.getDataFromNode(e,n);let r=i.variable;if(r===void 0){const a=this.vars[n]||(this.vars[n]=[]);t===null&&(t="nodeVar"+a.length),r=new tc(t,s),a.push(r),i.variable=r}return r}getVaryingFromNode(e,t=null,s=e.getNodeType(this)){const n=this.getDataFromNode(e,"any");let i=n.varying;if(i===void 0){const r=this.varyings,a=r.length;t===null&&(t="nodeVarying"+a),i=new Mf(t,s),r.push(i),n.varying=i}return i}getCodeFromNode(e,t,s=this.shaderStage){const n=this.getDataFromNode(e);let i=n.code;if(i===void 0){const r=this.codes[s]||(this.codes[s]=[]),a=r.length;i=new Of("nodeCode"+a,t),r.push(i),n.code=i}return i}addLineFlowCode(e){return e===""?this:(e=this.tab+e,/;\s*$/.test(e)||(e=e+`;
`),this.flow.code+=e,this)}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="	",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),s=this.flowChildNode(e,t);return this.flowsData.set(e,s),s}buildFunctionNode(e){const t=new oc,s=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=s,t}flowShaderNode(e){const t=e.layout;let s;if(e.isArrayInput){s=[];for(const r of t.inputs)s.push(new Ro(r.type,r.name))}else{s={};for(const r of t.inputs)s[r.name]=new Ro(r.type,r.name)}e.layout=null;const n=e.call(s),i=this.flowStagesNode(n,t.type);return e.layout=t,i}flowStagesNode(e,t=null){const s=this.flow,n=this.vars,i=this.buildStage,r={code:""};this.flow=r,this.vars={};for(const a of er)this.setBuildStage(a),r.result=e.build(this,t);return r.vars=this.getVars(this.shaderStage),this.flow=s,this.vars=n,this.setBuildStage(i),r}getFunctionOperator(){return null}flowChildNode(e,t=null){const s=this.flow,n={code:""};return this.flow=n,n.result=e.build(this,t),this.flow=s,n}flowNodeFromShaderStage(e,t,s=null,n=null){const i=this.shaderStage;this.setShaderStage(e);const r=this.flowChildNode(t,s);return n!==null&&(r.code+=`${this.tab+n} = ${r.result};
`),this.flowCode[e]=this.flowCode[e]+r.code,this.setShaderStage(i),r}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn("Abstract function.")}getVaryings(){console.warn("Abstract function.")}getVar(e,t){return`${this.getType(e)} ${t}`}getVars(e){let t="";const s=this.vars[e];if(s!==void 0)for(const n of s)t+=`${this.getVar(n.type,n.name)}; `;return t}getUniforms(){console.warn("Abstract function.")}getCodes(e){const t=this.codes[e];let s="";if(t!==void 0)for(const n of t)s+=n.code+`
`;return s}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn("Abstract function.")}build(e=!0){const{object:t,material:s}=this;e&&(s!==null?Ze.fromMaterial(s).build(this):this.addFlow("compute",t));for(const n of er){this.setBuildStage(n),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const i of zm){this.setShaderStage(i);const r=this.flowNodes[i];for(const a of r)n==="generate"?this.flowNode(a):a.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if(t==="float")return new Ex(e);if(t==="vec2")return new Ax(e);if(t==="vec3")return new Vx(e);if(t==="vec4")return new Lx(e);if(t==="color")return new Px(e);if(t==="mat3")return new Rx(e);if(t==="mat4")return new Ix(e);throw new Error(`Uniform "${t}" not declared.`)}createNodeMaterial(e="NodeMaterial"){return Zn(e)}format(e,t,s){if(t=this.getVectorType(t),s=this.getVectorType(s),t===s||s===null||this.isReference(s))return e;const n=this.getTypeLength(t),i=this.getTypeLength(s);return n>4||i>4||i===0?e:n===i?`${this.getType(s)}( ${e} )`:n>i?this.format(`${e}.${"xyz".slice(0,i)}`,this.getTypeFromLength(i,this.getComponentType(t)),s):i===4&&n>1?`${this.getType(s)}( ${this.format(e,t,"vec3")}, 1.0 )`:n===2?`${this.getType(s)}( ${this.format(e,t,"vec2")}, 0.0 )`:(n===1&&i>1&&t[0]!==s[0]&&(e=`${this.getType(this.getComponentType(s))}( ${e} )`),`${this.getType(s)}( ${e} )`)}getSignature(){return`// Three.js r${Hu} - NodeMaterial System
`}}class ol{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.startTime=null,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let s=e.get(t);return s===void 0&&(s={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,s)),s}updateBeforeNode(e){const t=e.getUpdateBeforeType(),s=e.setReference(this);if(t===H.FRAME){const{frameMap:n}=this._getMaps(this.updateBeforeMap,s);n.get(e)!==this.frameId&&e.updateBefore(this)!==!1&&n.set(e,this.frameId)}else if(t===H.RENDER){const{renderMap:n}=this._getMaps(this.updateBeforeMap,s);n.get(e)!==this.renderId&&e.updateBefore(this)!==!1&&n.set(e,this.renderId)}else t===H.OBJECT&&e.updateBefore(this)}updateNode(e){const t=e.getUpdateType(),s=e.setReference(this);if(t===H.FRAME){const{frameMap:n}=this._getMaps(this.updateMap,s);n.get(e)!==this.frameId&&e.update(this)!==!1&&n.set(e,this.frameId)}else if(t===H.RENDER){const{renderMap:n}=this._getMaps(this.updateMap,s);n.get(e)!==this.renderId&&e.update(this)!==!1&&n.set(e,this.renderId)}else t===H.OBJECT&&e.update(this)}update(){this.frameId++,this.lastTime===void 0&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}}class il{constructor(e,t,s=null,n="",i=!1){this.type=e,this.name=t,this.count=s,this.qualifier=n,this.isConst=i}}il.isNodeFunctionInput=!0;class rl extends D{constructor(e){super(),this.types=e,this.isStructTypeNode=!0}getMemberTypes(){return this.types}}b("StructTypeNode",rl);class al extends D{constructor(...e){super(),this.isOutputStructNode=!0,this.members=e}setup(e){super.setup(e);const t=this.members,s=[];for(let n=0;n<t.length;n++)s.push(t[n].getNodeType(e));this.nodeType=e.getStructTypeFromNode(new rl(s)).name}generate(e,t){const s=e.getVarFromNode(this);s.isOutputStructVar=!0;const n=e.getPropertyName(s),i=this.members,r=n!==""?n+".":"";for(let a=0;a<i.length;a++){const c=i[a].build(e,t);e.addLineFlowCode(`${r}m${a} = ${c}`)}return n}}y(al);b("OutputStructNode",al);class cl extends D{constructor(e){super(),this.seedNode=e}setup(){const e=this.seedNode.uint().mul(747796405).add(2891336453),t=e.shiftRight(e.shiftRight(28).add(4)).bitXor(e).mul(277803737);return t.shiftRight(22).bitXor(t).float().mul(1/2**32)}}const Wx=y(cl);g("hash",Wx);b("HashNode",cl);const $o=(o,e)=>st(G(4,o.mul(he(1,o))),e),Gx=(o,e)=>o.lessThan(.5)?$o(o.mul(2),e).div(2):he(1,$o(G(he(1,o),2),e).div(2)),Hx=(o,e,t)=>st(Bt(st(o,e),He(st(o,e),st(he(1,o),t))),1/e),kx=(o,e)=>wt(rr.mul(e.mul(o).sub(1))).div(rr.mul(e.mul(o).sub(1)));g("parabola",$o);g("gain",Gx);g("pcurve",Hx);g("sinc",kx);const lt=_(([o])=>o.fract().sub(.5).abs()),ll=_(([o])=>x(lt(o.z.add(lt(o.y.mul(1)))),lt(o.z.add(lt(o.x.mul(1)))),lt(o.y.add(lt(o.x.mul(1)))))),Bx=_(([o,e,t])=>{const s=x(o).toVar(),n=h(1.4).toVar(),i=h(0).toVar(),r=x(s).toVar();return ie({start:h(0),end:h(3),type:"float",condition:"<="},()=>{const a=x(ll(r.mul(2))).toVar();s.addAssign(a.add(t.mul(h(.1).mul(e)))),r.mulAssign(1.8),n.mulAssign(1.5),s.mulAssign(1.2);const c=h(lt(s.z.add(lt(s.x.add(lt(s.y)))))).toVar();i.addAssign(c.div(n)),r.addAssign(.14)}),i});lt.setLayout({name:"tri",type:"float",inputs:[{name:"x",type:"float"}]});ll.setLayout({name:"tri3",type:"vec3",inputs:[{name:"p",type:"vec3"}]});Bx.setLayout({name:"triNoise3D",type:"float",inputs:[{name:"p",type:"vec3"},{name:"spd",type:"float"},{name:"time",type:"float"}]});let go;class dl extends Ei{constructor(e){go=go||_i("discard"),super(e,go)}}const qx=y(dl),Yx=o=>qx(o).append();g("discard",Yx);b("DiscardNode",dl);class ul extends D{constructor(e=[],...t){super(),this.functionNodes=e,this.parametersNodes=t,this._candidateFnCall=null}getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(e){const t=this.parametersNodes;let s=this._candidateFnCall;if(s===null){let n=null,i=-1;for(const r of this.functionNodes){const c=r.shaderNode.layout;if(c===null)throw new Error("FunctionOverloadingNode: FunctionNode must be a layout.");const l=c.inputs;if(t.length===l.length){let d=0;for(let u=0;u<t.length;u++){const m=t[u],w=l[u];m.getNodeType(e)===w.type?d++:d=0}d>i&&(n=r,i=d)}}this._candidateFnCall=s=n(...t)}return s}}const Kx=y(ul),qe=o=>(...e)=>Kx(o,...e);b("FunctionOverloadingNode",ul);class hl extends se{constructor(){super("vec2")}setup(){const e=x(ge.z,0,ge.x.negate()).normalize(),t=ge.cross(e);return j(e.dot(me),t.dot(me)).mul(.495).add(.5)}}C(hl);b("MatcapUVNode",hl);class We extends Zt{constructor(e=We.LOCAL,t=1,s=0){super(s),this.scope=e,this.scale=t,this.updateType=H.FRAME}update(e){const t=this.scope,s=this.scale;t===We.LOCAL?this.value+=e.deltaTime*s:t===We.DELTA?this.value=e.deltaTime*s:t===We.FRAME?this.value=e.frameId:this.value=e.time*s}serialize(e){super.serialize(e),e.scope=this.scope,e.scale=this.scale}deserialize(e){super.deserialize(e),this.scope=e.scope,this.scale=e.scale}}We.LOCAL="local";We.GLOBAL="global";We.DELTA="delta";We.FRAME="frame";const pl=(o,e=0)=>A(new We(We.LOCAL,o,e));C(We,We.FRAME).uint();b("TimerNode",We);class ve extends D{constructor(e=ve.SINE,t=pl()){super(),this.method=e,this.timeNode=t}getNodeType(e){return this.timeNode.getNodeType(e)}setup(){const e=this.method,t=A(this.timeNode);let s=null;return e===ve.SINE?s=t.add(.75).mul(Math.PI*2).sin().mul(.5).add(.5):e===ve.SQUARE?s=t.fract().round():e===ve.TRIANGLE?s=t.add(.5).fract().mul(2).sub(1).abs():e===ve.SAWTOOTH&&(s=t.fract()),s}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}ve.SINE="sine";ve.SQUARE="square";ve.TRIANGLE="triangle";ve.SAWTOOTH="sawtooth";y(ve,ve.SINE);y(ve,ve.SQUARE);y(ve,ve.TRIANGLE);y(ve,ve.SAWTOOTH);b("OscNode",ve);class gt extends se{constructor(e,t){super(),this.scope=e,this.node=t}getNodeType(e){return this.node.getNodeType(e)}setup(){const{scope:e,node:t}=this;let s=null;return e===gt.DIRECTION_TO_COLOR?s=t.mul(.5).add(.5):e===gt.COLOR_TO_DIRECTION&&(s=t.mul(2).sub(1)),s}}gt.DIRECTION_TO_COLOR="directionToColor";gt.COLOR_TO_DIRECTION="colorToDirection";const ml=y(gt,gt.DIRECTION_TO_COLOR),Zx=y(gt,gt.COLOR_TO_DIRECTION);g("directionToColor",ml);g("colorToDirection",Zx);b("PackingNode",gt);class Ai extends D{constructor(e,t,s,n=h(0),i=h(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=s,this.outLowNode=n,this.outHighNode=i,this.doClamp=!0}setup(){const{node:e,inLowNode:t,inHighNode:s,outLowNode:n,outHighNode:i,doClamp:r}=this;let a=e.sub(t).div(s.sub(t));return r===!0&&(a=a.clamp()),a.mul(i.sub(n)).add(n)}}const fl=y(Ai,null,null,{doClamp:!1}),Qx=y(Ai);g("remap",fl);g("remapClamp",Qx);b("RemapNode",Ai);class gl extends se{constructor(e,t,s=j(.5)){super("vec2"),this.uvNode=e,this.rotationNode=t,this.centerNode=s}setup(){const{uvNode:e,rotationNode:t,centerNode:s}=this;return e.sub(s).rotate(t).add(s)}}const Xx=y(gl);g("rotateUV",Xx);b("RotateUVNode",gl);class xl extends se{constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){const{rotationNode:t,positionNode:s}=this;if(this.getNodeType(e)==="vec2"){const i=t.cos(),r=t.sin();return Ba(i,r,r.negate(),i).mul(s)}else{const i=t,r=As(I(1,0,0,0),I(0,At(i.x),wt(i.x).negate(),0),I(0,wt(i.x),At(i.x),0),I(0,0,0,1)),a=As(I(At(i.y),0,wt(i.y),0),I(0,1,0,0),I(wt(i.y).negate(),0,At(i.y),0),I(0,0,0,1)),c=As(I(At(i.z),wt(i.z).negate(),0,0),I(wt(i.z),At(i.z),0,0),I(0,0,1,0),I(0,0,0,1));return r.mul(a).mul(c).mul(I(s,1)).xyz}}}const Jx=y(xl);g("rotate",Jx);b("RotateNode",xl);class yl extends D{constructor(e,t=fe(),s=h(0)){super("vec2"),this.countNode=e,this.uvNode=t,this.frameNode=s}setup(){const{frameNode:e,uvNode:t,countNode:s}=this,{width:n,height:i}=s,r=e.mod(n.mul(i)).floor(),a=r.mod(n),c=i.sub(r.add(1).div(n).ceil()),l=s.reciprocal(),d=j(a,c);return t.add(d).mul(l)}}y(yl);b("SpriteSheetUVNode",yl);class Nl extends xs{constructor(e,t){super(e,t),this.isStorageArrayElementNode=!0}set storageBufferNode(e){this.node=e}get storageBufferNode(){return this.node}setup(e){return e.isAvailable("storageBuffer")===!1&&!this.node.instanceIndex&&this.node.bufferObject===!0&&e.setupPBO(this.node),super.setup(e)}generate(e,t){let s;const n=e.context.assign;if(e.isAvailable("storageBuffer")===!1){const{node:i}=this;!i.instanceIndex&&this.node.bufferObject===!0&&n!==!0?s=e.generatePBO(this):s=i.build(e)}else s=super.generate(e);if(n!==!0){const i=this.getNodeType(e);s=e.format(s,i,t)}return s}}const vl=y(Nl);g("storageElement",vl);b("StorageArrayElementNode",Nl);class wl extends D{constructor(e,t=null,s=null,n=h(1),i=Ie,r=ft){super("vec4"),this.textureXNode=e,this.textureYNode=t,this.textureZNode=s,this.scaleNode=n,this.positionNode=i,this.normalNode=r}setup(){const{textureXNode:e,textureYNode:t,textureZNode:s,scaleNode:n,positionNode:i,normalNode:r}=this;let a=r.abs().normalize();a=a.div(a.dot(x(1)));const c=i.yz.mul(n),l=i.zx.mul(n),d=i.xy.mul(n),u=e.value,m=t!==null?t.value:u,w=s!==null?s.value:u,T=Re(u,c).mul(a.x),N=Re(m,l).mul(a.y),v=Re(w,d).mul(a.z);return He(T,N,v)}}const ey=y(wl),ty=(...o)=>ey(...o);g("triplanarTexture",ty);b("TriplanarTexturesNode",wl);new ku;new J;new J;new J;new hs;new J(0,0,-1);new it;new J;new J;new it;new oe;new Rt;j(zs.x.oneMinus(),zs.y);class we extends D{constructor(e=we.LOCAL){super("vec3"),this.scope=e}getHash(){return`bitangent-${this.scope}`}generate(e){const t=this.scope;let s;t===we.GEOMETRY?s=Nn.cross(vn):t===we.LOCAL?s=ft.cross(qn):t===we.VIEW?s=_t.cross(Yn):t===we.WORLD&&(s=kn.cross(zc));const n=s.mul(vn.w).xyz;return Ke(ue(n)).build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}we.GEOMETRY="geometry";we.LOCAL="local";we.VIEW="view";we.WORLD="world";C(we,we.GEOMETRY);C(we,we.LOCAL);const sy=C(we,we.VIEW);C(we,we.WORLD);const ny=Ke(me.cross(jc).mul(vn.w));Ke(ny.transformDirection($t));b("BitangentNode",we);const Tl=ht(Yn,sy,_t);ge.mul(Tl);class bl extends Wn{constructor(e=0){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){const e=this.index;return"color"+(e>0?e:"")}generate(e){const t=this.getAttributeName(e),s=e.hasGeometryAttribute(t);let n;return s===!0?n=super.generate(e):n=e.generateConst(this.nodeType,new it(1,1,1,1)),n}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}const oy=(...o)=>A(new bl(...o));b("VertexColorNode",bl);const Qn=1/6,_l=o=>G(Qn,G(o,G(o,o.negate().add(3)).sub(3)).add(1)),Uo=o=>G(Qn,G(o,G(o,G(3,o).sub(6))).add(4)),Sl=o=>G(Qn,G(o,G(o,G(-3,o).add(3)).add(3)).add(1)),Wo=o=>G(Qn,st(o,3)),xr=o=>_l(o).add(Uo(o)),yr=o=>Sl(o).add(Wo(o)),Nr=o=>He(-1,Uo(o).div(_l(o).add(Uo(o)))),vr=o=>He(1,Wo(o).div(Sl(o).add(Wo(o)))),wr=(o,e,t)=>{const s=o.uvNode,n=G(s,e.zw).add(.5),i=ys(n),r=bi(n),a=xr(r.x),c=yr(r.x),l=Nr(r.x),d=vr(r.x),u=Nr(r.y),m=vr(r.y),w=j(i.x.add(l),i.y.add(u)).sub(.5).mul(e.xy),T=j(i.x.add(d),i.y.add(u)).sub(.5).mul(e.xy),N=j(i.x.add(l),i.y.add(m)).sub(.5).mul(e.xy),v=j(i.x.add(d),i.y.add(m)).sub(.5).mul(e.xy),O=xr(r.y).mul(He(a.mul(o.uv(w).level(t)),c.mul(o.uv(T).level(t)))),P=yr(r.y).mul(He(a.mul(o.uv(N).level(t)),c.mul(o.uv(v).level(t))));return O.add(P)},iy=(o,e)=>{const t=j(o.size(p(e))),s=j(o.size(p(e.add(1)))),n=Bt(1,t),i=Bt(1,s),r=wr(o,I(n,t),ys(e)),a=wr(o,I(i,s),Ti(e));return bi(e).mix(r,a)};class Cl extends se{constructor(e,t=h(3)){super("vec4"),this.textureNode=e,this.blurNode=t}setup(){return iy(this.textureNode,this.blurNode)}}const ry=y(Cl);g("bicubic",ry);b("TextureBicubicNode",Cl);class Ml extends D{constructor(){super("vec2"),this.isPointUVNode=!0}generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}}C(Ml);b("PointUVNode",Ml);class nt extends D{constructor(e=nt.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}setup(e){const t=this.scope,s=this.scene!==null?this.scene:e.scene;let n;return t===nt.BACKGROUND_BLURRINESS?n=mt("backgroundBlurriness","float",s):t===nt.BACKGROUND_INTENSITY?n=mt("backgroundIntensity","float",s):console.error("THREE.SceneNode: Unknown scope:",t),n}}nt.BACKGROUND_BLURRINESS="backgroundBlurriness";nt.BACKGROUND_INTENSITY="backgroundIntensity";C(nt,nt.BACKGROUND_BLURRINESS);C(nt,nt.BACKGROUND_INTENSITY);b("SceneNode",nt);class ay extends Hn{constructor(e,t,s=0){super(e,t,s),this.isStorageBufferNode=!0,this.bufferObject=!1,this._attribute=null,this._varying=null}getInputType(){return"storageBuffer"}element(e){return vl(this,e)}setBufferObject(e){return this.bufferObject=e,this}generate(e){if(e.isAvailable("storageBuffer"))return super.generate(e);const t=this.getNodeType(e);this._attribute===null&&(this._attribute=Bn(this.value),this._varying=ue(this._attribute));const s=this._varying.build(e,t);return e.registerTransform(s,this._attribute),s}}b("StorageBufferNode",ay);class Ol extends Ns{constructor(e,t,s=null){super(e,t),this.storeNode=s,this.isStoreTextureNode=!0}getInputType(){return"storageTexture"}setup(e){super.setup(e);const t=e.getNodeProperties(this);t.storeNode=this.storeNode}generate(e,t){let s;return this.storeNode!==null?s=this.generateStore(e):s=super.generate(e,t),s}generateStore(e){const t=e.getNodeProperties(this),{uvNode:s,storeNode:n}=t,i=super.generate(e,"property"),r=s.build(e,"uvec2"),a=n.build(e,"vec4"),c=e.generateTextureStore(e,i,r,a);e.addLineFlowCode(c)}}y(Ol);b("TextureStoreNode",Ol);class cy extends tn{constructor(e,t,s=null){super(e,t,s),this.userData=s}update(e){this.reference=this.userData!==null?this.userData:e.object.userData,super.update(e)}}b("UserDataNode",cy);const ly=_(({base:o,blend:e})=>{const t=s=>e[s].lessThan(dc).cond(e[s],o[s].oneMinus().div(e[s]).oneMinus().max(0));return x(t("x"),t("y"),t("z"))}).setLayout({name:"burnColor",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),dy=_(({base:o,blend:e})=>{const t=s=>e[s].equal(1).cond(e[s],o[s].div(e[s].oneMinus()).max(0));return x(t("x"),t("y"),t("z"))}).setLayout({name:"dodgeColor",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),uy=_(({base:o,blend:e})=>{const t=s=>o[s].oneMinus().mul(e[s].oneMinus()).oneMinus();return x(t("x"),t("y"),t("z"))}).setLayout({name:"screenColor",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),hy=_(({base:o,blend:e})=>{const t=s=>o[s].lessThan(.5).cond(o[s].mul(e[s],2),o[s].oneMinus().mul(e[s].oneMinus()).oneMinus());return x(t("x"),t("y"),t("z"))}).setLayout({name:"overlayColor",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]});class Ce extends se{constructor(e,t,s){super(),this.blendMode=e,this.baseNode=t,this.blendNode=s}setup(){const{blendMode:e,baseNode:t,blendNode:s}=this,n={base:t,blend:s};let i=null;return e===Ce.BURN?i=ly(n):e===Ce.DODGE?i=dy(n):e===Ce.SCREEN?i=uy(n):e===Ce.OVERLAY&&(i=hy(n)),i}}Ce.BURN="burn";Ce.DODGE="dodge";Ce.SCREEN="screen";Ce.OVERLAY="overlay";const py=y(Ce,Ce.BURN),my=y(Ce,Ce.DODGE),fy=y(Ce,Ce.OVERLAY),gy=y(Ce,Ce.SCREEN);g("burn",py);g("dodge",my);g("overlay",fy);g("screen",gy);b("BlendModeNode",Ce);const xy=_(({textureNode:o,bumpScale:e})=>{let t=o;if(t.isTextureNode!==!0&&t.traverse(r=>{r.isTextureNode===!0&&(t=r)}),t.isTextureNode!==!0)throw new Error("THREE.TSL: dHdxy_fwd() requires a TextureNode.");const s=h(o),n=t.uvNode||fe(),i=r=>o.cache().context({getUV:()=>r,forceUVContext:!0});return j(h(i(n.add(n.dFdx()))).sub(s),h(i(n.add(n.dFdy()))).sub(s)).mul(e)}),yy=_(o=>{const{surf_pos:e,surf_norm:t,dHdxy:s}=o,n=e.dFdx().normalize(),i=e.dFdy().normalize(),r=t,a=i.cross(r),c=r.cross(n),l=n.dot(a).mul(Tn),d=l.sign().mul(s.x.mul(a).add(s.y.mul(c)));return l.abs().mul(t).sub(d).normalize()});class El extends se{constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){const e=this.scaleNode!==null?this.scaleNode:1,t=xy({textureNode:this.textureNode,bumpScale:e});return yy({surf_pos:Ue,surf_norm:_t,dHdxy:t})}}const Ny=y(El);g("bumpMap",Ny);b("BumpMapNode",El);const vy=_(({color:o,adjustment:e})=>e.mix(Vi(o.rgb),o.rgb)),wy=_(({color:o,adjustment:e})=>{const t=He(o.r,o.g,o.b).div(3),s=o.r.max(o.g.max(o.b)),n=s.sub(t).mul(e).mul(-3);return Ve(o.rgb,s,n)}),Ty=_(({color:o,adjustment:e})=>{const t=x(.57735,.57735,.57735),s=e.cos();return x(o.rgb.mul(s).add(t.cross(o.rgb).mul(e.sin()).add(t.mul(Qt(t,o.rgb).mul(s.oneMinus())))))});class Ge extends se{constructor(e,t,s=h(1)){super("vec3"),this.method=e,this.colorNode=t,this.adjustmentNode=s}setup(){const{method:e,colorNode:t,adjustmentNode:s}=this,n={color:t,adjustment:s};let i=null;return e===Ge.SATURATION?i=vy(n):e===Ge.VIBRANCE?i=wy(n):e===Ge.HUE?i=Ty(n):console.error(`${this.type}: Method "${this.method}" not supported!`),i}}Ge.SATURATION="saturation";Ge.VIBRANCE="vibrance";Ge.HUE="hue";const Al=y(Ge,Ge.SATURATION),by=y(Ge,Ge.VIBRANCE),_y=y(Ge,Ge.HUE),Sy=x(.2125,.7154,.0721),Vi=(o,e=Sy)=>Qt(o,e),Vl=(o,e)=>Ve(x(0),o,Vi(o).sub(e).max(0));g("saturation",Al);g("vibrance",by);g("hue",_y);g("threshold",Vl);b("ColorAdjustmentNode",Ge);const Cy=_(o=>{const{eye_pos:e,surf_norm:t,mapN:s,uv:n}=o,i=e.dFdx(),r=e.dFdy(),a=n.dFdx(),c=n.dFdy(),l=t,d=r.cross(l),u=l.cross(i),m=d.mul(a.x).add(u.mul(c.x)),w=d.mul(a.y).add(u.mul(c.y)),T=m.dot(m).max(w.dot(w)),N=Tn.mul(T.inverseSqrt());return He(m.mul(s.x,N),w.mul(s.y,N),l.mul(s.z)).normalize()});class Ll extends se{constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=Yi}setup(e){const{normalMapType:t,scaleNode:s}=this;let n=this.node.mul(2).sub(1);s!==null&&(n=x(n.xy.mul(s),n.z));let i=null;return t===Bu?i=Ec.mul(n).normalize():t===Yi&&(e.hasGeometryAttribute("tangent")===!0?i=Tl.mul(n).normalize():i=Cy({eye_pos:Ue,surf_norm:_t,mapN:n,uv:fe()})),i}}const Pl=y(Ll);g("normalMap",Pl);b("NormalMapNode",Ll);class Rl extends se{constructor(e,t){super(),this.sourceNode=e,this.stepsNode=t}setup(){const{sourceNode:e,stepsNode:t}=this;return e.mul(t).floor().div(t)}}const My=y(Rl);g("posterize",My);b("PosterizeNode",Rl);const Oy=_(({color:o,exposure:e})=>o.mul(e).clamp()),Ey=_(({color:o,exposure:e})=>(o=o.mul(e),o.div(o.add(1)).clamp())),Ay=_(({color:o,exposure:e})=>{o=o.mul(e),o=o.sub(.004).max(0);const t=o.mul(o.mul(6.2).add(.5)),s=o.mul(o.mul(6.2).add(1.7)).add(.06);return t.div(s).pow(2.2)}),Vy=_(({color:o})=>{const e=o.mul(o.add(.0245786)).sub(90537e-9),t=o.mul(o.add(.432951).mul(.983729)).add(.238081);return e.div(t)}),Ly=_(({color:o,exposure:e})=>{const t=ht(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),s=ht(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return o=o.mul(e).div(.6),o=t.mul(o),o=Vy({color:o}),o=s.mul(o),o.clamp()}),Py=ht(x(1.6605,-.1246,-.0182),x(-.5876,1.1329,-.1006),x(-.0728,-.0083,1.1187)),Ry=ht(x(.6274,.0691,.0164),x(.3293,.9195,.088),x(.0433,.0113,.8956)),Iy=_(([o])=>{const e=x(o).toVar(),t=x(e.mul(e)).toVar(),s=x(t.mul(t)).toVar();return h(15.5).mul(s.mul(t)).sub(G(40.14,s.mul(e))).add(G(31.96,s).sub(G(6.868,t.mul(e))).add(G(.4298,t).add(G(.1191,e).sub(.00232))))}),Dy=_(({color:o,exposure:e})=>{const t=x(o).toVar(),s=ht(x(.856627153315983,.137318972929847,.11189821299995),x(.0951212405381588,.761241990602591,.0767994186031903),x(.0482516061458583,.101439036467562,.811302368396859)),n=ht(x(1.1271005818144368,-.1413297634984383,-.14132976349843826),x(-.11060664309660323,1.157823702216272,-.11060664309660294),x(-.016493938717834573,-.016493938717834257,1.2519364065950405)),i=h(-12.47393),r=h(4.026069);return t.mulAssign(e),t.assign(Ry.mul(t)),t.assign(s.mul(t)),t.assign(et(t,1e-10)),t.assign(hc(t)),t.assign(t.sub(i).div(r.sub(i))),t.assign(Ds(t,0,1)),t.assign(Iy(t)),t.assign(n.mul(t)),t.assign(st(et(x(0),t),x(2.2))),t.assign(Py.mul(t)),t.assign(Ds(t,0,1)),t}),Fy={[qu]:Oy,[Yu]:Ey,[Ku]:Ay,[Zu]:Ly,[Qu]:Dy};class zy extends se{constructor(e=So,t=h(1),s=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=s}getCacheKey(){let e=super.getCacheKey();return e="{toneMapping:"+this.toneMapping+",nodes:"+e+"}",e}setup(e){const t=this.colorNode||e.context.color,s=this.toneMapping;if(s===So)return t;const n={exposure:this.exposureNode,color:t},i=Fy[s];let r=null;return i?r=i(n):(console.error("ToneMappingNode: Unsupported Tone Mapping configuration.",s),r=t),r}}b("ToneMappingNode",zy);let xo=null;class Il extends sn{constructor(e=zs,t=null){xo===null&&(xo=new un),super(e,t,xo)}}const jy=y(Il);g("viewportSharedTexture",jy);b("ViewportSharedTextureNode",Il);class Go extends Ns{constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}}class nn extends se{constructor(e,t,s){super("vec4"),this.scope=e,this.scene=t,this.camera=s,this._pixelRatio=1,this._width=1,this._height=1;const n=new Qo;n.isRenderTargetTexture=!0,n.name="PostProcessingDepth";const i=new Rt(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Xu});i.texture.name="PostProcessing",i.depthTexture=n,this.renderTarget=i,this.updateBeforeType=H.FRAME,this._textureNode=A(new Go(this,i.texture)),this._depthTextureNode=A(new Go(this,n)),this._depthNode=null,this._cameraNear=de(0),this._cameraFar=de(0),this.isPassNode=!0}isGlobal(){return!0}getTextureNode(){return this._textureNode}getTextureDepthNode(){return this._depthTextureNode}getDepthNode(){if(this._depthNode===null){const e=this._cameraNear,t=this._cameraFar;this._depthNode=zo(Jc(this._depthTextureNode,e,t),e,t)}return this._depthNode}setup(){return this.scope===nn.COLOR?this.getTextureNode():this.getDepthNode()}updateBefore(e){const{renderer:t}=e,{scene:s,camera:n}=this;this._pixelRatio=t.getPixelRatio();const i=t.getSize(new oe);this.setSize(i.width,i.height);const r=t.toneMapping,a=t.toneMappingNode,c=t.getRenderTarget();this._cameraNear.value=n.near,this._cameraFar.value=n.far,t.toneMapping=So,t.toneMappingNode=null,t.setRenderTarget(this.renderTarget),t.render(s,n),t.toneMapping=r,t.toneMappingNode=a,t.setRenderTarget(c)}setSize(e,t){this._width=e,this._height=t;const s=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget.setSize(s,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}nn.COLOR="color";nn.DEPTH="depth";const Li=(o,e)=>A(new Go(o,e));b("PassNode",nn);const $y=new Ju(-1,1,1,-1,0,1);class Uy extends Hr{constructor(e=!1){super();const t=e===!1?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new Ki([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Ki(t,2))}}const Wy=new Uy;class Gy{constructor(e=null){this._mesh=new is(Wy,e)}dispose(){this._mesh.geometry.dispose()}async renderAsync(e){await e.renderAsync(this._mesh,$y)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}get render(){return this.renderAsync}}const Xn=Gy,Tr=new Xn,br=new Xn;class Hy extends se{constructor(e,t=2){super("vec4"),this.textureNode=e,this.sigma=t,this.directionNode=j(1),this._invSize=de(new oe),this._passDirection=de(new oe),this._horizontalRT=new Rt,this._horizontalRT.texture.name="GaussianBlurNode.horizontal",this._verticalRT=new Rt,this._verticalRT.texture.name="GaussianBlurNode.vertical",this._textureNode=Li(this,this._verticalRT.texture),this.updateBeforeType=H.RENDER,this.resolution=new oe(1,1)}setSize(e,t){e=Math.max(Math.round(e*this.resolution.x),1),t=Math.max(Math.round(t*this.resolution.y),1),this._invSize.value.set(1/e,1/t),this._horizontalRT.setSize(e,t),this._verticalRT.setSize(e,t)}updateBefore(e){const{renderer:t}=e,s=this.textureNode,n=s.value,i=t.getRenderTarget(),r=s.value;Tr.material=this._material,br.material=this._material,this.setSize(n.image.width,n.image.height);const a=n.type;this._horizontalRT.texture.type=a,this._verticalRT.texture.type=a,t.setRenderTarget(this._horizontalRT),this._passDirection.value.set(1,0),Tr.render(t),s.value=this._horizontalRT.texture,t.setRenderTarget(this._verticalRT),this._passDirection.value.set(0,1),br.render(t),t.setRenderTarget(i),s.value=r}getTextureNode(){return this._textureNode}setup(e){const t=this.textureNode;if(t.isTextureNode!==!0)return console.error("GaussianBlurNode requires a TextureNode."),I();const s=t.uvNode||fe(),n=c=>t.cache().context({getUV:()=>c,forceUVContext:!0}),i=_(()=>{const c=3+2*this.sigma,l=this._getCoefficients(c),d=this._invSize,u=j(this.directionNode).mul(this._passDirection),m=h(l[0]).toVar(),w=I(n(s).mul(m)).toVar();for(let T=1;T<c;T++){const N=h(T),v=h(l[T]),O=j(u.mul(d.mul(N))).toVar(),P=I(n(s.add(O))),L=I(n(s.sub(O)));w.addAssign(P.add(L).mul(v)),m.addAssign(G(2,v))}return w.div(m)}),r=this._material||(this._material=e.createNodeMaterial());r.fragmentNode=i();const a=e.getNodeProperties(this);return a.textureNode=t,this._textureNode}_getCoefficients(e){const t=[];for(let s=0;s<e;s++)t.push(.39894*Math.exp(-.5*s*s/(e*e))/e);return t}}const ky=(o,e)=>A(new Hy(A(o),e));g("gaussianBlur",ky);const _r=new Xn;class By extends se{constructor(e,t=.96){super(e),this.textureNode=e,this.textureNodeOld=Re(),this.damp=de(t),this._compRT=new Rt,this._compRT.texture.name="AfterImageNode.comp",this._oldRT=new Rt,this._oldRT.texture.name="AfterImageNode.old",this._textureNode=Li(this,this._compRT.texture),this.updateBeforeType=H.RENDER}getTextureNode(){return this._textureNode}setSize(e,t){this._compRT.setSize(e,t),this._oldRT.setSize(e,t)}updateBefore(e){const{renderer:t}=e,s=this.textureNode,n=s.value,i=n.type;this._compRT.texture.type=i,this._oldRT.texture.type=i;const r=t.getRenderTarget(),a=s.value;this.textureNodeOld.value=this._oldRT.texture,t.setRenderTarget(this._compRT),_r.render(t);const c=this._oldRT;this._oldRT=this._compRT,this._compRT=c,this.setSize(n.image.width,n.image.height),t.setRenderTarget(r),s.value=a}setup(e){const t=this.textureNode,s=this.textureNodeOld;if(t.isTextureNode!==!0)return console.error("AfterImageNode requires a TextureNode."),I();const n=t.uvNode||fe();s.uvNode=n;const i=d=>t.cache().context({getUV:()=>d,forceUVContext:!0}),r=_(([d,u])=>{const m=h(u).toVar(),w=I(d).toVar();return et(Gn(w.sub(m)),0)}),a=_(()=>{const d=I(s),u=I(i(n));return d.mulAssign(this.damp.mul(r(d,.1))),et(u,d)}),c=this._materialComposed||(this._materialComposed=e.createNodeMaterial());c.fragmentNode=a(),_r.material=c;const l=e.getNodeProperties(this);return l.textureNode=t,this._textureNode}}const qy=(o,e)=>A(new By(A(o),e));g("afterImage",qy);const Sr=new Xn;class Yy extends se{constructor(e,t,s,n){super("vec4"),this.textureNode=e,this.tresholdNode=t,this.scaleNode=s,this.colorNode=x(.1,0,1),this.samples=n,this.resolution=new oe(1,1),this._renderTarget=new Rt,this._renderTarget.texture.name="anamorphic",this._invSize=de(new oe),this._textureNode=Li(this,this._renderTarget.texture),this.updateBeforeType=H.RENDER}getTextureNode(){return this._textureNode}setSize(e,t){this._invSize.value.set(1/e,1/t),e=Math.max(Math.round(e*this.resolution.x),1),t=Math.max(Math.round(t*this.resolution.y),1),this._renderTarget.setSize(e,t)}updateBefore(e){const{renderer:t}=e,s=this.textureNode,n=s.value;this._renderTarget.texture.type=n.type;const i=t.getRenderTarget(),r=s.value;Sr.material=this._material,this.setSize(n.image.width,n.image.height),t.setRenderTarget(this._renderTarget),Sr.render(t),t.setRenderTarget(i),s.value=r}setup(e){const t=this.textureNode;if(t.isTextureNode!==!0)return console.error("AnamorphNode requires a TextureNode."),I();const s=t.uvNode||fe(),n=c=>t.cache().context({getUV:()=>c,forceUVContext:!0}),i=_(()=>{const c=this.samples,l=Math.floor(c/2),d=x(0).toVar();return ie({start:-l,end:l},({i:u})=>{const m=h(u).abs().div(l).oneMinus(),w=j(s.x.add(this._invSize.x.mul(u).mul(this.scaleNode)),s.y),T=n(w),N=Vl(T,this.tresholdNode).mul(m);d.addAssign(N)}),d.mul(this.colorNode)}),r=this._material||(this._material=e.createNodeMaterial());r.fragmentNode=i();const a=e.getNodeProperties(this);return a.textureNode=t,this._textureNode}}const Ky=(o,e=.9,t=3,s=32)=>A(new Yy(A(o),A(e),A(t),s));g("anamorphic",Ky);class Dl extends se{constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){const t=[],s=this.functionNode,n=s.getInputs(e),i=this.parameters;if(Array.isArray(i))for(let a=0;a<i.length;a++){const c=n[a],l=i[a];t.push(l.build(e,c.type))}else for(const a of n){const c=i[a.name];if(c!==void 0)t.push(c.build(e,a.type));else throw new Error(`FunctionCallNode: Input '${a.name}' not found in FunctionNode.`)}return`${s.build(e,"property")}( ${t.join(", ")} )`}}const Zy=(o,...e)=>(e=e.length>1||e[0]&&e[0].isNode===!0?rs(e):Un(e[0]),A(new Dl(A(o),e)));g("call",Zy);b("FunctionCallNode",Dl);class Fl extends D{constructor(e=null){super(),this._value=e,this._cache=null,this.inputType=null,this.outpuType=null,this.events=new Qr,this.isScriptableValueNode=!0}get isScriptableOutputNode(){return this.outputType!==null}set value(e){this._value!==e&&(this._cache&&this.inputType==="URL"&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=e,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){const e=this.value;if(e&&this._cache===null&&this.inputType==="URL"&&e.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([e.value]));else if(e&&e.value!==null&&e.value!==void 0&&((this.inputType==="URL"||this.inputType==="String")&&typeof e.value=="string"||this.inputType==="Number"&&typeof e.value=="number"||this.inputType==="Vector2"&&e.value.isVector2||this.inputType==="Vector3"&&e.value.isVector3||this.inputType==="Vector4"&&e.value.isVector4||this.inputType==="Color"&&e.value.isColor||this.inputType==="Matrix3"&&e.value.isMatrix3||this.inputType==="Matrix4"&&e.value.isMatrix4))return e.value;return this._cache||e}getNodeType(e){return this.value&&this.value.isNode?this.value.getNodeType(e):"float"}setup(){return this.value&&this.value.isNode?this.value:h()}serialize(e){super.serialize(e),this.value!==null?this.inputType==="ArrayBuffer"?e.value=Fa(this.value):e.value=this.value?this.value.toJSON(e.meta).uuid:null:e.value=null,e.inputType=this.inputType,e.outputType=this.outputType}deserialize(e){super.deserialize(e);let t=null;e.value!==null&&(e.inputType==="ArrayBuffer"?t=za(e.value):e.inputType==="Texture"?t=e.meta.textures[e.value]:t=e.meta.nodes[e.value]||null),this.value=t,this.inputType=e.inputType,this.outputType=e.outputType}}const cn=y(Fl);g("scriptableValue",cn);b("ScriptableValueNode",Fl);class zl extends Map{get(e,t=null,...s){if(this.has(e))return super.get(e);if(t!==null){const n=t(...s);return this.set(e,n),n}}}class Qy{constructor(e){this.scriptableNode=e}get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(e){return this.scriptableNode.getInputLayout(e)}get(e){const t=this.parameters[e];return t?t.getValue():null}}const yo=new zl;class jl extends D{constructor(e=null,t={}){super(),this.codeNode=e,this.parameters=t,this._local=new zl,this._output=cn(),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}get source(){return this.codeNode?this.codeNode.code:""}setLocal(e,t){return this._local.set(e,t)}getLocal(e){return this._local.get(e)}onRefresh(){this._refresh()}getInputLayout(e){for(const t of this.getLayout())if(t.inputType&&(t.id===e||t.name===e))return t}getOutputLayout(e){for(const t of this.getLayout())if(t.outputType&&(t.id===e||t.name===e))return t}setOutput(e,t){const s=this._outputs;return s[e]===void 0?s[e]=cn(t):s[e].value=t,this}getOutput(e){return this._outputs[e]}getParameter(e){return this.parameters[e]}setParameter(e,t){const s=this.parameters;return t&&t.isScriptableNode?(this.deleteParameter(e),s[e]=t,s[e].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):t&&t.isScriptableValueNode?(this.deleteParameter(e),s[e]=t,s[e].events.addEventListener("refresh",this.onRefresh)):s[e]===void 0?(s[e]=cn(t),s[e].events.addEventListener("refresh",this.onRefresh)):s[e].value=t,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(e){let t=this.parameters[e];return t&&(t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(const e of Object.keys(this.parameters))this.deleteParameter(e);return this.needsUpdate=!0,this}call(e,...t){const n=this.getObject()[e];if(typeof n=="function")return n(...t)}async callAsync(e,...t){const n=this.getObject()[e];if(typeof n=="function")return n.constructor.name==="AsyncFunction"?await n(...t):n(...t)}getNodeType(e){return this.getDefaultOutputNode().getNodeType(e)}refresh(e=null){e!==null?this.getOutput(e).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),this._object!==null)return this._object;const e=()=>this.refresh(),t=(l,d)=>this.setOutput(l,d),s=new Qy(this),n=yo.get("THREE"),i=yo.get("TSL"),r=this.getMethod(this.codeNode),a=[s,this._local,yo,e,t,n,i];this._object=r(...a);const c=this._object.layout;if(c&&(c.cache===!1&&this._local.clear(),this._output.outputType=c.outputType||null,Array.isArray(c.elements)))for(const l of c.elements){const d=l.id||l.name;l.inputType&&(this.getParameter(d)===void 0&&this.setParameter(d,null),this.getParameter(d).inputType=l.inputType),l.outputType&&(this.getOutput(d)===void 0&&this.setOutput(d,null),this.getOutput(d).outputType=l.outputType)}return this._object}deserialize(e){super.deserialize(e);for(const t in this.parameters){let s=this.parameters[t];s.isScriptableNode&&(s=s.getDefaultOutput()),s.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){const e=this.getDefaultOutput().value;return e&&e.isNode?e:h()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),this._method!==null)return this._method;const e=["parameters","local","global","refresh","setOutput","THREE","TSL"],s=["layout","init","main","dispose"].join(", "),n="var "+s+`; var output = {};
`,i=`
return { ...output, `+s+" };",r=n+this.codeNode.code+i;return this._method=new Function(...e,r),this._method}dispose(){this._method!==null&&(this._object&&typeof this._object.dispose=="function"&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}set needsUpdate(e){e===!0&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return this.codeNode===null?this:(this._needsOutputUpdate===!0&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value,this)}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}}const Xy=y(jl);g("scriptable",Xy);b("ScriptableNode",jl);class Jn extends D{constructor(e,t){super("float"),this.isFogNode=!0,this.colorNode=e,this.factorNode=t}mixAssign(e){return Ve(e,this.colorNode,this)}setup(){return this.factorNode}}const Jy=y(Jn);g("fog",Jy);b("FogNode",Jn);class $l extends Jn{constructor(e,t,s){super(e),this.isFogRangeNode=!0,this.nearNode=t,this.farNode=s}setup(){return rt(this.nearNode,this.farNode,Ue.z.negate())}}const eN=y($l);g("rangeFog",eN);b("FogRangeNode",$l);class Ul extends Jn{constructor(e,t){super(e),this.isFogExp2Node=!0,this.densityNode=t}setup(){const e=Ue.z.negate(),t=this.densityNode;return t.mul(t,e,e).negate().exp().oneMinus()}}const tN=y(Ul);g("densityFog",tN);b("FogExp2Node",Ul);let Wt=null,Gt=null;class Wl extends D{constructor(e=h(),t=h()){super(),this.minNode=e,this.maxNode=t}getVectorLength(e){const t=e.getTypeLength(Vt(this.minNode.value)),s=e.getTypeLength(Vt(this.maxNode.value));return t>s?t:s}getNodeType(e){return e.object.isInstancedMesh===!0?e.getTypeFromLength(this.getVectorLength(e)):"float"}setup(e){const t=e.object;let s=null;if(t.isInstancedMesh===!0){const n=this.minNode.value,i=this.maxNode.value,r=e.getTypeLength(Vt(n)),a=e.getTypeLength(Vt(i));Wt=Wt||new it,Gt=Gt||new it,Wt.setScalar(0),Gt.setScalar(0),r===1?Wt.setScalar(n):n.isColor?Wt.set(n.r,n.g,n.b):Wt.set(n.x,n.y,n.z||0,n.w||0),a===1?Gt.setScalar(i):i.isColor?Gt.set(i.r,i.g,i.b):Gt.set(i.x,i.y,i.z||0,i.w||0);const c=4,l=c*t.count,d=new Float32Array(l);for(let m=0;m<l;m++){const w=m%c,T=Wt.getComponent(w),N=Gt.getComponent(w);d[m]=Xr.lerp(T,N,Math.random())}const u=this.getNodeType(e);s=Ci(d,"vec4",t.count).element(Sf).convert(u)}else s=h(0);return s}}y(Wl);b("RangeNode",Wl);class Gl extends D{constructor(e,t,s=[64]){super("void"),this.isComputeNode=!0,this.computeNode=e,this.count=t,this.workgroupSize=s,this.dispatchCount=0,this.version=1,this.updateBeforeType=H.OBJECT,this.updateDispatchCount()}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){e===!0&&this.version++}updateDispatchCount(){const{count:e,workgroupSize:t}=this;let s=t[0];for(let n=1;n<t.length;n++)s*=t[n];this.dispatchCount=Math.ceil(e/s)}onInit(){}updateBefore({renderer:e}){e.compute(this)}generate(e){const{shaderStage:t}=e;if(t==="compute"){const s=this.computeNode.build(e,"void");s!==""&&e.addLineFlowCode(s)}}}const sN=(o,e,t)=>A(new Gl(A(o),e,t));g("compute",sN);b("ComputeNode",Gl);class Yt extends D{constructor(e=Yt.TARGET_DIRECTION,t=null){super(),this.scope=e,this.light=t}setup(){const{scope:e,light:t}=this;let s=null;return e===Yt.TARGET_DIRECTION&&(s=$t.transformDirection(Do(t).sub(Do(t.target)))),s}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}Yt.TARGET_DIRECTION="targetDirection";const Hl=y(Yt,Yt.TARGET_DIRECTION);b("LightNode",Yt);const kl=_(o=>{const{lightDistance:e,cutoffDistance:t,decayExponent:s}=o,n=e.pow(s).max(.01).reciprocal();return t.greaterThan(0).cond(n.mul(e.div(t).pow4().oneMinus().clamp().pow2()),n)});class Bl extends Xt{constructor(e=null){super(e),this.cutoffDistanceNode=de(0),this.decayExponentNode=de(0)}update(e){const{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setup(e){const{colorNode:t,cutoffDistanceNode:s,decayExponentNode:n,light:i}=this,r=e.context.lightingModel,a=Oc(i).sub(Ue),c=a.normalize(),l=a.length(),d=kl({lightDistance:l,cutoffDistance:s,decayExponent:n}),u=t.mul(d),m=e.context.reflectedLight;r.direct({lightDirection:c,lightColor:u,reflectedLight:m},e.stack,e)}}b("PointLightNode",Bl);vs(eh,Bl);class ql extends Xt{constructor(e=null){super(e)}setup(e){super.setup(e);const t=e.context.lightingModel,s=this.colorNode,n=Hl(this.light),i=e.context.reflectedLight;t.direct({lightDirection:n,lightColor:s,reflectedLight:i},e.stack,e)}}b("DirectionalLightNode",ql);vs(th,ql);class Pi extends Xt{constructor(e=null){super(e),this.coneCosNode=de(0),this.penumbraCosNode=de(0),this.cutoffDistanceNode=de(0),this.decayExponentNode=de(0)}update(e){super.update(e);const{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e){const{coneCosNode:t,penumbraCosNode:s}=this;return rt(t,s,e)}setup(e){super.setup(e);const t=e.context.lightingModel,{colorNode:s,cutoffDistanceNode:n,decayExponentNode:i,light:r}=this,a=Oc(r).sub(Ue),c=a.normalize(),l=c.dot(Hl(r)),d=this.getSpotAttenuation(l),u=a.length(),m=kl({lightDistance:u,cutoffDistance:n,decayExponent:i}),w=s.mul(d).mul(m),T=e.context.reflectedLight;t.direct({lightDirection:c,lightColor:w,reflectedLight:T},e.stack,e)}}b("SpotLightNode",Pi);vs(na,Pi);class nN extends na{constructor(e,t,s,n,i,r){super(e,t,s,n,i,r),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}}const oN=nN;class Yl extends Pi{getSpotAttenuation(e){const t=this.light.iesMap;let s=null;if(t&&t.isTexture===!0){const n=e.acos().mul(1/Math.PI);s=Re(t,j(n,0),0).r}else s=super.getSpotAttenuation(e);return s}}b("IESSpotLightNode",Yl);vs(oN,Yl);class Kl extends Xt{constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}}b("AmbientLightNode",Kl);vs(sh,Kl);class Zl extends Xt{constructor(e=null){super(e),this.lightPositionNode=Do(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=de(new Je)}update(e){const{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){const{colorNode:t,groundColorNode:s,lightDirectionNode:n}=this,r=_t.dot(n).mul(.5).add(.5),a=Ve(s,t,r);e.context.irradiance.addAssign(a)}}b("HemisphereLightNode",Zl);vs(nh,Zl);const iN=_(o=>{const e=o.uv.mul(2),t=e.x.floor(),s=e.y.floor();return t.add(s).mod(2).sign()});class Ql extends se{constructor(e=fe()){super("float"),this.uvNode=e}setup(){return iN({uv:this.uvNode})}}const rN=y(Ql);g("checker",rN);b("CheckerNode",Ql);const aN=new oa;class cN extends Ze{constructor(e={}){super(),this.normals=!1,this.lights=!1,this.useAlphaToCoverage=!0,this.useColor=e.vertexColors,this.pointWidth=1,this.pointColorNode=null,this.setDefaultValues(aN),this.setupShaders(),this.setValues(e)}setupShaders(){const e=this.alphaToCoverage,t=this.useColor;this.vertexNode=_(()=>{ue(j(),"vUv").assign(fe());const s=Pe("instancePosition"),n=Me("vec4","mvPos");n.assign(qt.mul(I(s,1)));const i=cs.z.div(cs.w),r=Tt.mul(n),a=Me("vec2","offset");return a.assign(Fe.xy),a.assign(a.mul(sx)),a.assign(a.div(cs.z)),a.y.assign(a.y.mul(i)),a.assign(a.mul(r.w)),r.assign(r.add(I(a,0,0))),r})(),this.fragmentNode=_(()=>{const s=ue(j(),"vUv"),n=Me("float","alpha");n.assign(1);const i=s.x,r=s.y,a=i.mul(i).add(r.mul(r));if(e){const l=Me("float","dlen");l.assign(a.fwidth()),n.assign(rt(l.oneMinus(),l.add(1),a).oneMinus())}else a.greaterThan(1).discard();let c;return this.pointColorNode?c=this.pointColorNode:t?c=Pe("instanceColor").mul(Fs):c=Fs,I(c,n)})(),this.needsUpdate=!0}get alphaToCoverage(){return this.useAlphaToCoverage}set alphaToCoverage(e){this.useAlphaToCoverage!==e&&(this.useAlphaToCoverage=e,this.setupShaders())}}Be("InstancedPointsNodeMaterial",cN);const lN=new oh;class dN extends Ze{constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.lights=!1,this.normals=!1,this.setDefaultValues(lN),this.setValues(e)}}Be("LineBasicNodeMaterial",dN);const uN=new ia;class hN extends Ze{constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.lights=!1,this.normals=!1,this.setDefaultValues(uN),this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){const e=this.offsetNode,t=this.dashScaleNode?h(this.dashScaleNode):Fo,s=this.dashSizeNode?h(this.dashSizeNode):Vc,n=this.dashSizeNode?h(this.dashGapNode):Lc;as.assign(s),xn.assign(n);const i=ue(Pe("lineDistance").mul(t));(e?i.add(e):i).mod(as.add(xn)).greaterThan(as).discard()}}Be("LineDashedNodeMaterial",hN);const pN=new ia;class mN extends Ze{constructor(e={}){super(),this.normals=!1,this.lights=!1,this.setDefaultValues(pN),this.useAlphaToCoverage=!0,this.useColor=e.vertexColors,this.useDash=e.dashed,this.useWorldUnits=!1,this.dashOffset=0,this.lineWidth=1,this.lineColorNode=null,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setupShaders(),this.setValues(e)}setupShaders(){const e=this.alphaToCoverage,t=this.useColor,s=this.dashed,n=this.worldUnits,i=_(({start:a,end:c})=>{const l=Tt.element(2).element(2),m=Tt.element(3).element(2).mul(-.5).div(l).sub(a.z).div(c.z.sub(a.z));return I(Ve(a.xyz,c.xyz,m),c.w)});this.vertexNode=_(()=>{Ot("vec2","vUv").assign(fe());const a=Pe("instanceStart"),c=Pe("instanceEnd"),l=Me("vec4","start"),d=Me("vec4","end");l.assign(qt.mul(I(a,1))),d.assign(qt.mul(I(c,1))),n&&(Ot("vec3","worldStart").assign(l.xyz),Ot("vec3","worldEnd").assign(d.xyz));const u=cs.z.div(cs.w),m=Tt.element(2).element(3).equal(-1);ee(m,()=>{ee(l.z.lessThan(0).and(d.z.greaterThan(0)),()=>{d.assign(i({start:l,end:d}))}).elseif(d.z.lessThan(0).and(l.z.greaterThanEqual(0)),()=>{l.assign(i({start:d,end:l}))})});const w=Tt.mul(l),T=Tt.mul(d),N=w.xyz.div(w.w),v=T.xyz.div(T.w),O=v.xy.sub(N.xy).temp();O.x.assign(O.x.mul(u)),O.assign(O.normalize());const P=Is(I());if(n){const L=d.xyz.sub(l.xyz).normalize(),F=Ve(l.xyz,d.xyz,.5).normalize(),Q=L.cross(F).normalize(),W=L.cross(Q),k=Ot("vec4","worldPos");k.assign(Fe.y.lessThan(.5).cond(l,d));const K=uo.mul(.5);k.addAssign(I(Fe.x.lessThan(0).cond(Q.mul(K),Q.mul(K).negate()),0)),s||(k.addAssign(I(Fe.y.lessThan(.5).cond(L.mul(K).negate(),L.mul(K)),0)),k.addAssign(I(W.mul(K),0)),ee(Fe.y.greaterThan(1).or(Fe.y.lessThan(0)),()=>{k.subAssign(I(W.mul(2).mul(K),0))})),P.assign(Tt.mul(k));const Nt=Is(x());Nt.assign(Fe.y.lessThan(.5).cond(N,v)),P.z.assign(Nt.z.mul(P.w))}else{const L=Me("vec2","offset");L.assign(j(O.y,O.x.negate())),O.x.assign(O.x.div(u)),L.x.assign(L.x.div(u)),L.assign(Fe.x.lessThan(0).cond(L.negate(),L)),ee(Fe.y.lessThan(0),()=>{L.assign(L.sub(O))}).elseif(Fe.y.greaterThan(1),()=>{L.assign(L.add(O))}),L.assign(L.mul(uo)),L.assign(L.div(cs.w)),P.assign(Fe.y.lessThan(.5).cond(w,T)),L.assign(L.mul(P.w)),P.assign(P.add(I(L,0,0)))}return P})();const r=_(({p1:a,p2:c,p3:l,p4:d})=>{const u=a.sub(l),m=d.sub(l),w=c.sub(a),T=u.dot(m),N=m.dot(w),v=u.dot(w),O=m.dot(m),L=w.dot(w).mul(O).sub(N.mul(N)),Q=T.mul(N).sub(v.mul(O)).div(L).clamp(),W=T.add(N.mul(Q)).div(O).clamp();return j(Q,W)});this.fragmentNode=_(()=>{const a=Ot("vec2","vUv");if(s){const d=this.offsetNode?h(this.offsetNodeNode):lr,u=this.dashScaleNode?h(this.dashScaleNode):Fo,m=this.dashSizeNode?h(this.dashSizeNode):Vc,w=this.dashSizeNode?h(this.dashGapNode):Lc;as.assign(m),xn.assign(w);const T=Pe("instanceDistanceStart"),N=Pe("instanceDistanceEnd"),v=Fe.y.lessThan(.5).cond(u.mul(T),Fo.mul(N)),O=ue(v.add(lr)),P=d?O.add(d):O;a.y.lessThan(-1).or(a.y.greaterThan(1)).discard(),P.mod(as.add(xn)).greaterThan(as).discard()}const c=Me("float","alpha");if(c.assign(1),n){const d=Ot("vec3","worldStart"),u=Ot("vec3","worldEnd"),m=Ot("vec4","worldPos").xyz.normalize().mul(1e5),w=u.sub(d),T=r({p1:d,p2:u,p3:x(0,0,0),p4:m}),N=d.add(w.mul(T.x)),v=m.mul(T.y),L=N.sub(v).length().div(uo);if(!s)if(e){const F=L.fwidth();c.assign(rt(F.negate().add(.5),F.add(.5),L).oneMinus())}else L.greaterThan(.5).discard()}else if(e){const d=a.x,u=a.y.greaterThan(0).cond(a.y.sub(1),a.y.add(1)),m=d.mul(d).add(u.mul(u)),w=Me("float","dlen");w.assign(m.fwidth()),ee(a.y.abs().greaterThan(1),()=>{c.assign(rt(w.oneMinus(),w.add(1),m).oneMinus())})}else ee(a.y.abs().greaterThan(1),()=>{const d=a.x,u=a.y.greaterThan(0).cond(a.y.sub(1),a.y.add(1));d.mul(d).add(u.mul(u)).greaterThan(1).discard()});let l;if(this.lineColorNode)l=this.lineColorNode;else if(t){const d=Pe("instanceColorStart"),u=Pe("instanceColorEnd");l=Fe.y.lessThan(.5).cond(d,u).mul(Fs)}else l=Fs;return I(l,c)})(),this.needsUpdate=!0}get worldUnits(){return this.useWorldUnits}set worldUnits(e){this.useWorldUnits!==e&&(this.useWorldUnits=e,this.setupShaders())}get dashed(){return this.useDash}set dashed(e){this.useDash!==e&&(this.useDash=e,this.setupShaders())}get alphaToCoverage(){return this.useAlphaToCoverage}set alphaToCoverage(e){this.useAlphaToCoverage!==e&&(this.useAlphaToCoverage=e,this.setupShaders())}}Be("Line2NodeMaterial",mN);const fN=new ih;class gN extends Ze{constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.colorSpaced=!1,this.setDefaultValues(fN),this.setValues(e)}setupDiffuseColor(){const e=this.opacityNode?h(this.opacityNode):Ac;Se.assign(I(ml(me),e))}}Be("MeshNormalNodeMaterial",gN);const xN=new Br;class Xl extends Ze{constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!1,this.setDefaultValues(xN),this.setValues(e)}}Be("MeshBasicNodeMaterial",Xl);const js=_(({f0:o,f90:e,dotVH:t})=>{const s=t.mul(-5.55473).sub(6.98316).mul(t).exp2();return o.mul(s.oneMinus()).add(e.mul(s))}),bn=_(o=>o.diffuseColor.mul(1/Math.PI)),yN=()=>h(.25),NN=_(({dotNH:o})=>Po.mul(.5/Math.PI).add(1).mul(o.pow(Po))),vN=_(({lightDirection:o})=>{const e=o.add(ge).normalize(),t=me.dot(e).clamp(),s=ge.dot(e).clamp(),n=js({f0:vt,f90:1,dotVH:s}),i=yN(),r=NN({dotNH:t});return n.mul(i).mul(r)});class Jl extends Ja{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:s}){const i=me.dot(e).clamp().mul(t);s.directDiffuse.addAssign(i.mul(bn({diffuseColor:Se.rgb}))),this.specular===!0&&s.directSpecular.addAssign(i.mul(vN({lightDirection:e})).mul(Gg))}indirectDiffuse({irradiance:e,reflectedLight:t}){t.indirectDiffuse.addAssign(e.mul(bn({diffuseColor:Se})))}}const wN=new rh;class TN extends Ze{constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(wN),this.setValues(e)}setupLightingModel(){return new Jl(!1)}}Be("MeshLambertNodeMaterial",TN);const bN=new ah;class _N extends Ze{constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(bN),this.setValues(e)}setupLightingModel(){return new Jl}setupVariants(){const e=(this.shininessNode?h(this.shininessNode):$g).max(1e-4);Po.assign(e);const t=this.specularNode||Wg;vt.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}}Be("MeshPhongNodeMaterial",_N);const SN=_(()=>{const o=Nn.dFdx().abs().max(Nn.dFdy().abs());return o.x.max(o.y).max(o.z)}),CN=_(o=>{const{roughness:e}=o,t=SN();let s=e.max(.0525);return s=s.add(t),s=s.min(1),s}),MN=_(o=>{const{alpha:e,dotNL:t,dotNV:s}=o,n=e.pow2(),i=t.mul(n.add(n.oneMinus().mul(s.pow2())).sqrt()),r=s.mul(n.add(n.oneMinus().mul(t.pow2())).sqrt());return Bt(.5,i.add(r).max(dc))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),ON=_(({alpha:o,dotNH:e})=>{const t=o.pow2(),s=e.pow2().mul(t.oneMinus()).oneMinus();return t.div(s.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),Cr=_(o=>{const{lightDirection:e,f0:t,f90:s,roughness:n,iridescenceFresnel:i}=o,r=o.normalView||me,a=n.pow2(),c=e.add(ge).normalize(),l=r.dot(e).clamp(),d=r.dot(ge).clamp(),u=r.dot(c).clamp(),m=ge.dot(c).clamp();let w=js({f0:t,f90:s,dotVH:m});i&&(w=Ni.mix(w,i));const T=MN({alpha:a,dotNL:l,dotNV:d}),N=ON({alpha:a,dotNH:u});return w.mul(T).mul(N)}),ed=_(({roughness:o,dotNV:e})=>{const t=I(-1,-.0275,-.572,.022),s=I(1,.0425,1.04,-.04),n=o.mul(t).add(s),i=n.x.mul(n.x).min(e.mul(-9.28).exp2()).mul(n.x).add(n.y);return j(-1.04,1.04).mul(i).add(n.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),EN=_(o=>{const{dotNV:e,specularColor:t,specularF90:s,roughness:n}=o,i=ed({dotNV:e,roughness:n});return t.mul(i.x).add(s.mul(i.y))}),AN=_(({f:o,f90:e,dotVH:t})=>{const s=t.oneMinus().saturate(),n=s.mul(s),i=s.mul(n,n).clamp(0,.9999);return o.sub(x(e).mul(i)).div(i.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),VN=_(({roughness:o,dotNH:e})=>{const t=o.pow2(),s=h(1).div(t),i=e.pow2().oneMinus().max(.0078125);return h(2).add(s).mul(i.pow(s.mul(.5))).div(2*Math.PI)}).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),LN=_(({dotNV:o,dotNL:e})=>h(1).div(h(4).mul(e.add(o).sub(e.mul(o))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),PN=_(({lightDirection:o})=>{const e=o.add(ge).normalize(),t=me.dot(o).clamp(),s=me.dot(ge).clamp(),n=me.dot(e).clamp(),i=VN({roughness:yi,dotNH:n}),r=LN({dotNV:s,dotNL:t});return ss.mul(i).mul(r)}),RN=ht(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),IN=o=>{const e=o.sqrt();return x(1).add(e).div(x(1).sub(e))},Mr=(o,e)=>o.sub(e).div(o.add(e)).pow2(),DN=(o,e)=>{const t=o.mul(2*Math.PI*1e-9),s=x(54856e-17,44201e-17,52481e-17),n=x(1681e3,1795300,2208400),i=x(43278e5,93046e5,66121e5),r=h(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(t.mul(2239900).add(e.x).cos()).mul(t.pow2().mul(-45282e5).exp());let a=s.mul(i.mul(2*Math.PI).sqrt()).mul(n.mul(t).add(e).cos()).mul(t.pow2().negate().mul(i).exp());return a=x(a.x.add(r),a.y,a.z).div(10685e-11),RN.mul(a)},FN=_(({outsideIOR:o,eta2:e,cosTheta1:t,thinFilmThickness:s,baseF0:n})=>{const i=Ve(o,e,rt(0,.03,s)),r=o.div(i).pow2().mul(h(1).sub(t.pow2())),c=h(1).sub(r).sqrt(),l=Mr(i,o),d=js({f0:l,f90:1,dotVH:t}),u=d.oneMinus(),m=i.lessThan(o).cond(Math.PI,0),w=h(Math.PI).sub(m),T=IN(n.clamp(0,.9999)),N=Mr(T,i.vec3()),v=js({f0:N,f90:1,dotVH:c}),O=x(T.x.lessThan(i).cond(Math.PI,0),T.y.lessThan(i).cond(Math.PI,0),T.z.lessThan(i).cond(Math.PI,0)),P=i.mul(s,c,2),L=x(w).add(O),F=d.mul(v).clamp(1e-5,.9999),Q=F.sqrt(),W=u.pow2().mul(v).div(x(1).sub(F));let K=d.add(W),Nt=W.sub(u);for(let at=1;at<=2;++at){Nt=Nt.mul(Q);const Ut=DN(h(at).mul(P),h(at).mul(L)).mul(2);K=K.add(Nt.mul(Ut))}return K.max(x(0))}).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),zN=_(({normal:o,viewDir:e,roughness:t})=>{const s=o.dot(e).saturate(),n=t.pow2(),i=Lt(t.lessThan(.25),h(-339.2).mul(n).add(h(161.4).mul(t)).sub(25.9),h(-8.48).mul(n).add(h(14.3).mul(t)).sub(9.95)),r=Lt(t.lessThan(.25),h(44).mul(n).sub(h(23.7).mul(t)).add(3.26),h(1.97).mul(n).sub(h(3.27).mul(t)).add(.72));return Lt(t.lessThan(.25),0,h(.1).mul(t).sub(.025)).add(i.mul(s).add(r).exp()).mul(1/Math.PI).saturate()}),No=x(.04),vo=x(1);class Ri extends Ja{constructor(e=!1,t=!1,s=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=s,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(){if(this.clearcoat===!0&&(this.clearcoatRadiance=x().temp("clearcoatRadiance"),this.clearcoatSpecularDirect=x().temp("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=x().temp("clearcoatSpecularIndirect")),this.sheen===!0&&(this.sheenSpecularDirect=x().temp("sheenSpecularDirect"),this.sheenSpecularIndirect=x().temp("sheenSpecularIndirect")),this.iridescence===!0){const e=me.dot(ge).clamp();this.iridescenceFresnel=FN({outsideIOR:h(1),eta2:sc,cosTheta1:e,thinFilmThickness:nc,baseF0:vt}),this.iridescenceF0=AN({f:this.iridescenceFresnel,f90:1,dotVH:e})}}computeMultiscattering(e,t,s=h(1)){const n=me.dot(ge).clamp(),i=ed({roughness:Vs,dotNV:n}),a=(this.iridescenceF0?Ni.mix(vt,this.iridescenceF0):vt).mul(i.x).add(s.mul(i.y)),l=i.x.add(i.y).oneMinus(),d=vt.add(vt.oneMinus().mul(.047619)),u=a.mul(d).div(l.mul(d).oneMinus());e.addAssign(a),t.addAssign(u.mul(l))}direct({lightDirection:e,lightColor:t,reflectedLight:s}){const i=me.dot(e).clamp().mul(t);if(this.sheen===!0&&this.sheenSpecularDirect.addAssign(i.mul(PN({lightDirection:e}))),this.clearcoat===!0){const a=ns.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(a.mul(Cr({lightDirection:e,f0:No,f90:vo,roughness:gn,normalView:ns})))}s.directDiffuse.addAssign(i.mul(bn({diffuseColor:Se.rgb}))),s.directSpecular.addAssign(i.mul(Cr({lightDirection:e,f0:vt,f90:1,roughness:Vs,iridescence:this.iridescence,iridescenceFresnel:this.iridescenceFresnel})))}indirectDiffuse({irradiance:e,reflectedLight:t}){t.indirectDiffuse.addAssign(e.mul(bn({diffuseColor:Se})))}indirectSpecular({radiance:e,iblIrradiance:t,reflectedLight:s}){if(this.sheen===!0&&this.sheenSpecularIndirect.addAssign(t.mul(ss,zN({normal:me,viewDir:ge,roughness:yi}))),this.clearcoat===!0){const l=ns.dot(ge).clamp(),d=EN({dotNV:l,specularColor:No,specularF90:vo,roughness:gn});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(d))}const n=x().temp("singleScattering"),i=x().temp("multiScattering"),r=t.mul(1/Math.PI);this.computeMultiscattering(n,i);const a=n.add(i),c=Se.mul(a.r.max(a.g).max(a.b).oneMinus());s.indirectSpecular.addAssign(e.mul(n)),s.indirectSpecular.addAssign(i.mul(r)),s.indirectDiffuse.addAssign(c.mul(r))}ambientOcclusion({ambientOcclusion:e,reflectedLight:t}){const n=me.dot(ge).clamp().add(e),i=Vs.mul(-16).oneMinus().negate().exp2(),r=e.sub(n.pow(i).oneMinus()).clamp();this.clearcoat===!0&&this.clearcoatSpecularIndirect.mulAssign(e),this.sheen===!0&&this.sheenSpecularIndirect.mulAssign(e),t.indirectDiffuse.mulAssign(e),t.indirectSpecular.mulAssign(r)}finish(e){const{outgoingLight:t}=e;if(this.clearcoat===!0){const s=ns.dot(ge).clamp(),n=js({dotVH:s,f0:No,f90:vo}),i=t.mul(Lo.mul(n).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(Lo));t.assign(i)}if(this.sheen===!0){const s=ss.r.max(ss.g).max(ss.b).mul(.157).oneMinus(),n=t.mul(s).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(n)}}}const jN=new Yr;class td extends Ze{constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(jN),this.setValues(e)}setupLightingModel(){return new Ri}setupVariants(){const e=this.metalnessNode?h(this.metalnessNode):kg;Af.assign(e);let t=this.roughnessNode?h(this.roughnessNode):Hg;t=CN({roughness:t}),Vs.assign(t);const s=Ve(x(.04),Se.rgb,e);vt.assign(s),Se.assign(I(Se.rgb.mul(e.oneMinus()),Se.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}}Be("MeshStandardNodeMaterial",td);const $N=new Gr;class eo extends td{constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.setDefaultValues($N),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||this.clearcoatNode!==null}get useIridescence(){return this.iridescence>0||this.iridescenceNode!==null}get useSheen(){return this.sheen>0||this.sheenNode!==null}setupLightingModel(){return new Ri(this.useClearcoat,this.useSheen,this.useIridescence)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){const t=this.clearcoatNode?h(this.clearcoatNode):qg,s=this.clearcoatRoughnessNode?h(this.clearcoatRoughnessNode):Yg;Lo.assign(t),gn.assign(s)}if(this.useSheen){const t=this.sheenNode?x(this.sheenNode):Qg,s=this.sheenRoughnessNode?h(this.sheenRoughnessNode):Xg;ss.assign(t),yi.assign(s)}if(this.useIridescence){const t=this.iridescenceNode?h(this.iridescenceNode):Jg,s=this.iridescenceIORNode?h(this.iridescenceIORNode):ex,n=this.iridescenceThicknessNode?h(this.iridescenceThicknessNode):tx;Ni.assign(t),sc.assign(s),nc.assign(n)}}setupNormal(e){super.setupNormal(e);const t=this.clearcoatNormalNode?x(this.clearcoatNormalNode):Kg;ns.assign(t)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,super.copy(e)}}Be("MeshPhysicalNodeMaterial",eo);class UN extends Ri{constructor(e,t,s,n){super(e,t,s),this.useSSS=n}direct({lightDirection:e,lightColor:t,reflectedLight:s},n,i){if(this.useSSS===!0){const r=i.material,{thicknessColorNode:a,thicknessDistortionNode:c,thicknessAmbientNode:l,thicknessAttenuationNode:d,thicknessPowerNode:u,thicknessScaleNode:m}=r,w=e.add(me.mul(c)).normalize(),T=h(ge.dot(w.negate()).saturate().pow(u).mul(m)),N=x(T.add(l).mul(a));s.directDiffuse.addAssign(N.mul(d.mul(t)))}super.direct({lightDirection:e,lightColor:t,reflectedLight:s},n,i)}}class WN extends eo{constructor(e){super(e),this.thicknessColorNode=null,this.thicknessDistortionNode=h(.1),this.thicknessAmbientNode=h(0),this.thicknessAttenuationNode=h(.1),this.thicknessPowerNode=h(2),this.thicknessScaleNode=h(10)}get useSSS(){return this.thicknessColorNode!==null}setupLightingModel(){return new UN(this.useClearcoat,this.useSheen,this.useIridescence,this.useSSS)}copy(e){return this.thicknessColorNode=e.thicknessColorNode,this.thicknessDistortionNode=e.thicknessDistortionNode,this.thicknessAmbientNode=e.thicknessAmbientNode,this.thicknessAttenuationNode=e.thicknessAttenuationNode,this.thicknessPowerNode=e.thicknessPowerNode,this.thicknessScaleNode=e.thicknessScaleNode,super.copy(e)}}Be("MeshSSSNodeMaterial",WN);const GN=new oa;class HN extends Ze{constructor(e){super(),this.isPointsNodeMaterial=!0,this.lights=!1,this.normals=!1,this.transparent=!0,this.sizeNode=null,this.setDefaultValues(GN),this.setValues(e)}copy(e){return this.sizeNode=e.sizeNode,super.copy(e)}}Be("PointsNodeMaterial",HN);const kN=new ch;class BN extends Ze{constructor(e){super(),this.isSpriteNodeMaterial=!0,this.lights=!1,this.normals=!1,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.setDefaultValues(kN),this.setValues(e)}setupPosition({object:e,context:t}){const{positionNode:s,rotationNode:n,scaleNode:i}=this,r=Ie;let a=qt.mul(x(s||0)),c=j(yn[0].xyz.length(),yn[1].xyz.length());i!==null&&(c=c.mul(i));let l=r.xy;e.center&&e.center.isVector2===!0&&(l=l.sub(de(e.center).sub(.5))),l=l.mul(c);const d=h(n||Zg),u=l.rotate(d);a=I(a.xy.add(u),a.zw);const m=Tt.mul(a);return t.vertex=r,m}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}}Be("SpriteNodeMaterial",BN);const qN=ra.createMaterialFromType;ra.createMaterialFromType=function(o){const e=Zn(o);return e!==void 0?e:qN.call(this,o)};class YN{parseFunction(){console.warn("Abstract function.")}}class sd{constructor(e,t,s="",n=""){this.type=e,this.inputs=t,this.name=s,this.presicion=n}getCode(){console.warn("Abstract function.")}}sd.isNodeFunction=!0;const KN=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,ZN=/[a-z_0-9]+/ig,Or="#pragma main",QN=o=>{o=o.trim();const e=o.indexOf(Or),t=e!==-1?o.slice(e+Or.length):o,s=t.match(KN);if(s!==null&&s.length===5){const n=s[4],i=[];let r=null;for(;(r=ZN.exec(n))!==null;)i.push(r);const a=[];let c=0;for(;c<i.length;){const T=i[c][0]==="const";T===!0&&c++;let N=i[c][0];N==="in"||N==="out"||N==="inout"?c++:N="";const v=i[c++][0];let O=Number.parseInt(i[c][0]);Number.isNaN(O)===!1?c++:O=null;const P=i[c++][0];a.push(new il(v,P,O,N,T))}const l=t.substring(s[0].length),d=s[3]!==void 0?s[3]:"",u=s[2],m=s[1]!==void 0?s[1]:"",w=e!==-1?o.slice(0,e):"";return{type:u,inputs:a,name:d,presicion:m,inputsCode:n,blockCode:l,headerCode:w}}else throw new Error("FunctionNode: Function is not a GLSL code.")};class XN extends sd{constructor(e){const{type:t,inputs:s,name:n,presicion:i,inputsCode:r,blockCode:a,headerCode:c}=QN(e);super(t,s,n,i),this.inputsCode=r,this.blockCode=a,this.headerCode=c}getCode(e=this.name){let t;const s=this.blockCode;if(s!==""){const{type:n,inputsCode:i,headerCode:r,presicion:a}=this;let c=`${n} ${e} ( ${i.trim()} )`;a!==""&&(c=`${a} ${c}`),t=r+c+s}else t="";return t}}class JN extends YN{parseFunction(e){return new XN(e)}}const ls=_(([o,e,t])=>{const s=h(t).toVar(),n=h(e).toVar(),i=It(o).toVar();return Lt(i,n,s)}),$s=_(([o,e])=>{const t=It(e).toVar(),s=h(o).toVar();return Lt(t,s.negate(),s)}),pe=_(([o])=>{const e=h(o).toVar();return p(ys(e))}),re=_(([o,e])=>{const t=h(o).toVar();return e.assign(pe(t)),t.sub(h(e))}),nd=_(([o,e,t,s,n,i])=>{const r=h(i).toVar(),a=h(n).toVar(),c=h(s).toVar(),l=h(t).toVar(),d=h(e).toVar(),u=h(o).toVar(),m=h(he(1,a)).toVar();return he(1,r).mul(u.mul(m).add(d.mul(a))).add(r.mul(l.mul(m).add(c.mul(a))))}),od=_(([o,e,t,s,n,i])=>{const r=h(i).toVar(),a=h(n).toVar(),c=x(s).toVar(),l=x(t).toVar(),d=x(e).toVar(),u=x(o).toVar(),m=h(he(1,a)).toVar();return he(1,r).mul(u.mul(m).add(d.mul(a))).add(r.mul(l.mul(m).add(c.mul(a))))}),id=qe([nd,od]),rd=_(([o,e,t,s,n,i,r,a,c,l,d])=>{const u=h(d).toVar(),m=h(l).toVar(),w=h(c).toVar(),T=h(a).toVar(),N=h(r).toVar(),v=h(i).toVar(),O=h(n).toVar(),P=h(s).toVar(),L=h(t).toVar(),F=h(e).toVar(),Q=h(o).toVar(),W=h(he(1,w)).toVar(),k=h(he(1,m)).toVar();return h(he(1,u)).toVar().mul(k.mul(Q.mul(W).add(F.mul(w))).add(m.mul(L.mul(W).add(P.mul(w))))).add(u.mul(k.mul(O.mul(W).add(v.mul(w))).add(m.mul(N.mul(W).add(T.mul(w))))))}),ad=_(([o,e,t,s,n,i,r,a,c,l,d])=>{const u=h(d).toVar(),m=h(l).toVar(),w=h(c).toVar(),T=x(a).toVar(),N=x(r).toVar(),v=x(i).toVar(),O=x(n).toVar(),P=x(s).toVar(),L=x(t).toVar(),F=x(e).toVar(),Q=x(o).toVar(),W=h(he(1,w)).toVar(),k=h(he(1,m)).toVar();return h(he(1,u)).toVar().mul(k.mul(Q.mul(W).add(F.mul(w))).add(m.mul(L.mul(W).add(P.mul(w))))).add(u.mul(k.mul(O.mul(W).add(v.mul(w))).add(m.mul(N.mul(W).add(T.mul(w))))))}),cd=qe([rd,ad]),ld=_(([o,e,t])=>{const s=h(t).toVar(),n=h(e).toVar(),i=E(o).toVar(),r=E(i.bitAnd(E(7))).toVar(),a=h(ls(r.lessThan(E(4)),n,s)).toVar(),c=h(G(2,ls(r.lessThan(E(4)),s,n))).toVar();return $s(a,It(r.bitAnd(E(1)))).add($s(c,It(r.bitAnd(E(2)))))}),dd=_(([o,e,t,s])=>{const n=h(s).toVar(),i=h(t).toVar(),r=h(e).toVar(),a=E(o).toVar(),c=E(a.bitAnd(E(15))).toVar(),l=h(ls(c.lessThan(E(8)),r,i)).toVar(),d=h(ls(c.lessThan(E(4)),i,ls(c.equal(E(12)).or(c.equal(E(14))),r,n))).toVar();return $s(l,It(c.bitAnd(E(1)))).add($s(d,It(c.bitAnd(E(2)))))}),_e=qe([ld,dd]),ud=_(([o,e,t])=>{const s=h(t).toVar(),n=h(e).toVar(),i=en(o).toVar();return x(_e(i.x,n,s),_e(i.y,n,s),_e(i.z,n,s))}),hd=_(([o,e,t,s])=>{const n=h(s).toVar(),i=h(t).toVar(),r=h(e).toVar(),a=en(o).toVar();return x(_e(a.x,r,i,n),_e(a.y,r,i,n),_e(a.z,r,i,n))}),Qe=qe([ud,hd]),pd=_(([o])=>{const e=h(o).toVar();return G(.6616,e)}),md=_(([o])=>{const e=h(o).toVar();return G(.982,e)}),fd=_(([o])=>{const e=x(o).toVar();return G(.6616,e)}),gd=qe([pd,fd]),xd=_(([o])=>{const e=x(o).toVar();return G(.982,e)}),yd=qe([md,xd]),ze=_(([o,e])=>{const t=p(e).toVar(),s=E(o).toVar();return s.shiftLeft(t).bitOr(s.shiftRight(p(32).sub(t)))}),Nd=_(([o,e,t])=>{o.subAssign(t),o.bitXorAssign(ze(t,p(4))),t.addAssign(e),e.subAssign(o),e.bitXorAssign(ze(o,p(6))),o.addAssign(t),t.subAssign(e),t.bitXorAssign(ze(e,p(8))),e.addAssign(o),o.subAssign(t),o.bitXorAssign(ze(t,p(16))),t.addAssign(e),e.subAssign(o),e.bitXorAssign(ze(o,p(19))),o.addAssign(t),t.subAssign(e),t.bitXorAssign(ze(e,p(4))),e.addAssign(o)}),ws=_(([o,e,t])=>{const s=E(t).toVar(),n=E(e).toVar(),i=E(o).toVar();return s.bitXorAssign(n),s.subAssign(ze(n,p(14))),i.bitXorAssign(s),i.subAssign(ze(s,p(11))),n.bitXorAssign(i),n.subAssign(ze(i,p(25))),s.bitXorAssign(n),s.subAssign(ze(n,p(16))),i.bitXorAssign(s),i.subAssign(ze(s,p(4))),n.bitXorAssign(i),n.subAssign(ze(i,p(14))),s.bitXorAssign(n),s.subAssign(ze(n,p(24))),s}),Ee=_(([o])=>{const e=E(o).toVar();return h(e).div(h(E(p(4294967295))))}),ot=_(([o])=>{const e=h(o).toVar();return e.mul(e.mul(e.mul(e.mul(e.mul(6).sub(15)).add(10))))}),vd=_(([o])=>{const e=p(o).toVar(),t=E(E(1)).toVar(),s=E(E(p(3735928559)).add(t.shiftLeft(E(2)).add(E(13)))).toVar();return ws(s.add(E(e)),s,s)}),wd=_(([o,e])=>{const t=p(e).toVar(),s=p(o).toVar(),n=E(E(2)).toVar(),i=E().toVar(),r=E().toVar(),a=E().toVar();return i.assign(r.assign(a.assign(E(p(3735928559)).add(n.shiftLeft(E(2)).add(E(13)))))),i.addAssign(E(s)),r.addAssign(E(t)),ws(i,r,a)}),Td=_(([o,e,t])=>{const s=p(t).toVar(),n=p(e).toVar(),i=p(o).toVar(),r=E(E(3)).toVar(),a=E().toVar(),c=E().toVar(),l=E().toVar();return a.assign(c.assign(l.assign(E(p(3735928559)).add(r.shiftLeft(E(2)).add(E(13)))))),a.addAssign(E(i)),c.addAssign(E(n)),l.addAssign(E(s)),ws(a,c,l)}),bd=_(([o,e,t,s])=>{const n=p(s).toVar(),i=p(t).toVar(),r=p(e).toVar(),a=p(o).toVar(),c=E(E(4)).toVar(),l=E().toVar(),d=E().toVar(),u=E().toVar();return l.assign(d.assign(u.assign(E(p(3735928559)).add(c.shiftLeft(E(2)).add(E(13)))))),l.addAssign(E(a)),d.addAssign(E(r)),u.addAssign(E(i)),Nd(l,d,u),l.addAssign(E(n)),ws(l,d,u)}),_d=_(([o,e,t,s,n])=>{const i=p(n).toVar(),r=p(s).toVar(),a=p(t).toVar(),c=p(e).toVar(),l=p(o).toVar(),d=E(E(5)).toVar(),u=E().toVar(),m=E().toVar(),w=E().toVar();return u.assign(m.assign(w.assign(E(p(3735928559)).add(d.shiftLeft(E(2)).add(E(13)))))),u.addAssign(E(l)),m.addAssign(E(c)),w.addAssign(E(a)),Nd(u,m,w),u.addAssign(E(r)),m.addAssign(E(i)),ws(u,m,w)}),B=qe([vd,wd,Td,bd,_d]),Sd=_(([o,e])=>{const t=p(e).toVar(),s=p(o).toVar(),n=E(B(s,t)).toVar(),i=en().toVar();return i.x.assign(n.bitAnd(p(255))),i.y.assign(n.shiftRight(p(8)).bitAnd(p(255))),i.z.assign(n.shiftRight(p(16)).bitAnd(p(255))),i}),Cd=_(([o,e,t])=>{const s=p(t).toVar(),n=p(e).toVar(),i=p(o).toVar(),r=E(B(i,n,s)).toVar(),a=en().toVar();return a.x.assign(r.bitAnd(p(255))),a.y.assign(r.shiftRight(p(8)).bitAnd(p(255))),a.z.assign(r.shiftRight(p(16)).bitAnd(p(255))),a}),Xe=qe([Sd,Cd]),Md=_(([o])=>{const e=j(o).toVar(),t=p().toVar(),s=p().toVar(),n=h(re(e.x,t)).toVar(),i=h(re(e.y,s)).toVar(),r=h(ot(n)).toVar(),a=h(ot(i)).toVar(),c=h(id(_e(B(t,s),n,i),_e(B(t.add(p(1)),s),n.sub(1),i),_e(B(t,s.add(p(1))),n,i.sub(1)),_e(B(t.add(p(1)),s.add(p(1))),n.sub(1),i.sub(1)),r,a)).toVar();return gd(c)}),Od=_(([o])=>{const e=x(o).toVar(),t=p().toVar(),s=p().toVar(),n=p().toVar(),i=h(re(e.x,t)).toVar(),r=h(re(e.y,s)).toVar(),a=h(re(e.z,n)).toVar(),c=h(ot(i)).toVar(),l=h(ot(r)).toVar(),d=h(ot(a)).toVar(),u=h(cd(_e(B(t,s,n),i,r,a),_e(B(t.add(p(1)),s,n),i.sub(1),r,a),_e(B(t,s.add(p(1)),n),i,r.sub(1),a),_e(B(t.add(p(1)),s.add(p(1)),n),i.sub(1),r.sub(1),a),_e(B(t,s,n.add(p(1))),i,r,a.sub(1)),_e(B(t.add(p(1)),s,n.add(p(1))),i.sub(1),r,a.sub(1)),_e(B(t,s.add(p(1)),n.add(p(1))),i,r.sub(1),a.sub(1)),_e(B(t.add(p(1)),s.add(p(1)),n.add(p(1))),i.sub(1),r.sub(1),a.sub(1)),c,l,d)).toVar();return yd(u)}),Ed=qe([Md,Od]),Ad=_(([o])=>{const e=j(o).toVar(),t=p().toVar(),s=p().toVar(),n=h(re(e.x,t)).toVar(),i=h(re(e.y,s)).toVar(),r=h(ot(n)).toVar(),a=h(ot(i)).toVar(),c=x(id(Qe(Xe(t,s),n,i),Qe(Xe(t.add(p(1)),s),n.sub(1),i),Qe(Xe(t,s.add(p(1))),n,i.sub(1)),Qe(Xe(t.add(p(1)),s.add(p(1))),n.sub(1),i.sub(1)),r,a)).toVar();return gd(c)}),Vd=_(([o])=>{const e=x(o).toVar(),t=p().toVar(),s=p().toVar(),n=p().toVar(),i=h(re(e.x,t)).toVar(),r=h(re(e.y,s)).toVar(),a=h(re(e.z,n)).toVar(),c=h(ot(i)).toVar(),l=h(ot(r)).toVar(),d=h(ot(a)).toVar(),u=x(cd(Qe(Xe(t,s,n),i,r,a),Qe(Xe(t.add(p(1)),s,n),i.sub(1),r,a),Qe(Xe(t,s.add(p(1)),n),i,r.sub(1),a),Qe(Xe(t.add(p(1)),s.add(p(1)),n),i.sub(1),r.sub(1),a),Qe(Xe(t,s,n.add(p(1))),i,r,a.sub(1)),Qe(Xe(t.add(p(1)),s,n.add(p(1))),i.sub(1),r,a.sub(1)),Qe(Xe(t,s.add(p(1)),n.add(p(1))),i,r.sub(1),a.sub(1)),Qe(Xe(t.add(p(1)),s.add(p(1)),n.add(p(1))),i.sub(1),r.sub(1),a.sub(1)),c,l,d)).toVar();return yd(u)}),Ld=qe([Ad,Vd]),Pd=_(([o])=>{const e=h(o).toVar(),t=p(pe(e)).toVar();return Ee(B(t))}),Rd=_(([o])=>{const e=j(o).toVar(),t=p(pe(e.x)).toVar(),s=p(pe(e.y)).toVar();return Ee(B(t,s))}),Id=_(([o])=>{const e=x(o).toVar(),t=p(pe(e.x)).toVar(),s=p(pe(e.y)).toVar(),n=p(pe(e.z)).toVar();return Ee(B(t,s,n))}),Dd=_(([o])=>{const e=I(o).toVar(),t=p(pe(e.x)).toVar(),s=p(pe(e.y)).toVar(),n=p(pe(e.z)).toVar(),i=p(pe(e.w)).toVar();return Ee(B(t,s,n,i))}),ev=qe([Pd,Rd,Id,Dd]),Fd=_(([o])=>{const e=h(o).toVar(),t=p(pe(e)).toVar();return x(Ee(B(t,p(0))),Ee(B(t,p(1))),Ee(B(t,p(2))))}),zd=_(([o])=>{const e=j(o).toVar(),t=p(pe(e.x)).toVar(),s=p(pe(e.y)).toVar();return x(Ee(B(t,s,p(0))),Ee(B(t,s,p(1))),Ee(B(t,s,p(2))))}),jd=_(([o])=>{const e=x(o).toVar(),t=p(pe(e.x)).toVar(),s=p(pe(e.y)).toVar(),n=p(pe(e.z)).toVar();return x(Ee(B(t,s,n,p(0))),Ee(B(t,s,n,p(1))),Ee(B(t,s,n,p(2))))}),$d=_(([o])=>{const e=I(o).toVar(),t=p(pe(e.x)).toVar(),s=p(pe(e.y)).toVar(),n=p(pe(e.z)).toVar(),i=p(pe(e.w)).toVar();return x(Ee(B(t,s,n,i,p(0))),Ee(B(t,s,n,i,p(1))),Ee(B(t,s,n,i,p(2))))}),Ud=qe([Fd,zd,jd,$d]),Us=_(([o,e,t,s])=>{const n=h(s).toVar(),i=h(t).toVar(),r=p(e).toVar(),a=x(o).toVar(),c=h(0).toVar(),l=h(1).toVar();return ie({start:p(0),end:r},({i:d})=>{c.addAssign(l.mul(Ed(a))),l.mulAssign(n),a.mulAssign(i)}),c}),Wd=_(([o,e,t,s])=>{const n=h(s).toVar(),i=h(t).toVar(),r=p(e).toVar(),a=x(o).toVar(),c=x(0).toVar(),l=h(1).toVar();return ie({start:p(0),end:r},({i:d})=>{c.addAssign(l.mul(Ld(a))),l.mulAssign(n),a.mulAssign(i)}),c}),tv=_(([o,e,t,s])=>{const n=h(s).toVar(),i=h(t).toVar(),r=p(e).toVar(),a=x(o).toVar();return j(Us(a,r,i,n),Us(a.add(x(p(19),p(193),p(17))),r,i,n))}),sv=_(([o,e,t,s])=>{const n=h(s).toVar(),i=h(t).toVar(),r=p(e).toVar(),a=x(o).toVar(),c=x(Wd(a,r,i,n)).toVar(),l=h(Us(a.add(x(p(19),p(193),p(17))),r,i,n)).toVar();return I(c,l)}),Gd=_(([o,e,t,s,n,i,r])=>{const a=p(r).toVar(),c=h(i).toVar(),l=p(n).toVar(),d=p(s).toVar(),u=p(t).toVar(),m=p(e).toVar(),w=j(o).toVar(),T=x(Ud(j(m.add(d),u.add(l)))).toVar(),N=j(T.x,T.y).toVar();N.subAssign(.5),N.mulAssign(c),N.addAssign(.5);const v=j(j(h(m),h(u)).add(N)).toVar(),O=j(v.sub(w)).toVar();return ee(a.equal(p(2)),()=>je(O.x).add(je(O.y))),ee(a.equal(p(3)),()=>et(je(O.x),je(O.y))),Qt(O,O)}),Hd=_(([o,e,t,s,n,i,r,a,c])=>{const l=p(c).toVar(),d=h(a).toVar(),u=p(r).toVar(),m=p(i).toVar(),w=p(n).toVar(),T=p(s).toVar(),N=p(t).toVar(),v=p(e).toVar(),O=x(o).toVar(),P=x(Ud(x(v.add(w),N.add(m),T.add(u)))).toVar();P.subAssign(.5),P.mulAssign(d),P.addAssign(.5);const L=x(x(h(v),h(N),h(T)).add(P)).toVar(),F=x(L.sub(O)).toVar();return ee(l.equal(p(2)),()=>je(F.x).add(je(F.y).add(je(F.z)))),ee(l.equal(p(3)),()=>et(et(je(F.x),je(F.y)),je(F.z))),Qt(F,F)}),Ts=qe([Gd,Hd]),kd=_(([o,e,t])=>{const s=p(t).toVar(),n=h(e).toVar(),i=j(o).toVar(),r=p().toVar(),a=p().toVar(),c=j(re(i.x,r),re(i.y,a)).toVar(),l=h(1e6).toVar();return ie({start:-1,end:p(1),name:"x",condition:"<="},({x:d})=>{ie({start:-1,end:p(1),name:"y",condition:"<="},({y:u})=>{const m=h(Ts(c,d,u,r,a,n,s)).toVar();l.assign(us(l,m))})}),ee(s.equal(p(0)),()=>{l.assign(jt(l))}),l}),nv=_(([o,e,t])=>{const s=p(t).toVar(),n=h(e).toVar(),i=j(o).toVar(),r=p().toVar(),a=p().toVar(),c=j(re(i.x,r),re(i.y,a)).toVar(),l=j(1e6,1e6).toVar();return ie({start:-1,end:p(1),name:"x",condition:"<="},({x:d})=>{ie({start:-1,end:p(1),name:"y",condition:"<="},({y:u})=>{const m=h(Ts(c,d,u,r,a,n,s)).toVar();ee(m.lessThan(l.x),()=>{l.y.assign(l.x),l.x.assign(m)}).elseif(m.lessThan(l.y),()=>{l.y.assign(m)})})}),ee(s.equal(p(0)),()=>{l.assign(jt(l))}),l}),ov=_(([o,e,t])=>{const s=p(t).toVar(),n=h(e).toVar(),i=j(o).toVar(),r=p().toVar(),a=p().toVar(),c=j(re(i.x,r),re(i.y,a)).toVar(),l=x(1e6,1e6,1e6).toVar();return ie({start:-1,end:p(1),name:"x",condition:"<="},({x:d})=>{ie({start:-1,end:p(1),name:"y",condition:"<="},({y:u})=>{const m=h(Ts(c,d,u,r,a,n,s)).toVar();ee(m.lessThan(l.x),()=>{l.z.assign(l.y),l.y.assign(l.x),l.x.assign(m)}).elseif(m.lessThan(l.y),()=>{l.z.assign(l.y),l.y.assign(m)}).elseif(m.lessThan(l.z),()=>{l.z.assign(m)})})}),ee(s.equal(p(0)),()=>{l.assign(jt(l))}),l}),Bd=_(([o,e,t])=>{const s=p(t).toVar(),n=h(e).toVar(),i=x(o).toVar(),r=p().toVar(),a=p().toVar(),c=p().toVar(),l=x(re(i.x,r),re(i.y,a),re(i.z,c)).toVar(),d=h(1e6).toVar();return ie({start:-1,end:p(1),name:"x",condition:"<="},({x:u})=>{ie({start:-1,end:p(1),name:"y",condition:"<="},({y:m})=>{ie({start:-1,end:p(1),name:"z",condition:"<="},({z:w})=>{const T=h(Ts(l,u,m,w,r,a,c,n,s)).toVar();d.assign(us(d,T))})})}),ee(s.equal(p(0)),()=>{d.assign(jt(d))}),d}),iv=qe([kd,Bd]),rv=_(([o,e,t])=>{const s=p(t).toVar(),n=h(e).toVar(),i=x(o).toVar(),r=p().toVar(),a=p().toVar(),c=p().toVar(),l=x(re(i.x,r),re(i.y,a),re(i.z,c)).toVar(),d=j(1e6,1e6).toVar();return ie({start:-1,end:p(1),name:"x",condition:"<="},({x:u})=>{ie({start:-1,end:p(1),name:"y",condition:"<="},({y:m})=>{ie({start:-1,end:p(1),name:"z",condition:"<="},({z:w})=>{const T=h(Ts(l,u,m,w,r,a,c,n,s)).toVar();ee(T.lessThan(d.x),()=>{d.y.assign(d.x),d.x.assign(T)}).elseif(T.lessThan(d.y),()=>{d.y.assign(T)})})})}),ee(s.equal(p(0)),()=>{d.assign(jt(d))}),d}),av=_(([o,e,t])=>{const s=p(t).toVar(),n=h(e).toVar(),i=x(o).toVar(),r=p().toVar(),a=p().toVar(),c=p().toVar(),l=x(re(i.x,r),re(i.y,a),re(i.z,c)).toVar(),d=x(1e6,1e6,1e6).toVar();return ie({start:-1,end:p(1),name:"x",condition:"<="},({x:u})=>{ie({start:-1,end:p(1),name:"y",condition:"<="},({y:m})=>{ie({start:-1,end:p(1),name:"z",condition:"<="},({z:w})=>{const T=h(Ts(l,u,m,w,r,a,c,n,s)).toVar();ee(T.lessThan(d.x),()=>{d.z.assign(d.y),d.y.assign(d.x),d.x.assign(T)}).elseif(T.lessThan(d.y),()=>{d.z.assign(d.y),d.y.assign(T)}).elseif(T.lessThan(d.z),()=>{d.z.assign(T)})})})}),ee(s.equal(p(0)),()=>{d.assign(jt(d))}),d});ls.setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]});$s.setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]});pe.setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]});nd.setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]});od.setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]});rd.setLayout({name:"mx_trilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"v4",type:"float"},{name:"v5",type:"float"},{name:"v6",type:"float"},{name:"v7",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]});ad.setLayout({name:"mx_trilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"v4",type:"vec3"},{name:"v5",type:"vec3"},{name:"v6",type:"vec3"},{name:"v7",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]});ld.setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]});dd.setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]});ud.setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]});hd.setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]});pd.setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]});md.setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]});fd.setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]});xd.setLayout({name:"mx_gradient_scale3d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]});ze.setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]});ws.setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]});Ee.setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]});ot.setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]});vd.setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]});wd.setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]});Td.setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]});bd.setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]});_d.setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]});Sd.setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]});Cd.setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]});Md.setLayout({name:"mx_perlin_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"}]});Od.setLayout({name:"mx_perlin_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"}]});Ad.setLayout({name:"mx_perlin_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"}]});Vd.setLayout({name:"mx_perlin_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"}]});Pd.setLayout({name:"mx_cell_noise_float_0",type:"float",inputs:[{name:"p",type:"float"}]});Rd.setLayout({name:"mx_cell_noise_float_1",type:"float",inputs:[{name:"p",type:"vec2"}]});Id.setLayout({name:"mx_cell_noise_float_2",type:"float",inputs:[{name:"p",type:"vec3"}]});Dd.setLayout({name:"mx_cell_noise_float_3",type:"float",inputs:[{name:"p",type:"vec4"}]});Fd.setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]});zd.setLayout({name:"mx_cell_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec2"}]});jd.setLayout({name:"mx_cell_noise_vec3_2",type:"vec3",inputs:[{name:"p",type:"vec3"}]});$d.setLayout({name:"mx_cell_noise_vec3_3",type:"vec3",inputs:[{name:"p",type:"vec4"}]});Us.setLayout({name:"mx_fractal_noise_float",type:"float",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]});Wd.setLayout({name:"mx_fractal_noise_vec3",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]});tv.setLayout({name:"mx_fractal_noise_vec2",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]});sv.setLayout({name:"mx_fractal_noise_vec4",type:"vec4",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]});Gd.setLayout({name:"mx_worley_distance_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});Hd.setLayout({name:"mx_worley_distance_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"zoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});kd.setLayout({name:"mx_worley_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});nv.setLayout({name:"mx_worley_noise_vec2_0",type:"vec2",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});ov.setLayout({name:"mx_worley_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});Bd.setLayout({name:"mx_worley_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});rv.setLayout({name:"mx_worley_noise_vec2_1",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});av.setLayout({name:"mx_worley_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});const qd=_(([o])=>{const e=x(o).toVar(),t=h(e.x).toVar(),s=h(e.y).toVar(),n=h(e.z).toVar();ee(s.lessThan(1e-4),()=>x(n,n,n)).else(()=>{t.assign(G(6,t.sub(ys(t))));const i=p(yc(t)).toVar(),r=h(t.sub(h(i))).toVar(),a=h(n.mul(he(1,s))).toVar(),c=h(n.mul(he(1,s.mul(r)))).toVar(),l=h(n.mul(he(1,s.mul(he(1,r))))).toVar();return ee(i.equal(p(0)),()=>x(n,l,a)).elseif(i.equal(p(1)),()=>x(c,n,a)).elseif(i.equal(p(2)),()=>x(a,n,l)).elseif(i.equal(p(3)),()=>x(a,c,n)).elseif(i.equal(p(4)),()=>x(l,a,n)),x(n,a,c)})}),Yd=_(([o])=>{const e=x(o).toVar(),t=h(e.x).toVar(),s=h(e.y).toVar(),n=h(e.z).toVar(),i=h(us(t,us(s,n))).toVar(),r=h(et(t,et(s,n))).toVar(),a=h(r.sub(i)).toVar(),c=h().toVar(),l=h().toVar(),d=h().toVar();return d.assign(r),ee(r.greaterThan(0),()=>{l.assign(a.div(r))}).else(()=>{l.assign(0)}),ee(l.lessThanEqual(0),()=>{c.assign(0)}).else(()=>{ee(t.greaterThanEqual(r),()=>{c.assign(s.sub(n).div(a))}).elseif(s.greaterThanEqual(r),()=>{c.assign(He(2,n.sub(t).div(a)))}).else(()=>{c.assign(He(4,t.sub(s).div(a)))}),c.mulAssign(1/6),ee(c.lessThan(0),()=>{c.addAssign(1)})}),x(c,l,d)});qd.setLayout({name:"mx_hsvtorgb",type:"vec3",inputs:[{name:"hsv",type:"vec3"}]});Yd.setLayout({name:"mx_rgbtohsv",type:"vec3",inputs:[{name:"c",type:"vec3"}]});const Kd=_(([o])=>{const e=x(o).toVar(),t=ka(lc(e,x(.04045))).toVar(),s=x(e.div(12.92)).toVar(),n=x(st(et(e.add(x(.055)),x(0)).div(1.055),x(2.4))).toVar();return Ve(s,n,t)});Kd.setLayout({name:"mx_srgb_texture_to_lin_rec709",type:"vec3",inputs:[{name:"color",type:"vec3"}]});const cv=(o,e)=>{o=h(o),e=h(e);const t=j(e.dFdx(),e.dFdy()).length().mul(.7071067811865476);return rt(o.sub(t),o.add(t),e)},Zd=(o,e,t,s)=>Ve(o,e,t[s].clamp()),lv=(o,e,t=fe())=>Zd(o,e,t,"x"),dv=(o,e,t=fe())=>Zd(o,e,t,"y"),Qd=(o,e,t,s,n)=>Ve(o,e,cv(t,s[n])),uv=(o,e,t,s=fe())=>Qd(o,e,t,s,"x"),hv=(o,e,t,s=fe())=>Qd(o,e,t,s,"y"),pv=(o=1,e=0,t=fe())=>t.mul(o).add(e),mv=(o,e=1)=>(o=h(o),o.abs().pow(e).mul(o.sign())),fv=(o,e=1,t=.5)=>h(o).sub(t).mul(e).add(t),Er=(o=fe(),e=1,t=0)=>Ed(o.convert("vec2|vec3")).mul(e).add(t),gv=(o=fe(),e=1,t=0)=>Ld(o.convert("vec2|vec3")).mul(e).add(t),Ar=(o=fe(),e=1)=>iv(o.convert("vec2|vec3"),e,p(1)),Vr=(o=fe())=>ev(o.convert("vec2|vec3")),xv=(o=fe(),e=3,t=2,s=.5,n=1)=>Us(o,p(e),t,s).mul(n),yv={mx_srgb_texture_to_lin_rec709:Kd};class z{constructor(e,t,s=null){this.name=e,this.nodeFunc=t,this.params=s}}const Nv=(o,e=h(0))=>He(o,e),vv=(o,e=h(0))=>he(o,e),wv=(o,e=h(1))=>G(o,e),Tv=(o,e=h(1))=>Bt(o,e),bv=(o,e=h(1))=>vc(o,e),_v=(o,e=h(1))=>st(o,e),Sv=(o=h(0),e=h(1))=>Nc(o,e),Cv=[new z("add",Nv,["in1","in2"]),new z("subtract",vv,["in1","in2"]),new z("multiply",wv,["in1","in2"]),new z("divide",Tv,["in1","in2"]),new z("modulo",bv,["in1","in2"]),new z("absval",je,["in1","in2"]),new z("sign",Gn,["in1","in2"]),new z("floor",ys,["in1","in2"]),new z("ceil",Ti,["in1","in2"]),new z("round",xc,["in1","in2"]),new z("power",_v,["in1","in2"]),new z("sin",wt,["in"]),new z("cos",At,["in"]),new z("tan",pc,["in"]),new z("asin",mc,["in"]),new z("acos",fc,["in"]),new z("atan2",Sv,["in1","in2"]),new z("sqrt",jt,["in"]),new z("exp",uc,["in"]),new z("clamp",Ds,["in","low","high"]),new z("min",us,["in1","in2"]),new z("max",et,["in1","in2"]),new z("normalize",Ke,["in"]),new z("magnitude",gc,["in1","in2"]),new z("dotproduct",Qt,["in1","in2"]),new z("crossproduct",wc,["in"]),new z("normalmap",Pl,["in","scale"]),new z("remap",fl,["in","inlow","inhigh","outlow","outhigh"]),new z("smoothstep",rt,["in","low","high"]),new z("luminance",Vi,["in","lumacoeffs"]),new z("rgbtohsv",Yd,["in"]),new z("hsvtorgb",qd,["in"]),new z("mix",Ve,["bg","fg","mix"]),new z("combine2",j,["in1","in2"]),new z("combine3",x,["in1","in2","in3"]),new z("combine4",I,["in1","in2","in3","in4"]),new z("ramplr",lv,["valuel","valuer","texcoord"]),new z("ramptb",dv,["valuet","valueb","texcoord"]),new z("splitlr",uv,["valuel","valuer","texcoord"]),new z("splittb",hv,["valuet","valueb","texcoord"]),new z("noise2d",Er,["texcoord","amplitude","pivot"]),new z("noise3d",Er,["texcoord","amplitude","pivot"]),new z("fractal3d",xv,["position","octaves","lacunarity","diminish","amplitude"]),new z("cellnoise2d",Vr,["texcoord"]),new z("cellnoise3d",Vr,["texcoord"]),new z("worleynoise2d",Ar,["texcoord","jitter"]),new z("worleynoise3d",Ar,["texcoord","jitter"]),new z("safepower",mv,["in1","in2"]),new z("contrast",fv,["in","amount","pivot"]),new z("saturate",Al,["in","amount"])],Ho={};Cv.forEach(o=>Ho[o.name]=o);class Mv extends lh{constructor(e){super(e)}load(e,t,s,n){const i=function(r){n?n(r):console.error(r)};return new dh(this.manager).setPath(this.path).load(e,async r=>{try{t(this.parse(r))}catch(a){i(a)}},s,i),this}parse(e){return new Ev(this.manager,this.path).parse(e)}}class Ov{constructor(e,t,s=""){this.materialX=e,this.nodeXML=t,this.nodePath=s?s+"/"+this.name:this.name,this.parent=null,this.node=null,this.children=[]}get element(){return this.nodeXML.nodeName}get nodeGraph(){return this.getAttribute("nodegraph")}get nodeName(){return this.getAttribute("nodename")}get interfaceName(){return this.getAttribute("interfacename")}get output(){return this.getAttribute("output")}get name(){return this.getAttribute("name")}get type(){return this.getAttribute("type")}get value(){return this.getAttribute("value")}getNodeGraph(){let e=this;for(;e!==null&&e.element!=="nodegraph";)e=e.parent;return e}getRoot(){let e=this;for(;e.parent!==null;)e=e.parent;return e}get referencePath(){let e=null;return this.nodeGraph!==null&&this.output!==null?e=this.nodeGraph+"/"+this.output:(this.nodeName!==null||this.interfaceName!==null)&&(e=this.getNodeGraph().nodePath+"/"+(this.nodeName||this.interfaceName)),e}get hasReference(){return this.referencePath!==null}get isConst(){return this.element==="input"&&this.value!==null&&this.type!=="filename"}getColorSpaceNode(){const e=this.getAttribute("colorspace"),t=this.getRoot().getAttribute("colorspace"),s=`mx_${e}_to_${t}`;return yv[s]}getTexture(){const e=this.getRecursiveAttribute("fileprefix")||"";let t=this.materialX.textureLoader;const s=e+this.value;if(s){const i=this.materialX.manager.getHandler(s);i!==null&&(t=i)}const n=t.load(s);return n.wrapS=n.wrapT=hh,n.flipY=!1,n}getClassFromType(e){let t=null;return e==="integer"?t=p:e==="float"?t=h:e==="vector2"?t=j:e==="vector3"?t=x:e==="vector4"||e==="color4"?t=I:e==="color3"?t=Vo:e==="boolean"&&(t=It),t}getNode(){let e=this.node;if(e!==null)return e;const t=this.type;if(this.isConst)e=this.getClassFromType(t)(...this.getVector());else if(this.hasReference)e=this.materialX.getMaterialXNode(this.referencePath).getNode();else{const n=this.element;if(n==="convert")e=this.getClassFromType(t)(this.getNodeByName("in"));else if(n==="constant")e=this.getNodeByName("value");else if(n==="position")e=this.getAttribute("space")==="world"?Pc:Ie;else if(n==="normal")e=this.getAttribute("space")==="world"?kn:ft;else if(n==="tangent")e=this.getAttribute("space")==="world"?zc:qn;else if(n==="texcoord"){const i=this.getChildByName("index"),r=i?parseInt(i.value):0;e=fe(r)}else if(n==="geomcolor"){const i=this.getChildByName("index"),r=i?parseInt(i.value):0;e=oy(r)}else if(n==="tiledimage"){const i=this.getChildByName("file"),r=i.getTexture(),a=pv(...this.getNodesByNames(["uvtiling","uvoffset"]));e=Re(r,a);const c=i.getColorSpaceNode();c&&(e=c(e))}else if(n==="image"){const i=this.getChildByName("file"),r=this.getNodeByName("texcoord"),a=i.getTexture();e=Re(a,r);const c=i.getColorSpaceNode();c&&(e=c(e))}else if(Ho[n]!==void 0){const i=Ho[n];e=i.nodeFunc(...this.getNodesByNames(...i.params))}}e===null&&(console.warn(`THREE.MaterialXLoader: Unexpected node ${new XMLSerializer().serializeToString(this.nodeXML)}.`),e=h(0));const s=this.getClassFromType(t);return s!==null&&(e=s(e)),e.name=this.name,this.node=e,e}getChildByName(e){for(const t of this.children)if(t.name===e)return t}getNodes(){const e={};for(const t of this.children){const s=t.getNode();e[s.name]=s}return e}getNodeByName(e){const t=this.getChildByName(e);return t?t.getNode():void 0}getNodesByNames(...e){const t=[];for(const s of e){const n=this.getNodeByName(s);n&&t.push(n)}return t}getValue(){return this.value.trim()}getVector(){const e=[];for(const t of this.getValue().split(/[,|\s]/))t!==""&&e.push(Number(t.trim()));return e}getAttribute(e){return this.nodeXML.getAttribute(e)}getRecursiveAttribute(e){let t=this.nodeXML.getAttribute(e);return t===null&&this.parent!==null&&(t=this.parent.getRecursiveAttribute(e)),t}setStandardSurfaceToGltfPBR(e){const t=this.getNodes();let s=null;t.base&&t.base_color?s=G(t.base,t.base_color):t.base?s=t.base:t.base_color&&(s=t.base_color);let n=null;t.specular_roughness&&(n=t.specular_roughness);let i=null;t.metalness&&(i=t.metalness);let r=null,a=null;t.coat&&(r=t.coat),t.coat_roughness&&(a=t.coat_roughness),t.coat_color&&(s=s&&G(s,t.coat_color));let c=null;t.normal&&(c=t.normal);let l=null;t.emission&&(l=t.emission),t.emissionColor&&(l=l&&G(l,t.emissionColor)),e.colorNode=s||Vo(.8,.8,.8),e.roughnessNode=n||h(.2),e.metalnessNode=i||h(0),e.clearcoatNode=r||h(0),e.clearcoatRoughnessNode=a||h(0),c&&(e.normalNode=c),l&&(e.emissiveNode=l)}setMaterial(e){const t=this.element;t==="gltf_pbr"||t==="standard_surface"&&this.setStandardSurfaceToGltfPBR(e)}toBasicMaterial(){const e=new Xl;e.name=this.name;for(const t of this.children.toReversed())if(t.name==="out"){e.colorNode=t.getNode();break}return e}toPhysicalMaterial(){const e=new eo;e.name=this.name;for(const t of this.children)this.materialX.getMaterialXNode(t.nodeName).setMaterial(e);return e}toMaterials(){const e={};let t=!0;for(const s of this.children)if(s.element==="surfacematerial"){const n=s.toPhysicalMaterial();e[n.name]=n,t=!1}if(t){for(const s of this.children)if(s.element==="nodegraph"){const n=s.toBasicMaterial();e[n.name]=n}}return e}add(e){e.parent=this,this.children.push(e)}}class Ev{constructor(e,t){this.manager=e,this.path=t,this.resourcePath="",this.nodesXLib=new Map,this.textureLoader=new uh(e)}addMaterialXNode(e){this.nodesXLib.set(e.nodePath,e)}getMaterialXNode(...e){return this.nodesXLib.get(e.join("/"))}parseNode(e,t=""){const s=new Ov(this,e,t);s.nodePath&&this.addMaterialXNode(s);for(const n of e.children){const i=this.parseNode(n,s.nodePath);s.add(i)}return s}parse(e){const t=new DOMParser().parseFromString(e,"application/xml").documentElement;return this.textureLoader.setPath(this.path),{materials:this.parseNode(t).toMaterials()}}}class Av extends D{constructor(e){super(e.nodeType),this.node=null,this.source=null,this.target=null,this.inclusionType="replace",Object.assign(this,e)}generate(e){return this.node.build(e,this.getNodeType(e))}}const ne=Av,ln=new ol;ln.camera=new qr;const Lr={LineBasicNodeMaterial:es.basic,MeshBasicNodeMaterial:es.basic,PointsNodeMaterial:es.points,MeshStandardNodeMaterial:es.standard,MeshPhysicalNodeMaterial:es.physical,MeshPhongNodeMaterial:es.phong},Vv={[f.ATAN2]:"atan"},Lv={low:"lowp",medium:"mediump",high:"highp"};function Et(o){return`#include <${o}>`}function Ms(o){return`${o}Shader`}class Pv extends Ux{constructor(e,t,s,n=null){super(e,t,new JN,null,n),this.shader=s,this.slots={vertex:[],fragment:[]},this._parseShaderLib(),this._parseInclude("fragment","lights_physical_fragment","clearcoat_normal_fragment_begin","transmission_fragment"),this._parseObject(),this._sortSlotsToFlow()}getMethod(e){return Vv[e]||e}addSlot(e,t){this.slots[e].push(t)}_parseShaderLib(){const e=this.material;let t=e.type;if(e.isMeshPhysicalNodeMaterial?t="MeshPhysicalNodeMaterial":e.isMeshStandardNodeMaterial?t="MeshStandardNodeMaterial":e.isMeshPhongNodeMaterial?t="MeshPhongNodeMaterial":e.isMeshBasicNodeMaterial?t="MeshBasicNodeMaterial":e.isPointsNodeMaterial?t="PointsNodeMaterial":e.isLineBasicNodeMaterial&&(t="LineBasicNodeMaterial"),Lr[t]!==void 0){const s=Lr[t],n=this.shader;n.vertexShader=s.vertexShader,n.fragmentShader=s.fragmentShader,n.uniforms=ph.merge([s.uniforms,mh.lights])}}_parseObject(){const{material:e,renderer:t}=this;this.addSlot("fragment",new ne({node:_t,nodeType:"vec3",source:"void main() {",target:"vec3 TransformedNormalView = %RESULT%;",inclusionType:"append"})),t.toneMappingNode&&t.toneMappingNode.isNode===!0&&this.addSlot("fragment",new ne({node:e.colorNode,nodeType:"vec4",source:Et("tonemapping_fragment"),target:""})),e.colorNode&&e.colorNode.isNode&&this.addSlot("fragment",new ne({node:e.colorNode,nodeType:"vec4",source:"vec4 diffuseColor = vec4( diffuse, opacity );",target:"vec4 diffuseColor = %RESULT%; diffuseColor.a *= opacity;"})),e.opacityNode&&e.opacityNode.isNode&&this.addSlot("fragment",new ne({node:e.opacityNode,nodeType:"float",source:Et("alphatest_fragment"),target:"diffuseColor.a = %RESULT%;",inclusionType:"append"})),e.normalNode&&e.normalNode.isNode&&this.addSlot("fragment",new ne({node:e.normalNode,nodeType:"vec3",source:Et("normal_fragment_begin"),target:"normal = %RESULT%;",inclusionType:"append"})),e.emissiveNode&&e.emissiveNode.isNode&&this.addSlot("fragment",new ne({node:e.emissiveNode,nodeType:"vec3",source:Et("emissivemap_fragment"),target:"totalEmissiveRadiance = %RESULT%;",inclusionType:"append"})),e.isMeshStandardNodeMaterial&&(e.metalnessNode&&e.metalnessNode.isNode&&this.addSlot("fragment",new ne({node:e.metalnessNode,nodeType:"float",source:Et("metalnessmap_fragment"),target:"metalnessFactor = %RESULT%;",inclusionType:"append"})),e.roughnessNode&&e.roughnessNode.isNode&&this.addSlot("fragment",new ne({node:e.roughnessNode,nodeType:"float",source:Et("roughnessmap_fragment"),target:"roughnessFactor = %RESULT%;",inclusionType:"append"})),e.isMeshPhysicalNodeMaterial&&(e.clearcoatNode&&e.clearcoatNode.isNode?(this.addSlot("fragment",new ne({node:e.clearcoatNode,nodeType:"float",source:"material.clearcoat = clearcoat;",target:"material.clearcoat = %RESULT%;"})),e.clearcoatRoughnessNode&&e.clearcoatRoughnessNode.isNode&&this.addSlot("fragment",new ne({node:e.clearcoatRoughnessNode,nodeType:"float",source:"material.clearcoatRoughness = clearcoatRoughness;",target:"material.clearcoatRoughness = %RESULT%;"})),e.clearcoatNormalNode&&e.clearcoatNormalNode.isNode&&this.addSlot("fragment",new ne({node:e.clearcoatNormalNode,nodeType:"vec3",source:"vec3 clearcoatNormal = nonPerturbedNormal;",target:"vec3 clearcoatNormal = %RESULT%;"})),e.defines.USE_CLEARCOAT=""):delete e.defines.USE_CLEARCOAT,e.sheenNode&&e.sheenNode.isNode?(this.addSlot("fragment",new ne({node:e.sheenNode,nodeType:"vec3",source:"material.sheenColor = sheenColor;",target:"material.sheenColor = %RESULT%;"})),e.sheenRoughnessNode&&e.sheenRoughnessNode.isNode&&this.addSlot("fragment",new ne({node:e.sheenRoughnessNode,nodeType:"float",source:"material.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );",target:"material.sheenRoughness = clamp( %RESULT%, 0.07, 1.0 );"})),e.defines.USE_SHEEN=""):delete e.defines.USE_SHEEN,e.iridescenceNode&&e.iridescenceNode.isNode?(this.addSlot("fragment",new ne({node:e.iridescenceNode,nodeType:"float",source:"material.iridescence = iridescence;",target:"material.iridescence = %RESULT%;"})),e.iridescenceIORNode&&e.iridescenceIORNode.isNode&&this.addSlot("fragment",new ne({node:e.iridescenceIORNode,nodeType:"float",source:"material.iridescenceIOR = iridescenceIOR;",target:"material.iridescenceIOR = %RESULT%;"})),e.iridescenceThicknessNode&&e.iridescenceThicknessNode.isNode&&this.addSlot("fragment",new ne({node:e.iridescenceThicknessNode,nodeType:"float",source:"material.iridescenceThickness = iridescenceThicknessMaximum;",target:"material.iridescenceThickness = %RESULT%;"})),e.defines.USE_IRIDESCENCE=""):delete e.defines.USE_IRIDESCENCE,e.iorNode&&e.iorNode.isNode&&this.addSlot("fragment",new ne({node:e.iorNode,nodeType:"float",source:"material.ior = ior;",target:"material.ior = %RESULT%;"})),e.specularColorNode&&e.specularColorNode.isNode&&this.addSlot("fragment",new ne({node:e.specularColorNode,nodeType:"vec3",source:"vec3 specularColorFactor = specularColor;",target:"vec3 specularColorFactor = %RESULT%;"})),e.specularIntensityNode&&e.specularIntensityNode.isNode&&this.addSlot("fragment",new ne({node:e.specularIntensityNode,nodeType:"float",source:"float specularIntensityFactor = specularIntensity;",target:"float specularIntensityFactor = %RESULT%;"})),e.transmissionNode&&e.transmissionNode.isNode?(this.addSlot("fragment",new ne({node:e.transmissionNode,nodeType:"float",source:"material.transmission = transmission;",target:"material.transmission = %RESULT%;"})),e.thicknessNode&&e.thicknessNode.isNode&&this.addSlot("fragment",new ne({node:e.thicknessNode,nodeType:"float",source:"material.thickness = thickness;",target:"material.thickness = %RESULT%;"})),e.attenuationDistanceNode&&e.attenuationDistanceNode.isNode&&this.addSlot("fragment",new ne({node:e.attenuationDistanceNode,nodeType:"float",source:"material.attenuationDistance = attenuationDistance;",target:"material.attenuationDistance = %RESULT%;"})),e.attenuationColorNode&&e.attenuationColorNode.isNode&&this.addSlot("fragment",new ne({node:e.attenuationColorNode,nodeType:"vec3",source:"material.attenuationColor = attenuationColor;",target:"material.attenuationColor = %RESULT%;"})),e.transmission=1,e.defines.USE_TRANSMISSION=""):(e.transmission=0,delete e.defines.USE_TRANSMISSION))),e.positionNode&&e.positionNode.isNode&&this.addSlot("vertex",new ne({node:e.positionNode,nodeType:"vec3",source:Et("begin_vertex"),target:"transformed = %RESULT%;",inclusionType:"append"})),e.sizeNode&&e.sizeNode.isNode&&this.addSlot("vertex",new ne({node:e.sizeNode,nodeType:"float",source:"gl_PointSize = size;",target:"gl_PointSize = %RESULT%;"}))}generateTexture(e,t,s){return e.isTextureCube?`textureCube( ${t}, ${s} )`:`texture2D( ${t}, ${s} )`}generateTextureLevel(e,t,s,n){return this.material.extensions!==void 0&&(this.material.extensions.shaderTextureLOD=!0),`textureLod( ${t}, ${s}, ${n} )`}buildFunctionCode(e){const t=e.layout,s=this.flowShaderNode(e),n=[];for(const r of t.inputs)n.push(this.getType(r.type)+" "+r.name);return`${this.getType(t.type)} ${t.name}( ${n.join(", ")} ) {

	${s.vars}

${s.code}
	return ${s.result};

}`}getUniforms(e){const t=this.uniforms[e];let s="";for(const n of t){if(/^(modelViewMatrix|projectionMatrix)$/.test(n.name))continue;let i=null;n.type==="texture"?i=`sampler2D ${n.name}; `:n.type==="cubeTexture"?i=`samplerCube ${n.name}; `:i=`${this.getVectorType(n.type)} ${n.name}; `;const r=n.node.precision;r!==null?i="uniform "+Lv[r]+" "+i:i="uniform "+i,s+=i}return s}getAttributes(e){let t="";if(e==="vertex"){const s=this.attributes;for(const n of s)/^(position|normal|uv[1-3]?)$/.test(n.name)||(t+=`attribute ${n.type} ${n.name}; `)}return t}getVaryings(e){let t="";const s=this.varyings;if(e==="vertex")for(const n of s)t+=`${n.needsInterpolation?"varying":"/*varying*/"} ${n.type} ${n.name}; `;else if(e==="fragment")for(const n of s)n.needsInterpolation&&(t+=`varying ${n.type} ${n.name}; `);return t}addCode(e,t,s,n=this){const i=Ms(e);let r=n[i];const a=r.indexOf(t);if(a!==-1){const c=r.substring(0,a+t.length),l=r.substring(a+t.length);r=`${c}
${s}
${l}`}n[i]=r}replaceCode(e,t,s,n=this){const i=Ms(e);n[i]=n[i].replaceAll(t,s)}getVertexIndex(){return"gl_VertexID"}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord"}isFlipY(){return!0}buildCode(){const e={};for(const t of Os){const s=this.getUniforms(t),n=this.getAttributes(t),i=this.getVaryings(t),r=this.getVars(t),a=this.getCodes(t);e[t]=`${this.getSignature()}
// <node_builder>

// uniforms
${s}

// attributes
${n}

// varyings
${i}

// vars
${r}

// codes
${a}

// </node_builder>

${this.shader[Ms(t)]}
`}this.vertexShader=e.vertex,this.fragmentShader=e.fragment}build(){return super.build(!1),this._addSnippets(),this._addUniforms(),this._updateUniforms(),this.shader.vertexShader=this.vertexShader,this.shader.fragmentShader=this.fragmentShader,this}_parseInclude(e,...t){for(const s of t){const n=Et(s),i=fh[s],r=Ms(e);this.shader[r]=this.shader[r].replaceAll(n,i)}}_sortSlotsToFlow(){for(const e of Os){const t=this.shader[Ms(e)],s=this.slots[e].sort((n,i)=>t.indexOf(n.source)>t.indexOf(i.source)?1:-1);for(const n of s)this.addFlow(e,n)}}_addSnippets(){for(const e of Os){for(const t of this.slots[e]){const s=this.getFlowData(t),n=t.inclusionType,i=t.source,r=s.code+`
	`+t.target.replace("%RESULT%",s.result);n==="append"?this.addCode(e,i,r):n==="replace"?this.replaceCode(e,i,r):console.warn(`Inclusion type "${n}" not compatible.`)}this.addCode(e,"main() {",`
	`+this.flowCode[e])}}_addUniforms(){for(const e of Os)for(const t of this.uniforms[e])this.shader.uniforms[t.name]=t}_updateUniforms(){ln.object=this.object,ln.renderer=this.renderer;for(const e of this.updateNodes)ln.updateNode(e)}}const Xd=new WeakMap,kt=new ol;ks.prototype.onBuild=function(o,e,t){const s=this;s.isNodeMaterial===!0&&Xd.set(s,new Pv(o,t,e,s).build())};ks.prototype.onBeforeRender=function(o,e,t,s,n){const i=Xd.get(this);if(i!==void 0){kt.material=this,kt.camera=t,kt.object=n,kt.renderer=o;const r=i.updateNodes;if(r.length>0){o.state.useProgram(null);for(const a of r)kt.updateNode(a)}}};var Rv=Object.defineProperty,Iv=Object.getOwnPropertyDescriptor,Jd=(o,e,t,s)=>{for(var n=s>1?void 0:s?Iv(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Rv(e,t,n),n};const wo=xt("debugmaterialx");class Ii extends R{constructor(){super(...arguments),this.images=[]}async awake(){this.materialXAsset&&this.loadMaterialX(this.materialXAsset)}update(){kt.update()}async loadMaterialX(e){const t=te.getComponent(this.gameObject,ut);if(!t)return;const s=new gh;s.resolveURL=r=>{if(r.startsWith("assets/"))return r;const c=r.split("/").pop();return wo&&console.log("resolveURL",r,c),"assets/"+c};const i=await new Mv(s).setPath("").loadAsync(e).then(({materials:r})=>(wo&&console.log("Loaded .mtlx materials",r),Object.values(r)[0]));wo&&console.log("Loaded .mtlx material",i,e),i&&(t.sharedMaterial=i)}}Jd([S(URL)],Ii.prototype,"materialXAsset",2);Jd([S(Su)],Ii.prototype,"images",2);const Dv=xt("debugmaterialx");class Fv extends R{start(){const e=te.getComponent(this.gameObject,ut);e&&(this.material=new eo({}),e.sharedMaterial=this.material,this.constructNodeGraph(this.material),this.material.needsUpdate=!0)}constructNodeGraph(e){const t=pl(1);this.timerNode=t;const s=kn.mul(10).add(t),n=gv(s);e.colorNode=n}update(){if(Ps()&&this.material&&this.constructNodeGraph!==this.methodCacheKey){Dv&&console.log("rebuilding node graph"),this.methodCacheKey=this.constructNodeGraph;try{this.constructNodeGraph(this.material),this.material.needsUpdate=!0}catch(e){throw console.error(e),ce(e.message,$r.Error),e}}this.timerNode&&(this.timerNode.value=Math.sin(this.context.time.time)),kt.update()}}var zv=Object.defineProperty,jv=Object.getOwnPropertyDescriptor,eu=(o,e,t,s)=>{for(var n=s>1?void 0:s?jv(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&zv(e,t,n),n};const To=xt("debugtonemapping");var tu=(o=>(o[o.NoToneMapping=0]="NoToneMapping",o[o.LinearToneMapping=1]="LinearToneMapping",o[o.ReinhardToneMapping=2]="ReinhardToneMapping",o[o.CineonToneMapping=3]="CineonToneMapping",o[o.ACESFilmicToneMapping=4]="ACESFilmicToneMapping",o[o.CustomToneMapping=5]="CustomToneMapping",o[o.AgXToneMapping=6]="AgXToneMapping",o[o.NeutralToneMapping=7]="NeutralToneMapping",o))(tu||{});class Di extends R{constructor(){super(...arguments),this.method=7,this.exposure=1,this.state=!1}awake(){this.toggle()}update(){if(!To)return;const e=this.context.input;e.isKeyDown("f")&&this.toggle(),e.isKeyDown("g")&&(this.method=Z.clamp(--this.method,0,7),this.set(this.method,this.exposure)),e.isKeyDown("h")&&(this.method=Z.clamp(++this.method,0,7),this.set(this.method,this.exposure)),e.isKeyDown("j")&&(this.exposure=Z.clamp(this.exposure-.1,0,5),this.set(this.method,this.exposure)),e.isKeyDown("k")&&(this.exposure=Z.clamp(this.exposure+.1,0,5),this.set(this.method,this.exposure))}toggle(){this.state=!this.state,this.state?(To&&console.log(),this.prevToneMapping=this.context.renderer.toneMapping,this.prevExposure=this.context.renderer.toneMappingExposure,this.set(this.method,this.exposure)):(this.context.renderer.toneMapping=this.prevToneMapping??0,this.context.renderer.toneMappingExposure=this.prevExposure??1)}set(e,t){this.context.renderer.toneMapping=e,this.context.renderer.toneMappingExposure=t,To&&ce(`Tonemapping | Method: ${tu[this.context.renderer.toneMapping]} | Exposure: ${this.context.renderer.toneMappingExposure.toFixed(1)}`)}}eu([S()],Di.prototype,"method",2);eu([S()],Di.prototype,"exposure",2);var $v=Object.defineProperty,Uv=Object.getOwnPropertyDescriptor,Wv=(o,e,t,s)=>{for(var n=s>1?void 0:s?Uv(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&$v(e,t,n),n};class su extends R{constructor(){super(...arguments),this.renderers=[]}select(e){this.renderers.forEach(t=>{t.probeAnchor=e})}}Wv([S(ut)],su.prototype,"renderers",2);var Gv=Object.defineProperty,Hv=Object.getOwnPropertyDescriptor,kv=(o,e,t,s)=>{for(var n=s>1?void 0:s?Hv(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Gv(e,t,n),n};class Fi extends R{constructor(){super(...arguments),this.displayName=""}}kv([S()],Fi.prototype,"displayName",2);var Bv=Object.defineProperty,qv=Object.getOwnPropertyDescriptor,zi=(o,e,t,s)=>{for(var n=s>1?void 0:s?qv(e,t):e,i=o.length-1,r;i>=0;i--)(r=o[i])&&(n=(s?r(e,t,n):r(n))||n);return s&&n&&Bv(e,t,n),n};class to extends R{constructor(){super(...arguments),this.objects=[],this.hideContentOnStart=!0,this.index=-1}awake(){this.hideContentOnStart||(this.index=0),this.apply()}next(){this.index++,this.index>=this.objects.length&&(this.index=0),this.apply()}previous(){this.index--,this.index<0&&(this.index=this.objects.length-1),this.apply()}apply(){for(let e=0;e<this.objects.length;e++)this.objects[e].visible=e===this.index;if(this.lable){const e=this.objects[this.index];if(e){const t=te.getComponent(e,Fi);this.lable.text=(t==null?void 0:t.displayName)??e.name}}}select(e){this.index=e,this.index=Z.clamp(this.index,0,this.objects.length-1),this.apply()}}zi([S(St)],to.prototype,"objects",2);zi([S()],to.prototype,"hideContentOnStart",2);zi([S(Ws)],to.prototype,"lable",2);V.add("AspectRatioFitterUI",ei);V.add("CameraGoal",En);V.add("CameraLayer",Dh);V.add("Cannon",Ys);V.add("RandomColor",si);V.add("ChangeColorOnCollision",Uh);V.add("IncreaseShaderSpeedOverTime",da);V.add("ClickButton",ua);V.add("ClickToReset",ha);V.add("DebugLOD",ni);V.add("DepthOfFieldController",Vn);V.add("DisableEnvironmentLight",tp);V.add("EmitParticlesOnClick",ma);V.add("EnforceParameters",fa);V.add("HTMLButtonClick",ii);V.add("HTMLMenu",Ln);V.add("IFrameContent",Ks);V.add("ImageTrackingDownloadUI",Np);V.add("Networking_ClickToChangeColor",Co);V.add("Networking_StringArray",Mo);V.add("Networking_Object",hn);V.add("PerformanceSettings",ri);V.add("PhysicsCollision",Zs);V.add("PhysicsTrigger",Qs);V.add("PlayAnimationOnCollision",va);V.add("PlayAnimationOnTrigger",wa);V.add("PlayAudioOnCollision",Ta);V.add("ResetAnimationsForXR",Dp);V.add("ResponsiveContent",ai);V.add("LoadingSceneRoot",_a);V.add("SceneLoadingEvents",li);V.add("SceneSwitcherControls",Up);V.add("ShowBalloonMessage",Sa);V.add("SimpleLeaderboard",Oo);V.add("StartPosition",Ca);V.add("AutoReset",Ma);V.add("SyncedRoomUI",Oa);V.add("TimedSpawn",Ea);V.add("VideoBackground",om);V.add("ResetPositionOnInterval",Xs);V.add("ToggleVisibility",am);V.add("WireframeMaterial",Aa);V.add("XRLifecycleEvents",di);V.add("WebXRBodyTracking",pm);V.add("Arrow",ui);V.add("ArrowShooting",Le);V.add("BowArrowTarget",Pa);V.add("BowTargetSpawner",Ra);V.add("DeviceDetection",Om);V.add("ButtonAndTextFiller",Js);V.add("GalleryUIItem",fs);V.add("GalleryUICategory",Kt);V.add("GalleryUI",Dn);V.add("MaterialXAsset",Ii);V.add("ShadeWithMaterialX",Fv);V.add("ThreeTonemapping",Di);V.add("ReflectionsSwitcher",su);V.add("VariantInfo",Fi);V.add("VariantSwitcher",to);
